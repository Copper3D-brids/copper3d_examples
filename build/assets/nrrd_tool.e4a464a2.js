var O=Object.defineProperty;var W=(v,t,i)=>t in v?O(v,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):v[t]=i;var s=(v,t,i)=>(W(v,typeof t!="symbol"?t+"":t,i),i);import{E as A,V as E}from"./index.4ecf1bb4.js";class T{constructor(t){s(this,"volume");s(this,"paintImages",{x:[],y:[],z:[]});s(this,"container");s(this,"drawingCanvasContainer",document.createElement("div"));s(this,"mainDisplayArea",document.createElement("div"));s(this,"contrast1Area",document.createElement("div"));s(this,"contrast2Area",document.createElement("div"));s(this,"contrast3Area",document.createElement("div"));s(this,"contrast4Area",document.createElement("div"));s(this,"start",()=>{});s(this,"slice");s(this,"oldIndex",0);s(this,"maxIndex",0);s(this,"minIndex",0);s(this,"contrastNum",0);s(this,"sliceModifyNum",0);s(this,"contrastModifyNum",0);s(this,"contrast1Slice");s(this,"contrast2Slice");s(this,"contrast3Slice");s(this,"contrast4Slice");s(this,"contrastShowInMain",!1);s(this,"axis","z");s(this,"originWidth",0);s(this,"originHeight",0);s(this,"changedWidth",0);s(this,"changedHeight",0);s(this,"contrastWidth",200);s(this,"contrastHeight",200);s(this,"Is_Shift_Pressed",!1);s(this,"Is_Draw",!1);s(this,"showDragNumberDiv",document.createElement("div"));s(this,"drawingCanvas",document.createElement("canvas"));s(this,"displayCanvas",document.createElement("canvas"));s(this,"displayContrast1Canvas",document.createElement("canvas"));s(this,"displayContrast2Canvas",document.createElement("canvas"));s(this,"displayContrast3Canvas",document.createElement("canvas"));s(this,"displayContrast4Canvas",document.createElement("canvas"));s(this,"drawingCanvasLayer1",document.createElement("canvas"));s(this,"originCanvas");s(this,"contrast1OriginCanvas");s(this,"contrast2OriginCanvas");s(this,"contrast3OriginCanvas");s(this,"contrast4OriginCanvas");s(this,"displayCtx");s(this,"drawingCtx");s(this,"drawingLayer1Ctx");s(this,"displayContrast1Ctx");s(this,"displayContrast2Ctx");s(this,"displayContrast3Ctx");s(this,"displayContrast4Ctx");s(this,"downloadImage",document.createElement("a"));s(this,"previousDrawingImage",new Image);s(this,"paintedImage");s(this,"readyToUpdate",!0);s(this,"addContrastArea",!1);s(this,"undoArray",[]);s(this,"stateMode",{size:1,globalAlpha:.3,lineWidth:2,color:"#f50a86",segmentation:!1,fillColor:"#1e809c",brushColor:"#1e809c",brushLineWidth:15,Eraser:!1,EraserSize:25,clearAll:()=>{this.clearAllPaint()},undo:()=>{this.undoLastPainting()},downloadCurrentImage:()=>{this.enableDownload()}});this.container=t,this.container.appendChild(this.mainDisplayArea),this.displayCtx=this.displayCanvas.getContext("2d"),this.displayContrast1Ctx=this.displayContrast1Canvas.getContext("2d"),this.displayContrast2Ctx=this.displayContrast2Canvas.getContext("2d"),this.displayContrast3Ctx=this.displayContrast3Canvas.getContext("2d"),this.displayContrast4Ctx=this.displayContrast4Canvas.getContext("2d"),this.drawingCtx=this.drawingCanvas.getContext("2d"),this.drawingLayer1Ctx=this.drawingCanvasLayer1.getContext("2d"),this.init()}init(){this.showDragNumberDiv=this.createShowSliceNumberDiv(),this.mainDisplayArea.classList.add("copper3D_display_area"),this.contrast1Area.classList.add("copper3D_display_area"),this.contrast2Area.classList.add("copper3D_display_area"),this.contrast3Area.classList.add("copper3D_display_area"),this.contrast4Area.classList.add("copper3D_display_area"),this.mainDisplayArea.classList.add("copper3D_mainDisplay"),this.contrast1Area.classList.add("copper3D_contrast1"),this.contrast2Area.classList.add("copper3D_contrast2"),this.contrast3Area.classList.add("copper3D_contrast3"),this.contrast4Area.classList.add("copper3D_contrast4"),this.displayContrast1Canvas.style.position="absolute",this.displayContrast2Canvas.style.position="absolute",this.displayContrast3Canvas.style.position="absolute",this.displayContrast4Canvas.style.position="absolute",this.mainDisplayArea.appendChild(this.drawingCanvasContainer);const t=this.createDescription("1st"),i=this.createDescription("2nd"),a=this.createDescription("3rd"),e=this.createDescription("4th");this.contrast1Area.appendChild(t),this.contrast2Area.appendChild(i),this.contrast3Area.appendChild(a),this.contrast4Area.appendChild(e),this.downloadImage.href="",this.downloadImage.target="_blank",this.drawingCanvasContainer.className="copper3D_drawingCanvasContainer"}afterLoadSlice(){switch(this.axis=this.slice.axis,this.originCanvas=this.slice.canvas,this.undoArray=[{sliceIndex:this.slice.index,contrastNum:this.contrastNum,undos:[]}],this.oldIndex=this.slice.index,this.axis){case"x":this.maxIndex=this.slice.volume.RASDimensions[0];break;case"y":this.maxIndex=this.slice.volume.RASDimensions[1];break;case"z":this.maxIndex=this.slice.volume.RASDimensions[2]-1;break}this.contrastShowInMain?this.showDragNumberDiv.innerHTML=`ContrastNum: ${this.contrastNum}/${4} SliceNum: ${0}/${this.maxIndex}`:this.showDragNumberDiv.innerHTML=`SliceNum: ${0}/${this.maxIndex}`}setVolume(t){this.volume=t,this.afterLoadSlice()}setSlice(t){this.slice=t,this.afterLoadSlice()}setVolumeAndSlice(t,i){this.volume=t,this.slice=i,this.afterLoadSlice()}setSyncsliceNum(){this.contrast1Slice.index=this.slice.index,this.contrast2Slice.index=this.slice.index,this.contrast3Slice.index=this.slice.index,this.contrast4Slice.index=this.slice.index}setContrastDisplayInMainArea(){this.contrastShowInMain=!0,this.addContrastArea=!0}getMaxSliceNum(){return this.contrastShowInMain?this.maxIndex*5:this.maxIndex}addContrastDisplay(){this.container.appendChild(this.contrast1Area),this.container.appendChild(this.contrast2Area),this.container.appendChild(this.contrast3Area),this.container.appendChild(this.contrast4Area),this.addContrastArea=!0}initDiplayContrastCanvas(t,i,a){t.width=this.contrastWidth,t.height=this.contrastHeight,i.drawImage(a,0,0,this.contrastWidth,this.contrastHeight)}setIsDrawFalse(t){setTimeout(()=>{this.Is_Draw=!1},t)}createDescription(t){const i=document.createElement("p");return i.innerText=t,i.style.position="absolute",i.style.bottom="5px",i}setContrastSize(t,i){this.contrastWidth=t,this.contrastHeight=i}setContrast1OriginCanvas(t){this.contrast1Slice=t,this.contrast1OriginCanvas=this.contrast1Slice.canvas,this.initDiplayContrastCanvas(this.displayContrast1Canvas,this.displayContrast1Ctx,this.contrast1OriginCanvas),this.contrast1Area.appendChild(this.displayContrast1Canvas)}setContrast2OriginCanvas(t){this.contrast2Slice=t,this.contrast2OriginCanvas=this.contrast2Slice.canvas,this.initDiplayContrastCanvas(this.displayContrast2Canvas,this.displayContrast2Ctx,this.contrast2OriginCanvas),this.contrast2Area.appendChild(this.displayContrast2Canvas)}setContrast3OriginCanvas(t){this.contrast3Slice=t,this.contrast3OriginCanvas=this.contrast3Slice.canvas,this.initDiplayContrastCanvas(this.displayContrast3Canvas,this.displayContrast3Ctx,this.contrast3OriginCanvas),this.contrast3Area.appendChild(this.displayContrast3Canvas)}setContrast4OriginCanvas(t){this.contrast4Slice=t,this.contrast4OriginCanvas=this.contrast4Slice.canvas,this.initDiplayContrastCanvas(this.displayContrast4Canvas,this.displayContrast4Ctx,this.contrast4OriginCanvas),this.contrast4Area.appendChild(this.displayContrast4Canvas)}dragImageWithMode(t,i){let a,e,r=this.container.offsetHeight,d,l,C;this.originWidth=this.slice.canvas.width,this.originHeight=this.slice.canvas.height,this.container.tabIndex=1,i!=null&&i.showNumber&&this.container.appendChild(this.showDragNumberDiv),this.container.addEventListener("keydown",h=>{h.key==="Shift"&&(t.enabled=!1,this.container.style.cursor="pointer",this.Is_Shift_Pressed=!0,this.Is_Draw=!0,this.container.addEventListener("mousedown",l,!1),this.container.addEventListener("mouseup",d,!1))}),this.container.addEventListener("keyup",h=>{h.key==="Shift"&&(t.enabled=!0,this.container.style.cursor="",this.Is_Shift_Pressed=!1,this.container.removeEventListener("mousedown",l,!1),this.container.removeEventListener("mouseup",d,!1),this.container.removeEventListener("mousemove",C,!1),this.setIsDrawFalse(1e3))}),(i==null?void 0:i.mode)==="mode0"?(l=h=>{e=h.offsetY/r},d=h=>{e-h.offsetY/r>=0?a=Math.ceil((e-h.offsetY/r)*20):a=Math.floor((e-h.offsetY/r)*20);let o=this.slice.index+a;o>this.maxIndex?o=this.maxIndex:o<this.minIndex?o=this.minIndex:(this.slice.index=o,this.slice.repaint.call(this.slice)),i!=null&&i.showNumber&&(this.showDragNumberDiv.innerHTML=`Slice number: ${o}/${this.maxIndex}`)}):(l=h=>{e=h.offsetY/r,this.container.addEventListener("mousemove",C,!1),this.oldIndex=this.slice.index},C=A(h=>{this.Is_Draw=!0,e-h.offsetY/r>=0?a=-Math.ceil((e-h.offsetY/r)*20):a=-Math.floor((e-h.offsetY/r)*20),this.updateIndex(a)},100),d=h=>{this.container.removeEventListener("mousemove",C,!1)})}setSliceMoving(t){this.Is_Draw=!0,this.setSyncsliceNum(),this.updateIndex(t),this.setIsDrawFalse(1e3)}updateIndex(t){var r;let i=0,a=0;this.contrastShowInMain?(a=t%5,this.contrastNum+=a,t>0?(i=Math.floor(t/5),this.contrastNum>4&&(i+=1,this.contrastNum-=5)):(i=Math.ceil(t/5),this.contrastNum<0&&(this.contrastNum+=5,i-=1))):i=t;let e=this.oldIndex+i;if(e!=this.oldIndex||this.contrastShowInMain){if(e>this.maxIndex)e=this.maxIndex,this.contrastNum=4;else if(e<this.minIndex)e=this.minIndex,this.contrastNum=0;else{if(this.slice.index=e,this.slice.repaint.call(this.slice),this.addContrastArea&&this.updateContrastArea(),this.drawingCanvasLayer1.width=this.drawingCanvasLayer1.width,this.displayCanvas.width=this.displayCanvas.width,this.changedWidth===0&&(this.changedWidth=this.originWidth,this.changedHeight=this.originHeight),this.contrastShowInMain)switch(this.repraintCurrentContrastSlice(),this.contrastNum){case 0:this.displayCtx.drawImage(this.slice.canvas,0,0,this.changedWidth,this.changedHeight);break;case 1:this.displayCtx.drawImage(this.contrast1OriginCanvas,0,0,this.changedWidth,this.changedHeight);break;case 2:this.displayCtx.drawImage(this.contrast2OriginCanvas,0,0,this.changedWidth,this.changedHeight);break;case 3:this.displayCtx.drawImage(this.contrast3OriginCanvas,0,0,this.changedWidth,this.changedHeight);break;case 4:this.displayCtx.drawImage(this.contrast4OriginCanvas,0,0,this.changedWidth,this.changedHeight);break}else this.displayCtx.drawImage(this.slice.canvas,0,0,this.changedWidth,this.changedHeight);(this.paintImages.x.length>0||this.paintImages.y.length>0||this.paintImages.z.length>0)&&(this.paintedImage=this.filterDrawedImage(this.axis,this.contrastNum,this.slice.index),(r=this.paintedImage)!=null&&r.image&&this.drawingLayer1Ctx.drawImage(this.paintedImage.image,0,0,this.changedWidth,this.changedHeight))}this.oldIndex=this.slice.index,this.updateShowNumDiv(this.contrastNum,e)}}updateShowNumDiv(t,i){this.contrastShowInMain?this.showDragNumberDiv.innerHTML=`ContrastNum: ${t}/${4} SliceNum: ${this.slice.index}/${this.maxIndex}`:this.showDragNumberDiv.innerHTML=`SliceNum: ${this.slice.index}/${this.maxIndex}`}draw(t,i,a){let e,r;const d={subView:!0,scale:1,resetView:function(){i.resetView()}};a.add(d,"resetView"),e=a.addFolder("Mode Parameters"),r=a.addFolder("Sub View"),r.add(d,"subView").onChange(l=>{l?(t.enabled=!0,i.subDiv&&(i.subDiv.style.display="block")):(i.subDiv&&(i.subDiv.style.display="none"),t.enabled=!1)}),r.add(d,"scale").min(.25).max(2).step(.01).onFinishChange(l=>{i.subDiv&&(i.subDiv.style.width=200*l+"px"),i.subDiv&&(i.subDiv.style.height=200*l+"px")}),this.paintOnCanvas(t,e)}paintOnCanvas(t,i){var L;let a=!1,e=!1,r=0,d=0,l=this.slice.index,C=new E(1,1),h=!1,o=[];this.originWidth=this.originCanvas.width,this.originHeight=this.originCanvas.height,this.changedWidth=this.originCanvas.width*Number(this.stateMode.size),this.changedHeight=this.originCanvas.height*Number(this.stateMode.size),this.configAllCanvas(),this.configGui(i),(L=this.displayCtx)==null||L.drawImage(this.originCanvas,0,0,this.changedWidth,this.changedHeight),this.previousDrawingImage.src=this.drawingCanvas.toDataURL(),this.drawingCanvas.oncontextmenu=()=>!1;const f=this.configMouseWheel(t),I=A(n=>{this.drawingCanvas.style.cursor="grabbing",this.displayCanvas.style.left=this.drawingCanvas.style.left=n.clientX-r+"px",this.displayCanvas.style.top=this.drawingCanvas.style.top=n.clientY-d+"px"},80);this.drawingCanvas.addEventListener("pointerdown",n=>{if(a||e||this.Is_Shift_Pressed){this.drawingCanvas.removeEventListener("pointerup",x),this.drawingLayer1Ctx.closePath();return}if(l!==this.slice.index&&(this.previousDrawingImage.src="",l=this.slice.index),this.drawingCanvas.removeEventListener("wheel",f),t.enabled=!1,n.button===0)a=!0,o=[],h=!0,this.Is_Draw=!0,this.stateMode.Eraser?this.drawingCanvas.style.cursor="url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/4273/circular-cursor.png) 52 52, crosshair":this.drawingCanvas.style.cursor="crosshair",C.set(n.offsetX,n.offsetY),this.drawingLayer1Ctx.beginPath(),this.drawingCanvas.addEventListener("pointerup",x),this.drawingCanvas.addEventListener("pointermove",S);else if(n.button===2){let c=parseInt(this.drawingCanvas.style.left),g=parseInt(this.drawingCanvas.style.top);r=n.clientX-c,d=n.clientY-g,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.addEventListener("pointerup",x),this.drawingCanvas.addEventListener("pointermove",I)}else return},!0);var y=1;const D=(n,c,g)=>{var w=g-y,m=Math.sqrt(g*g-w*w),p=n-w,u=c-m,M=2*w,N=2*m;y<=g&&(this.drawingLayer1Ctx.clearRect(p,u,M,N),y+=1,D(n,c,g))},b=(n,c)=>{this.drawingLayer1Ctx.beginPath(),this.drawingLayer1Ctx.moveTo(C.x,C.y),this.stateMode.segmentation?(this.drawingLayer1Ctx.strokeStyle=this.stateMode.color,this.drawingLayer1Ctx.lineWidth=this.stateMode.lineWidth):(this.drawingLayer1Ctx.strokeStyle=this.stateMode.brushColor,this.drawingLayer1Ctx.lineWidth=this.stateMode.brushLineWidth),this.drawingLayer1Ctx.lineTo(n,c),this.drawingLayer1Ctx.stroke(),C.set(n,c),this.drawingLayer1Ctx.closePath(),this.slice.mesh.material.map.needsUpdate=!0},S=n=>{this.Is_Draw=!0,h&&(this.stateMode.Eraser?(y=1,D(n.offsetX,n.offsetY,this.stateMode.EraserSize)):(o.push({x:n.offsetX,y:n.offsetY}),b(n.offsetX,n.offsetY)))},x=n=>{var c;if(!this.Is_Shift_Pressed){if(n.button===0){if(a=!1,this.drawingLayer1Ctx.closePath(),this.drawingCanvas.removeEventListener("pointermove",S),!this.stateMode.Eraser&&this.stateMode.segmentation){this.drawingCanvasLayer1.width=this.drawingCanvasLayer1.width;const p=(c=this.filterDrawedImage(this.axis,this.contrastNum,this.slice.index))==null?void 0:c.image;p&&(this.previousDrawingImage=p),this.drawingLayer1Ctx.drawImage(this.previousDrawingImage,0,0,this.changedWidth,this.changedHeight),this.drawingLayer1Ctx.beginPath(),this.drawingLayer1Ctx.moveTo(o[0].x,o[0].y);for(let u=1;u<o.length;u++)this.drawingLayer1Ctx.lineTo(o[u].x,o[u].y);this.drawingLayer1Ctx.closePath(),this.drawingLayer1Ctx.lineWidth=1,this.drawingLayer1Ctx.fillStyle=this.stateMode.fillColor,this.drawingLayer1Ctx.fill()}this.previousDrawingImage.src=this.drawingCanvasLayer1.toDataURL(),this.storeAllImages(),console.log(this.drawingCtx.getImageData(0,0,this.drawingCanvas.width,this.drawingCanvas.height)),h=!1;const g=this.getCurrentUndo(),w=this.drawingCanvasLayer1.toDataURL(),m=new Image;if(m.src=w,g.length>0)g[0].undos.push(m);else{const p={sliceIndex:this.slice.index,contrastNum:this.contrastNum,undos:[]};p.undos.push(m),this.undoArray.push(p)}}else if(n.button===2)e=!1,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.removeEventListener("pointermove",I);else return;this.drawingCanvas.addEventListener("wheel",f,{passive:!1})}};this.drawingCanvas.addEventListener("pointerleave",()=>{h=!1,t.enabled=!0,this.setIsDrawFalse(3e3)}),this.start=()=>{this.readyToUpdate?this.Is_Draw&&(this.drawingCtx.clearRect(0,0,this.changedWidth,this.changedHeight),this.drawingLayer1Ctx.lineCap="round",this.drawingLayer1Ctx.globalAlpha=1,this.drawingCtx.globalAlpha=this.stateMode.globalAlpha,this.drawingCtx.drawImage(this.drawingCanvasLayer1,0,0),this.redrawOriginCanvas()):(this.originCanvas.width=this.originCanvas.width,this.slice.repaint.call(this.slice),this.redrawDisplayCanvas(),this.addContrastArea&&this.updateContrastArea())},document.addEventListener("keydown",n=>{(n.ctrlKey||n.metaKey)&&n.code==="KeyZ"&&this.undoLastPainting()})}redrawOriginCanvas(){var t,i,a,e,r;this.slice.mesh.material.map.needsUpdate=!0,this.originCanvas.width=this.originCanvas.width,this.slice.repaint.call(this.slice),(t=this.originCanvas.getContext("2d"))==null||t.drawImage(this.drawingCanvas,0,0,this.originCanvas.width,this.originCanvas.height),this.contrast1OriginCanvas&&this.contrast2OriginCanvas&&this.contrast3OriginCanvas&&this.contrast4OriginCanvas&&(this.contrast1OriginCanvas.width=this.contrast1OriginCanvas.width,this.contrast2OriginCanvas.width=this.contrast2OriginCanvas.width,this.contrast3OriginCanvas.width=this.contrast3OriginCanvas.width,this.contrast4OriginCanvas.width=this.contrast4OriginCanvas.width,this.repraintCurrentContrastSlice(),this.Is_Shift_Pressed&&(this.setSyncsliceNum(),this.repraintCurrentContrastSlice()),(i=this.contrast1OriginCanvas.getContext("2d"))==null||i.drawImage(this.drawingCanvas,0,0,this.contrast1OriginCanvas.width,this.contrast1OriginCanvas.height),(a=this.contrast2OriginCanvas.getContext("2d"))==null||a.drawImage(this.drawingCanvas,0,0,this.contrast2OriginCanvas.width,this.contrast2OriginCanvas.height),(e=this.contrast3OriginCanvas.getContext("2d"))==null||e.drawImage(this.drawingCanvas,0,0,this.contrast3OriginCanvas.width,this.contrast3OriginCanvas.height),(r=this.contrast4OriginCanvas.getContext("2d"))==null||r.drawImage(this.drawingCanvas,0,0,this.contrast4OriginCanvas.width,this.contrast4OriginCanvas.height),this.updateContrastArea())}updateContrastArea(){this.displayContrast1Canvas.width=this.displayContrast1Canvas.width,this.displayContrast2Canvas.width=this.displayContrast2Canvas.width,this.displayContrast3Canvas.width=this.displayContrast3Canvas.width,this.displayContrast4Canvas.width=this.displayContrast4Canvas.width,this.initDiplayContrastCanvas(this.displayContrast1Canvas,this.displayContrast1Ctx,this.contrast1OriginCanvas),this.initDiplayContrastCanvas(this.displayContrast2Canvas,this.displayContrast2Ctx,this.contrast2OriginCanvas),this.initDiplayContrastCanvas(this.displayContrast3Canvas,this.displayContrast3Ctx,this.contrast3OriginCanvas),this.initDiplayContrastCanvas(this.displayContrast4Canvas,this.displayContrast4Ctx,this.contrast4OriginCanvas)}updateContrastAreaValue(t,i){switch(i){case"lowerThreshold":this.contrast1Slice.volume.lowerThreshold=t,this.contrast2Slice.volume.lowerThreshold=t,this.contrast3Slice.volume.lowerThreshold=t,this.contrast4Slice.volume.lowerThreshold=t;break;case"upperThreshold":this.contrast1Slice.volume.upperThreshold=t,this.contrast2Slice.volume.upperThreshold=t,this.contrast3Slice.volume.upperThreshold=t,this.contrast4Slice.volume.upperThreshold=t;break;case"windowLow":this.contrast1Slice.volume.windowLow=t,this.contrast2Slice.volume.windowLow=t,this.contrast3Slice.volume.windowLow=t,this.contrast4Slice.volume.windowLow=t;break;case"windowHigh":this.contrast1Slice.volume.windowHigh=t,this.contrast2Slice.volume.windowHigh=t,this.contrast3Slice.volume.windowHigh=t,this.contrast4Slice.volume.windowHigh=t;break}this.repraintCurrentContrastSlice()}repraintCurrentContrastSlice(){this.contrast1Slice.repaint.call(this.contrast1Slice),this.contrast2Slice.repaint.call(this.contrast2Slice),this.contrast3Slice.repaint.call(this.contrast3Slice),this.contrast4Slice.repaint.call(this.contrast4Slice)}repraintAllContrastSlice(){this.contrast1Slice.volume.repaintAllSlices(),this.contrast2Slice.volume.repaintAllSlices(),this.contrast3Slice.volume.repaintAllSlices(),this.contrast4Slice.volume.repaintAllSlices()}configAllCanvas(){this.displayCanvas.style.position="absolute",this.displayCanvas.style.zIndex="9",this.displayCanvas.width=this.changedWidth,this.displayCanvas.height=this.changedHeight,this.drawingCanvas.style.zIndex="10",this.drawingCanvas.style.position="absolute",this.drawingCanvas.width=this.changedWidth,this.drawingCanvas.height=this.changedHeight,this.drawingCanvas.style.cursor="crosshair",this.displayCanvas.style.left=this.drawingCanvas.style.left="0px",this.displayCanvas.style.top=this.drawingCanvas.style.top="0px",this.drawingCanvasLayer1.width=this.changedWidth,this.drawingCanvasLayer1.height=this.changedHeight,this.drawingCanvasContainer.style.width=this.changedWidth+"px",this.drawingCanvasContainer.style.height=this.changedHeight+"px",this.drawingCanvasContainer.appendChild(this.displayCanvas),this.drawingCanvasContainer.appendChild(this.drawingCanvas)}createShowSliceNumberDiv(){const t=document.createElement("div");return t.className="copper3d_sliceNumber",t.style.position="absolute",t.style.zIndex="100",t.style.top="20px",t.style.left="100px",t}filterDrawedImage(t,i,a){return this.paintImages[t].filter(e=>e.index===a&&e.contrastNum===i)[0]}removeModeChilden(t){const i=t.__controllers;i.length>0&&i.forEach(a=>{setTimeout(()=>{t.remove(a)},100)})}clearAllPaint(){this.Is_Draw=!0,this.drawingCanvasLayer1.width=this.drawingCanvas.width,this.originCanvas.width=this.originCanvas.width,this.slice.repaint.call(this.slice),this.previousDrawingImage.src="",this.storeAllImages(),this.setIsDrawFalse(1e3)}enableDownload(){this.downloadImage.download=`slice_${this.axis}_#${this.slice.index}`,this.downloadImage.href=this.originCanvas.toDataURL(),this.downloadImage.click()}redrawDisplayCanvas(){var t;this.displayCanvas.width=this.displayCanvas.width,this.displayCanvas.height=this.displayCanvas.height,(t=this.displayCtx)==null||t.drawImage(this.originCanvas,0,0,this.changedWidth,this.changedHeight)}undoLastPainting(){this.Is_Draw=!0,this.drawingCanvasLayer1.width=this.drawingCanvasLayer1.width,this.slice.repaint.call(this.slice);const t=this.getCurrentUndo();if(t.length>0){const i=t[0];if(i.undos.length===0)return;if(i.undos.pop(),i.undos.length>0){const a=i.undos[i.undos.length-1];this.drawingLayer1Ctx.drawImage(a,0,0,this.changedWidth,this.changedHeight)}this.previousDrawingImage.src=this.drawingCanvasLayer1.toDataURL(),this.storeAllImages(),this.setIsDrawFalse(1e3)}}getCurrentUndo(){return this.undoArray.filter(t=>t.sliceIndex===this.slice.index&&t.contrastNum===this.contrastNum)}configGui(t){t.__controllers.length>0&&this.removeModeChilden(t),t.add(this.stateMode,"size").min(1).max(8).onFinishChange(a=>{this.resetPaintArea(),this.resizePaintArea(a)}),t.add(this.stateMode,"globalAlpha").min(.1).max(1).step(.01),t.add(this.stateMode,"segmentation"),t.addColor(this.stateMode,"color"),t.addColor(this.stateMode,"fillColor"),t.add(this.stateMode,"lineWidth").min(1.7).max(3).step(.01),t.add(this.stateMode,"brushLineWidth").min(5).max(50).step(1),t.addColor(this.stateMode,"brushColor"),t.add(this.stateMode,"EraserSize").min(1).max(50).step(1),t.add(this.stateMode,"Eraser").onChange(a=>{this.stateMode.Eraser=a,this.stateMode.Eraser?this.drawingCanvas.style.cursor="url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/4273/circular-cursor.png) 52 52, crosshair":this.drawingCanvas.style.cursor="crosshair"}),t.add(this.stateMode,"clearAll"),t.add(this.stateMode,"undo"),t.add(this.stateMode,"downloadCurrentImage");const i=t.addFolder("contrast");i.open(),i.add(this.slice.volume,"lowerThreshold",this.slice.volume.min,this.slice.volume.max,1).name("Lower Threshold").onChange(a=>{this.readyToUpdate=!1,this.addContrastArea&&this.updateContrastAreaValue(a,"lowerThreshold")}).onFinishChange(()=>{this.slice.volume.repaintAllSlices(),this.addContrastArea&&this.repraintAllContrastSlice(),this.readyToUpdate=!0}),i.add(this.slice.volume,"upperThreshold",this.slice.volume.min,this.slice.volume.max,1).name("Upper Threshold").onChange(a=>{this.readyToUpdate=!1,this.addContrastArea&&this.updateContrastAreaValue(a,"upperThreshold")}).onFinishChange(()=>{this.slice.volume.repaintAllSlices(),this.addContrastArea&&this.repraintAllContrastSlice(),this.readyToUpdate=!0}),i.add(this.slice.volume,"windowLow",this.slice.volume.min,this.slice.volume.max,1).name("Window Low").onChange(a=>{this.readyToUpdate=!1,this.addContrastArea&&this.updateContrastAreaValue(a,"windowLow")}).onFinishChange(()=>{this.slice.volume.repaintAllSlices(),this.addContrastArea&&this.repraintAllContrastSlice(),this.readyToUpdate=!0}),i.add(this.slice.volume,"windowHigh",this.slice.volume.min,this.slice.volume.max,1).name("Window High").onChange(a=>{this.readyToUpdate=!1,this.addContrastArea&&this.updateContrastAreaValue(a,"windowHigh")}).onFinishChange(()=>{this.slice.volume.repaintAllSlices(),this.addContrastArea&&this.repraintAllContrastSlice(),this.readyToUpdate=!0})}configMouseWheel(t){let i=1;const a=e=>{this.Is_Shift_Pressed||(e.preventDefault(),this.Is_Draw=!0,e.deltaY<0?i+=.1:e.deltaY>0&&(i-=.1),i>=8?i=8:i<=1&&(i=1),this.resizePaintArea(i),this.resetPaintArea(),t.enabled=!1)};return this.drawingCanvas.addEventListener("wheel",a,{passive:!1}),a}resetPaintArea(){this.displayCanvas.style.left=this.drawingCanvas.style.left="0px",this.displayCanvas.style.top=this.drawingCanvas.style.top="0px"}resizePaintArea(t){var i,a,e,r;this.originCanvas.width=this.originCanvas.width,this.displayCanvas.width=this.displayCanvas.width,this.drawingCanvas.width=this.drawingCanvas.width,this.drawingCanvasLayer1.width=this.drawingCanvasLayer1.width,this.changedWidth=this.originWidth*t,this.changedHeight=this.originHeight*t,this.displayCanvas.width=this.changedWidth,this.displayCanvas.height=this.changedHeight,this.drawingCanvas.width=this.changedWidth,this.drawingCanvas.height=this.changedHeight,this.drawingCanvasLayer1.width=this.changedWidth,this.drawingCanvasLayer1.height=this.changedHeight,this.drawingCanvasContainer.style.width=this.changedWidth+"px",this.drawingCanvasContainer.style.height=this.changedHeight+"px",this.slice.repaint.call(this.slice),(i=this.displayCtx)==null||i.drawImage(this.originCanvas,0,0,this.changedWidth,this.changedHeight),(a=this.paintedImage)!=null&&a.image||(this.paintImages.x.length>0?this.paintedImage=this.filterDrawedImage("x",this.contrastNum,this.slice.index):this.paintImages.y.length>0?this.paintedImage=this.filterDrawedImage("y",this.contrastNum,this.slice.index):this.paintImages.z.length>0&&(this.paintedImage=this.filterDrawedImage("z",this.contrastNum,this.slice.index))),(e=this.paintedImage)!=null&&e.image&&((r=this.drawingLayer1Ctx)==null||r.drawImage(this.paintedImage.image,0,0,this.changedWidth,this.changedHeight))}storeAllImages(){var e,r,d;const t=new Image;t.src=this.drawingCanvasLayer1.toDataURL();let i={index:this.slice.index,contrastNum:this.contrastNum,image:t},a;switch(this.axis){case"x":a=this.filterDrawedImage("x",this.contrastNum,this.slice.index),a?a.image=t:(e=this.paintImages.x)==null||e.push(i);break;case"y":a=this.filterDrawedImage("y",this.contrastNum,this.slice.index),a?a.image=t:(r=this.paintImages.y)==null||r.push(i);break;case"z":a=this.filterDrawedImage("z",this.contrastNum,this.slice.index),a?a.image=t:(d=this.paintImages.z)==null||d.push(i);break}}}export{T as n};
