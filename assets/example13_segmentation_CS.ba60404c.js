var st=Object.defineProperty;var it=(f,t,e)=>t in f?st(f,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):f[t]=e;var c=(f,t,e)=>(it(f,typeof t!="symbol"?t+"":t,e),e);import{b as at,F as rt,V as nt,t as $,G as dt,c as ht,l as ot,f as lt,s as ct}from"./index.d8e00b30.js";import{d as X,j as gt,t as ut,r as P,w as U,c as V,a as C,k as M,l as A,m as T,o as B,p as j,b as G,_ as J,n as R,q as _t,s as mt,v as pt,e as vt,g as xt}from"./index.69879bf3.js";import"./___vite-browser-external_commonjs-proxy.edf47d79.js";function Y(f,t){if(at)rt.exports.saveAs(f,t);else{var e=require("file-saver");e.saveAs(f,t)}}class ft{constructor(t){c(this,"container");c(this,"paintImages",{x:[],y:[],z:[]});c(this,"allSlicesArray",[]);c(this,"displaySlices",[]);c(this,"backUpDisplaySlices",[]);c(this,"skipSlicesDic",{});c(this,"axis","z");c(this,"mainAreaContainer",document.createElement("div"));c(this,"showDragNumberDiv",document.createElement("div"));c(this,"drawingCanvas",document.createElement("canvas"));c(this,"displayCanvas",document.createElement("canvas"));c(this,"downloadCanvas",document.createElement("canvas"));c(this,"emptyCanvas",document.createElement("canvas"));c(this,"downloadImage",document.createElement("a"));c(this,"drawingCanvasLayerOne",document.createElement("canvas"));c(this,"currentShowingSlice");c(this,"displayCtx");c(this,"drawingCtx");c(this,"emptyCtx");c(this,"drawingLayerOneCtx");c(this,"originCanvas");c(this,"mainPreSlice");c(this,"sceneIn");c(this,"Is_Shift_Pressed",!1);c(this,"Is_Draw",!1);c(this,"sensitiveArray",[]);c(this,"handleWheelMove",()=>{});c(this,"start",()=>{});c(this,"paintedImage");c(this,"previousDrawingImage");c(this,"undoArray",[]);c(this,"initState",!0);c(this,"preTimer");c(this,"nrrd_states",{originWidth:0,originHeight:0,nrrd_x:0,nrrd_y:0,nrrd_z:0,changedWidth:0,changedHeight:0,oldIndex:0,currentIndex:0,maxIndex:0,minIndex:0,RSARatio:0,RSARatioArray:[],dimensions:[],ratios:{x:1,y:1,z:1},sharedPlace:{x:[-1],y:[-1],z:[-1]},latestNotEmptyImg:new Image,contrastNum:0,Max_sensitive:100,readyToUpdate:!0,showContrast:!1,enableCursorChoose:!1,isCursorSelect:!1,cursorPageX:0,cursorPageY:0,Mouse_Over_x:0,Mouse_Over_y:0,Mouse_Over:!1,stepClear:1,sizeFoctor:1,defaultPaintCursor:"url(https://raw.githubusercontent.com/LinkunGao/copper3d-datasets/main/icons/dot.svg) 12 12,auto",drawStartPos:new nt(1,1)});c(this,"cursorPage",{x:{cursorPageX:0,cursorPageY:0,index:0,updated:!1},y:{cursorPageX:0,cursorPageY:0,index:0,updated:!1},z:{cursorPageX:0,cursorPageY:0,index:0,updated:!1}});c(this,"gui_states",{mainAreaSize:1,dragSensitivity:75,Eraser:!1,globalAlpha:.7,lineWidth:2,color:"#f50a33",segmentation:!0,fillColor:"#3fac58",brushColor:"#3fac58",brushAndEraserSize:15,cursor:"dot",clear:()=>{this.clearPaint()},clearAll:()=>{confirm("Are you sure remove annotations on All slice?")===!0&&(this.clearPaint(),this.clearStoreImages())},undo:()=>{this.undoLastPainting()},downloadCurrentMask:()=>{this.enableDownload()},resetZoom:()=>{this.nrrd_states.sizeFoctor=1,this.resizePaintArea(1),this.resetPaintArea()},subView:!1,subViewScale:1,resetView:()=>{var t;(t=this.sceneIn)==null||t.resetView()},exportMarks:()=>{this.exportData()}});c(this,"drawLine",(t,e,s,i)=>{this.drawingCtx.beginPath(),this.drawingCtx.moveTo(t,e),this.drawingCtx.lineTo(s,i),this.drawingCtx.strokeStyle=this.gui_states.color,this.drawingCtx.stroke()});this.container=t,this.displayCtx=this.displayCanvas.getContext("2d"),this.drawingCtx=this.drawingCanvas.getContext("2d"),this.emptyCtx=this.emptyCanvas.getContext("2d"),this.drawingLayerOneCtx=this.drawingCanvasLayerOne.getContext("2d"),this.previousDrawingImage=this.emptyCtx.createImageData(1,1),this.init()}init(){this.showDragNumberDiv=this.createShowSliceNumberDiv(),this.mainAreaContainer.classList.add("copper3D_drawingCanvasContainer"),this.container.appendChild(this.mainAreaContainer),this.autoFocusDiv(this.container),this.downloadImage.href="",this.downloadImage.target="_blank";for(let t=0;t<this.nrrd_states.Max_sensitive;t++)this.sensitiveArray.push((t+1)/20);this.container.addEventListener("keydown",t=>{t.key==="Shift"&&(this.Is_Shift_Pressed=!0,this.nrrd_states.enableCursorChoose=!1),t.key==="s"&&(this.Is_Draw=!1,this.nrrd_states.enableCursorChoose=!this.nrrd_states.enableCursorChoose)}),this.container.addEventListener("keyup",t=>{t.key==="Shift"&&(this.Is_Shift_Pressed=!1)})}setAllSlices(t){this.allSlicesArray=[...t],this.nrrd_states.nrrd_x=this.allSlicesArray[0].z.canvas.width,this.nrrd_states.nrrd_y=this.allSlicesArray[0].z.canvas.height,this.nrrd_states.nrrd_z=this.allSlicesArray[0].x.canvas.width,this.nrrd_states.dimensions=this.allSlicesArray[0].x.volume.dimensions,this.nrrd_states.RSARatioArray=this.allSlicesArray[0].x.volume.spacing,this.allSlicesArray.forEach((e,s)=>{e.x.contrastOrder=s,e.y.contrastOrder=s,e.z.contrastOrder=s}),this.nrrd_states.ratios.x=this.nrrd_states.nrrd_x/this.nrrd_states.dimensions[0],this.nrrd_states.ratios.y=this.nrrd_states.nrrd_y/this.nrrd_states.dimensions[1],this.nrrd_states.ratios.z=this.nrrd_states.nrrd_z/this.nrrd_states.dimensions[2],this.nrrd_states.sharedPlace.x=this.getSharedPlace(this.nrrd_states.dimensions[0],this.nrrd_states.ratios.x),this.nrrd_states.sharedPlace.y=this.getSharedPlace(this.nrrd_states.dimensions[1],this.nrrd_states.ratios.y),this.nrrd_states.sharedPlace.z=this.getSharedPlace(this.nrrd_states.dimensions[2],this.nrrd_states.ratios.z),this.initPaintImages(this.nrrd_states.dimensions),this.setDisplaySlicesBaseOnAxis(),this.afterLoadSlice()}getSharedPlace(t,e){let s=-1,i=[],n=new Set;for(let o=0;o<t;o++){const a=Math.floor(o*e);a===s?(n.add(o-1),n.add(o)):s=a}return n.forEach(o=>{i.push(o)}),i}initPaintImages(t){for(let e=0;e<t[0];e++){const s=this.emptyCtx.createImageData(this.nrrd_states.nrrd_z,this.nrrd_states.nrrd_y),i={index:e,image:s};this.paintImages.x.push(i)}for(let e=0;e<t[1];e++){const s=this.emptyCtx.createImageData(this.nrrd_states.nrrd_x,this.nrrd_states.nrrd_z),i={index:e,image:s};this.paintImages.y.push(i)}for(let e=0;e<t[2];e++){const s=this.emptyCtx.createImageData(this.nrrd_states.nrrd_x,this.nrrd_states.nrrd_y),i={index:e,image:s};this.paintImages.z.push(i)}}setSliceOrientation(t){this.nrrd_states.enableCursorChoose&&(this.axis==="z"?(this.cursorPage.z.index=this.nrrd_states.currentIndex,this.cursorPage.z.cursorPageX=this.nrrd_states.cursorPageX,this.cursorPage.z.cursorPageY=this.nrrd_states.cursorPageY):this.axis==="x"?(this.cursorPage.x.index=this.nrrd_states.currentIndex,this.cursorPage.x.cursorPageX=this.nrrd_states.cursorPageX,this.cursorPage.x.cursorPageY=this.nrrd_states.cursorPageY):this.axis==="y"&&(this.cursorPage.y.index=this.nrrd_states.currentIndex,this.cursorPage.y.cursorPageX=this.nrrd_states.cursorPageX,this.cursorPage.y.cursorPageY=this.nrrd_states.cursorPageY),t==="z"?this.nrrd_states.isCursorSelect&&!this.cursorPage.z.updated?(this.axis==="x"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.x.cursorPageX/this.nrrd_states.nrrd_z*this.mainPreSlice.volume.dimensions[2]),this.nrrd_states.cursorPageX=Math.ceil(this.cursorPage.x.index/this.mainPreSlice.volume.dimensions[0]*this.nrrd_states.nrrd_x)),this.axis==="y"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.y.cursorPageY/this.nrrd_states.nrrd_z*this.mainPreSlice.volume.dimensions[2]),this.nrrd_states.cursorPageY=Math.ceil(this.cursorPage.y.index/this.mainPreSlice.volume.dimensions[1]*this.nrrd_states.nrrd_y)),this.cursorPage.z.updated=!0):(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=this.cursorPage.z.index,this.nrrd_states.cursorPageX=this.cursorPage.z.cursorPageX,this.nrrd_states.cursorPageY=this.cursorPage.z.cursorPageY):t==="x"?this.nrrd_states.isCursorSelect&&!this.cursorPage.x.updated?(this.axis==="z"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.z.cursorPageX/this.nrrd_states.nrrd_x*this.mainPreSlice.volume.dimensions[0]),this.nrrd_states.cursorPageX=Math.floor(this.cursorPage.z.index/this.mainPreSlice.volume.dimensions[2]*this.nrrd_states.nrrd_z)),this.axis==="y"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.y.cursorPageX/this.nrrd_states.nrrd_y*this.mainPreSlice.volume.dimensions[1]),this.nrrd_states.cursorPageX=this.cursorPage.y.cursorPageY,this.nrrd_states.cursorPageY=Math.ceil(this.cursorPage.y.index/this.mainPreSlice.volume.dimensions[1]*this.nrrd_states.nrrd_y)),this.cursorPage.x.updated=!0):(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=this.cursorPage.x.index,this.nrrd_states.cursorPageX=this.cursorPage.x.cursorPageX,this.nrrd_states.cursorPageY=this.cursorPage.x.cursorPageY):t==="y"&&(this.nrrd_states.isCursorSelect&&!this.cursorPage.y.updated?(this.axis==="z"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.z.cursorPageY/this.nrrd_states.nrrd_y*this.mainPreSlice.volume.dimensions[1]),this.nrrd_states.cursorPageY=Math.ceil(this.cursorPage.z.index/this.mainPreSlice.volume.dimensions[2]*this.nrrd_states.nrrd_z)),this.axis==="x"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.x.cursorPageY/this.nrrd_states.nrrd_x*this.mainPreSlice.volume.dimensions[0]),this.nrrd_states.cursorPageX=Math.ceil(this.cursorPage.x.index/this.mainPreSlice.volume.dimensions[0]*this.nrrd_states.nrrd_x),this.nrrd_states.cursorPageY=Math.ceil(this.cursorPage.x.cursorPageX)),this.cursorPage.y.updated=!0):(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=this.cursorPage.y.index,this.nrrd_states.cursorPageX=this.cursorPage.y.cursorPageX,this.nrrd_states.cursorPageY=this.cursorPage.y.cursorPageY)),this.cursorPage.x.updated&&this.cursorPage.y.updated&&this.cursorPage.z.updated&&(this.nrrd_states.isCursorSelect=!1)),this.axis=t,this.resetDisplaySlicesStatus()}addSkip(t){this.skipSlicesDic[t]=this.backUpDisplaySlices[t],t>=this.displaySlices.length?this.nrrd_states.contrastNum=this.displaySlices.length:this.nrrd_states.contrastNum=t,this.resetDisplaySlicesStatus()}removeSkip(t){this.skipSlicesDic[t]=void 0,this.nrrd_states.contrastNum=0,this.resetDisplaySlicesStatus()}clear(){this.allSlicesArray.length=0,this.displaySlices.length=0,this.undoArray.length=0,this.paintImages.x.length=0,this.paintImages.y.length=0,this.paintImages.z.length=0,this.clearDictionary(this.skipSlicesDic),this.backUpDisplaySlices.length=0,this.mainPreSlice=void 0,this.currentShowingSlice=void 0,this.previousDrawingImage=this.emptyCtx.createImageData(1,1),this.initState=!0,this.axis="z",this.nrrd_states.sizeFoctor=1,this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width,this.drawingCanvas.width=this.drawingCanvas.width,this.displayCanvas.width=this.displayCanvas.width}setSliceMoving(t){this.mainPreSlice&&(this.Is_Draw=!0,this.setSyncsliceNum(),this.updateIndex(t),this.setIsDrawFalse(1e3))}setShowInMainArea(t){this.nrrd_states.showContrast=t,this.nrrd_states.contrastNum=0,this.mainPreSlice&&(this.redrawMianPreOnDisplayCanvas(),this.updateShowNumDiv(this.nrrd_states.contrastNum))}setMainAreaSize(t){this.nrrd_states.sizeFoctor+=t,this.nrrd_states.sizeFoctor>=8?this.nrrd_states.sizeFoctor=8:this.nrrd_states.sizeFoctor<=1&&(this.nrrd_states.sizeFoctor=1),this.resizePaintArea(this.nrrd_states.sizeFoctor),this.resetPaintArea(),this.setIsDrawFalse(1e3)}getMaxSliceNum(){return this.nrrd_states.showContrast?[this.nrrd_states.maxIndex,this.nrrd_states.maxIndex*this.displaySlices.length]:[this.nrrd_states.maxIndex]}getCurrentSlicesNumAndContrastNum(){return{currentIndex:this.nrrd_states.currentIndex,contrastIndex:this.nrrd_states.contrastNum}}getCurrentSliceIndex(){return Math.ceil(this.mainPreSlice.index/this.nrrd_states.RSARatio)}getIsShowContrastState(){return this.nrrd_states.showContrast}setIsDrawFalse(t){this.preTimer=setTimeout(()=>{this.Is_Draw=!1,this.preTimer&&(window.clearTimeout(this.preTimer),this.preTimer=void 0)},t)}setDisplaySlicesBaseOnAxis(){this.displaySlices.length=0,this.backUpDisplaySlices.length=0,this.allSlicesArray.forEach(t=>{this.backUpDisplaySlices.push(t[this.axis])}),this.loadDisplaySlicesArray()}loadDisplaySlicesArray(){const t=Object.values(this.skipSlicesDic);t.length===0?this.backUpDisplaySlices.forEach((e,s)=>{this.skipSlicesDic[s]=e,this.displaySlices.push(e)}):t.forEach((e,s)=>{e&&(this.displaySlices.push(this.backUpDisplaySlices[s]),this.skipSlicesDic[s]=this.backUpDisplaySlices[s])})}resetDisplaySlicesStatus(){this.setDisplaySlicesBaseOnAxis(),this.setupConfigs()}setupConfigs(){this.setMainPreSlice(),this.updateMaxIndex(),this.setOriginCanvasAndPre(),this.updateShowNumDiv(this.nrrd_states.contrastNum),this.repraintCurrentContrastSlice(),this.resizePaintArea(this.nrrd_states.sizeFoctor),this.resetPaintArea()}setMainPreSlice(){this.mainPreSlice=this.displaySlices[0],this.mainPreSlice&&(this.nrrd_states.RSARatio=this.mainPreSlice.RSARatio),console.log(this.mainPreSlice)}findLastCanvas(){for(let t=this.mainPreSlice.MaxIndex;t>0;t--)if(this.mainPreSlice.index=t*this.nrrd_states.RSARatio,this.mainPreSlice.repaint.call(this.mainPreSlice),!this.verifyCanvasIsEmpty(this.mainPreSlice.canvas)){this.mainPreSlice.index=(t-1)*this.nrrd_states.RSARatio,this.mainPreSlice.repaint.call(this.mainPreSlice),this.nrrd_states.latestNotEmptyImg.src=this.mainPreSlice.canvas.toDataURL();break}}setOriginCanvasAndPre(){this.mainPreSlice&&(this.nrrd_states.oldIndex>this.nrrd_states.maxIndex&&(this.nrrd_states.oldIndex=this.nrrd_states.maxIndex),this.initState?(this.nrrd_states.oldIndex=this.mainPreSlice.initIndex,this.nrrd_states.currentIndex=this.mainPreSlice.initIndex):this.axis==="y"||this.axis==="x"?this.mainPreSlice.index=(this.nrrd_states.dimensions[1]-1-this.nrrd_states.oldIndex)*this.nrrd_states.RSARatio:this.mainPreSlice.index=this.nrrd_states.oldIndex*this.nrrd_states.RSARatio,this.originCanvas=this.mainPreSlice.canvas,this.updateOriginAndChangedWH())}afterLoadSlice(){this.setMainPreSlice(),this.setOriginCanvasAndPre(),this.currentShowingSlice=this.mainPreSlice,this.undoArray=[{sliceIndex:this.mainPreSlice.index,undos:[]}],this.nrrd_states.oldIndex=this.mainPreSlice.initIndex,this.nrrd_states.currentIndex=this.mainPreSlice.initIndex,this.updateMaxIndex(),this.updateShowNumDiv(this.nrrd_states.contrastNum),this.initState=!1}updateMaxIndex(){this.mainPreSlice&&(this.nrrd_states.maxIndex=this.mainPreSlice.MaxIndex)}updateCurrentContrastSlice(){return this.currentShowingSlice=this.displaySlices[this.nrrd_states.contrastNum],this.currentShowingSlice}createShowSliceNumberDiv(){const t=document.createElement("div");return t.className="copper3d_sliceNumber",t.style.position="absolute",t.style.zIndex="100",t.style.top="20px",t.style.left="100px",t}updateOriginAndChangedWH(){this.nrrd_states.originWidth=this.originCanvas.width,this.nrrd_states.originHeight=this.originCanvas.height,this.nrrd_states.changedWidth=this.nrrd_states.originWidth*Number(this.gui_states.mainAreaSize),this.nrrd_states.changedHeight=this.nrrd_states.originWidth*Number(this.gui_states.mainAreaSize)}initAllCanvas(){this.displayCanvas.style.position="absolute",this.displayCanvas.style.zIndex="9",this.displayCanvas.width=this.nrrd_states.changedWidth,this.displayCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.style.zIndex="10",this.drawingCanvas.style.position="absolute",this.drawingCanvas.width=this.nrrd_states.changedWidth,this.drawingCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor,this.drawingCanvas.oncontextmenu=()=>!1,this.drawingCanvasLayerOne.width=this.nrrd_states.changedWidth,this.drawingCanvasLayerOne.height=this.nrrd_states.changedHeight,this.mainAreaContainer.style.width=this.nrrd_states.originWidth*8+"px",this.mainAreaContainer.style.height=this.nrrd_states.originHeight*8+"px",this.mainAreaContainer.appendChild(this.displayCanvas),this.mainAreaContainer.appendChild(this.drawingCanvas)}autoFocusDiv(t){t.tabIndex=10,t.addEventListener("mouseover",()=>{t.focus()}),t.style.outline="none"}setSyncsliceNum(){this.displaySlices.forEach((t,e)=>{e!==0&&(t.index=this.mainPreSlice.index)})}repraintCurrentContrastSlice(){this.setSyncsliceNum(),this.displaySlices.forEach((t,e)=>{t.repaint.call(t)})}repraintAllContrastSlices(){this.displaySlices.forEach((t,e)=>{t.volume.repaintAllSlices()})}updateShowNumDiv(t){this.mainPreSlice&&(this.nrrd_states.currentIndex>this.nrrd_states.maxIndex&&(this.nrrd_states.currentIndex=this.nrrd_states.maxIndex),this.nrrd_states.showContrast?this.showDragNumberDiv.innerHTML=`ContrastNum: ${t}/${this.displaySlices.length-1} SliceNum: ${this.nrrd_states.currentIndex}/${this.nrrd_states.maxIndex}`:this.showDragNumberDiv.innerHTML=`SliceNum: ${this.nrrd_states.currentIndex}/${this.nrrd_states.maxIndex}`)}appendLoadingbar(t){this.mainAreaContainer.appendChild(t)}drag(t){let e,s,i=this.container.offsetHeight,n=1,o,a,h;this.sensitiveArray.reverse(),t!=null&&t.showNumber&&this.container.appendChild(this.showDragNumberDiv),a=d=>{this.drawingCanvas.removeEventListener("wheel",this.handleWheelMove),d.button===0&&(this.setSyncsliceNum(),s=d.offsetY/i,this.container.addEventListener("pointermove",h,!1),n=this.sensitiveArray[this.gui_states.dragSensitivity-1])},h=$(d=>{s-d.offsetY/i>=0?e=-Math.ceil((s-d.offsetY/i)*10/n):e=-Math.floor((s-d.offsetY/i)*10/n),this.updateIndex(e),t!=null&&t.getSliceNum&&t.getSliceNum(this.nrrd_states.currentIndex,this.nrrd_states.contrastNum),s=d.offsetY/i},n*200),o=d=>{this.drawingCanvas.addEventListener("wheel",this.handleWheelMove),this.setSyncsliceNum(),this.container.removeEventListener("pointermove",h,!1)};const l=()=>{this.container.style.cursor="pointer",this.container.addEventListener("pointerdown",a,!0),this.container.addEventListener("pointerup",o,!0)};l(),this.container.addEventListener("keydown",d=>{d.key==="Shift"&&(this.container.style.cursor="",this.container.removeEventListener("pointerdown",a,!0),this.container.removeEventListener("pointerup",o,!1),this.setIsDrawFalse(1e3))}),this.container.addEventListener("keyup",d=>{d.key==="Shift"&&l()})}updateIndex(t){let e=0,s=0;this.nrrd_states.showContrast?(s=t%this.displaySlices.length,this.nrrd_states.contrastNum+=s,t>0?this.mainPreSlice.index/this.nrrd_states.RSARatio<=this.nrrd_states.maxIndex?(e=Math.floor(t/this.displaySlices.length),this.nrrd_states.contrastNum>this.displaySlices.length-1&&(e+=1,this.nrrd_states.contrastNum-=this.displaySlices.length)):e=0:(e=Math.ceil(t/this.displaySlices.length),this.nrrd_states.contrastNum<0&&(this.nrrd_states.contrastNum+=this.displaySlices.length,e-=1))):e=t;let i=this.nrrd_states.oldIndex+e;if(i!=this.nrrd_states.oldIndex||this.nrrd_states.showContrast){if(i>this.nrrd_states.maxIndex)i=this.nrrd_states.maxIndex,this.nrrd_states.contrastNum=4;else if(i<this.nrrd_states.minIndex)i=this.nrrd_states.minIndex,this.nrrd_states.contrastNum=0;else{this.axis==="y"||this.axis==="x"?this.mainPreSlice.index=(this.nrrd_states.maxIndex-i)*this.nrrd_states.RSARatio:this.mainPreSlice.index=i*this.nrrd_states.RSARatio,this.nrrd_states.currentIndex=i,i!=this.nrrd_states.oldIndex&&(this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width),this.displayCanvas.width=this.displayCanvas.width,this.nrrd_states.changedWidth===0&&(this.nrrd_states.changedWidth=this.nrrd_states.originWidth,this.nrrd_states.changedHeight=this.nrrd_states.originHeight);let n=this.updateCurrentContrastSlice();n.repaint.call(n),this.drawDragSlice(n.canvas,i)}this.nrrd_states.oldIndex=i,this.updateShowNumDiv(this.nrrd_states.contrastNum)}}drawDragSlice(t,e){var s;this.displayCtx.save(),this.flipDisplayImageByYAxis(),this.displayCtx.drawImage(t,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.displayCtx.restore(),(this.paintImages.x.length>0||this.paintImages.y.length>0||this.paintImages.z.length>0)&&e!=this.nrrd_states.oldIndex&&(this.paintedImage=this.filterDrawedImage(this.axis,this.nrrd_states.currentIndex),(s=this.paintedImage)!=null&&s.image&&(this.emptyCanvas.width=this.nrrd_states.originWidth,this.emptyCanvas.height=this.nrrd_states.originHeight,this.emptyCtx.putImageData(this.paintedImage.image,0,0),this.drawingLayerOneCtx.drawImage(this.emptyCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight)))}draw(t,e){let s,i;this.sceneIn=t,t.controls.enabled=!1,this.gui_states.subView===!1&&t.subDiv&&(t.subDiv.style.display="none"),s=e.addFolder("Mode Parameters"),t.subDiv&&(i=e.addFolder("Sub View"),i.add(this.gui_states,"resetView"),i.add(this.gui_states,"subView").onChange(n=>{n?(t.controls.enabled=!0,t.subDiv&&(t.subDiv.style.display="block")):(t.subDiv&&(t.subDiv.style.display="none"),t.controls.enabled=!1)}),i.add(this.gui_states,"subViewScale").min(.25).max(2).step(.01).onFinishChange(n=>{t.subDiv&&(t.subDiv.style.width=200*n+"px"),t.subDiv&&(t.subDiv.style.height=200*n+"px")})),this.paintOnCanvas(s)}paintOnCanvas(t){var w,_,S,v;let e=!1,s=!1,i=0,n=0,o=this.mainPreSlice.index,a=!1,h=[];this.updateOriginAndChangedWH(),this.initAllCanvas(),this.configGui(t),(w=this.displayCtx)==null||w.save(),this.flipDisplayImageByYAxis(),(_=this.displayCtx)==null||_.drawImage(this.originCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),(S=this.displayCtx)==null||S.restore(),this.previousDrawingImage=this.drawingCtx.getImageData(0,0,this.drawingCanvas.width,this.drawingCanvas.height),this.handleWheelMove=this.configMouseWheel((v=this.sceneIn)==null?void 0:v.controls),this.drawingCanvas.addEventListener("wheel",this.handleWheelMove,{passive:!1});const l=$(r=>{this.drawingCanvas.style.cursor="grabbing",this.displayCanvas.style.left=this.drawingCanvas.style.left=r.clientX-i+"px",this.displayCanvas.style.top=this.drawingCanvas.style.top=r.clientY-n+"px"},80),d=r=>{this.nrrd_states.Mouse_Over_x=r.offsetX,this.nrrd_states.Mouse_Over_y=r.offsetY,this.nrrd_states.Mouse_Over_x===void 0&&(this.nrrd_states.Mouse_Over_x=r.clientX,this.nrrd_states.Mouse_Over_y=r.clientY),r.type==="mouseout"?(this.nrrd_states.Mouse_Over=!1,this.drawingCanvas.removeEventListener("mousemove",d)):r.type==="mouseover"&&(this.nrrd_states.Mouse_Over=!0,this.drawingCanvas.addEventListener("mousemove",d)),r.preventDefault()};this.drawingCanvas.addEventListener("mouseover",d),this.drawingCanvas.addEventListener("mouseout",d),this.drawingCanvas.addEventListener("pointerdown",r=>{if(e||s){this.drawingCanvas.removeEventListener("pointerup",u),this.drawingLayerOneCtx.closePath();return}if(o!==this.mainPreSlice.index&&(this.previousDrawingImage=this.emptyCtx.createImageData(1,1),o=this.mainPreSlice.index),this.drawingCanvas.removeEventListener("wheel",this.handleWheelMove),r.button===0){if(this.Is_Shift_Pressed)e=!0,h=[],a=!0,this.Is_Draw=!0,this.gui_states.Eraser?this.drawingCanvas.style.cursor="url(https://raw.githubusercontent.com/LinkunGao/copper3d_icons/main/icons/circular-cursor.png) 52 52, crosshair":this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor,this.nrrd_states.drawStartPos.set(r.offsetX,r.offsetY),this.drawingLayerOneCtx.beginPath(),this.drawingCanvas.addEventListener("pointerup",u),this.drawingCanvas.addEventListener("pointermove",p);else if(this.nrrd_states.enableCursorChoose)switch(this.nrrd_states.cursorPageX=r.offsetX/this.nrrd_states.sizeFoctor,this.nrrd_states.cursorPageY=r.offsetY/this.nrrd_states.sizeFoctor,this.nrrd_states.isCursorSelect=!0,this.axis){case"x":this.cursorPage.x.updated=!0,this.cursorPage.y.updated=!1,this.cursorPage.z.updated=!1;break;case"y":this.cursorPage.x.updated=!1,this.cursorPage.y.updated=!0,this.cursorPage.z.updated=!1;break;case"z":this.cursorPage.x.updated=!1,this.cursorPage.y.updated=!1,this.cursorPage.z.updated=!0;break}}else if(r.button===2){s=!0;let I=parseInt(this.drawingCanvas.style.left),y=parseInt(this.drawingCanvas.style.top);i=r.clientX-I,n=r.clientY-y,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.addEventListener("pointerup",u),this.drawingCanvas.addEventListener("pointermove",l)}else return},!0);const g=this.useEraser(),p=r=>{this.Is_Draw=!0,a&&(this.gui_states.Eraser?(this.nrrd_states.stepClear=1,g(r.offsetX,r.offsetY,this.gui_states.brushAndEraserSize)):(h.push({x:r.offsetX,y:r.offsetY}),this.paintOnCanvasLayerOne(r.offsetX,r.offsetY)))},u=r=>{var I;if(r.button===0){if(this.Is_Shift_Pressed||a){if(e=!1,this.drawingLayerOneCtx.closePath(),this.drawingCanvas.removeEventListener("pointermove",p),!this.gui_states.Eraser&&this.gui_states.segmentation){this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width;const z=(I=this.filterDrawedImage(this.axis,this.nrrd_states.currentIndex))==null?void 0:I.image;z&&(this.previousDrawingImage=z),this.emptyCanvas.width=this.emptyCanvas.width,this.emptyCtx.putImageData(this.previousDrawingImage,0,0),this.drawingLayerOneCtx.drawImage(this.emptyCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingLayerOneCtx.beginPath(),this.drawingLayerOneCtx.moveTo(h[0].x,h[0].y);for(let O=1;O<h.length;O++)this.drawingLayerOneCtx.lineTo(h[O].x,h[O].y);this.drawingLayerOneCtx.closePath(),this.drawingLayerOneCtx.lineWidth=1,this.drawingLayerOneCtx.fillStyle=this.gui_states.fillColor,this.drawingLayerOneCtx.fill()}this.previousDrawingImage=this.drawingLayerOneCtx.getImageData(0,0,this.drawingCanvasLayerOne.width,this.drawingCanvasLayerOne.height),this.storeAllImages();const y=this.drawingCtx.getImageData(0,0,this.drawingCanvas.width,this.drawingCanvas.height);console.log("Paint mark data -----> :",y),a=!1;const L=this.getCurrentUndo(),W=this.drawingCanvasLayerOne.toDataURL(),E=new Image;if(E.src=W,L.length>0)L[0].undos.push(E);else{const z={sliceIndex:this.nrrd_states.currentIndex,undos:[]};z.undos.push(E),this.undoArray.push(z)}}}else if(r.button===2)s=!1,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.removeEventListener("pointermove",l);else return;this.drawingCanvas.addEventListener("wheel",this.handleWheelMove,{passive:!1}),this.gui_states.segmentation||this.setIsDrawFalse(100)};this.drawingCanvas.addEventListener("pointerleave",r=>{a=!1,e&&(e=!1,this.drawingLayerOneCtx.closePath(),this.drawingCanvas.removeEventListener("pointermove",p)),s&&(s=!1,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.removeEventListener("pointermove",l)),this.setIsDrawFalse(100),this.gui_states.segmentation&&this.setIsDrawFalse(1e3)}),this.start=()=>{if(this.nrrd_states.readyToUpdate){if(this.drawingCtx.clearRect(0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingCtx.globalAlpha=this.gui_states.globalAlpha,this.Is_Draw)this.drawingLayerOneCtx.lineCap="round",this.drawingLayerOneCtx.globalAlpha=1;else if(this.Is_Shift_Pressed&&!this.gui_states.segmentation&&!this.gui_states.Eraser&&this.nrrd_states.Mouse_Over&&(this.drawingCtx.clearRect(0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingCtx.fillStyle=this.gui_states.brushColor,this.drawingCtx.beginPath(),this.drawingCtx.arc(this.nrrd_states.Mouse_Over_x,this.nrrd_states.Mouse_Over_y,this.gui_states.brushAndEraserSize/2+1,0,Math.PI*2),this.drawingCtx.strokeStyle=this.gui_states.brushColor,this.drawingCtx.stroke()),this.nrrd_states.enableCursorChoose){this.drawingCtx.clearRect(0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight);const r=this.nrrd_states.cursorPageX*this.nrrd_states.sizeFoctor,I=this.nrrd_states.cursorPageY*this.nrrd_states.sizeFoctor;this.drawLine(r,0,r,this.drawingCanvas.height),this.drawLine(0,I,this.drawingCanvas.width,I)}this.drawingCtx.drawImage(this.drawingCanvasLayerOne,0,0)}else this.redrawDisplayCanvas()},document.addEventListener("keydown",r=>{(r.ctrlKey||r.metaKey)&&r.code==="KeyZ"&&this.undoLastPainting()})}undoLastPainting(){this.Is_Draw=!0,this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width,this.mainPreSlice.repaint.call(this.mainPreSlice);const t=this.getCurrentUndo();if(t.length>0){const e=t[0];if(e.undos.length===0)return;if(e.undos.pop(),e.undos.length>0){const s=e.undos[e.undos.length-1];this.drawingLayerOneCtx.drawImage(s,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight)}this.previousDrawingImage=this.drawingLayerOneCtx.getImageData(0,0,this.drawingCanvasLayerOne.width,this.drawingCanvasLayerOne.height),this.storeAllImages(),this.setIsDrawFalse(1e3)}}getCurrentUndo(){return this.undoArray.filter(t=>t.sliceIndex===this.nrrd_states.currentIndex)}configMouseWheel(t){let e=1;return i=>{if(this.Is_Shift_Pressed)return;i.preventDefault();const n=i.detail?i.detail>0:i.wheelDelta<0;this.Is_Draw=!0;const o=(i.clientX-this.mainAreaContainer.offsetLeft-this.drawingCanvas.offsetLeft)/this.drawingCanvas.offsetWidth,a=(i.clientY-this.mainAreaContainer.offsetTop-this.drawingCanvas.offsetTop)/this.drawingCanvas.offsetHeight,h=n?1-.1:1+.1,l=this.drawingCanvas.offsetWidth*h,d=this.drawingCanvas.offsetHeight*h,g=Math.round(i.clientX-this.mainAreaContainer.offsetLeft-l*o),p=Math.round(i.clientY-this.mainAreaContainer.offsetTop-d*a);e=l/this.nrrd_states.originWidth,e>8?e=8:e<1?e=1:(this.resizePaintArea(e),this.resetPaintArea(g,p),t&&(t.enabled=!1),this.setIsDrawFalse(1e3)),this.nrrd_states.sizeFoctor=e}}useEraser(){const t=(e,s,i)=>{var n=i-this.nrrd_states.stepClear,o=Math.sqrt(i*i-n*n),a=e-n,h=s-o,l=2*n,d=2*o;this.nrrd_states.stepClear<=i&&(this.drawingLayerOneCtx.clearRect(a,h,l,d),this.nrrd_states.stepClear+=1,t(e,s,i))};return t}clearPaint(){this.Is_Draw=!0,this.drawingCanvasLayerOne.width=this.drawingCanvas.width,this.originCanvas.width=this.originCanvas.width,this.mainPreSlice.repaint.call(this.mainPreSlice),this.previousDrawingImage=this.emptyCtx.createImageData(1,1),this.storeAllImages(),this.setIsDrawFalse(1e3)}clearStoreImages(){this.paintImages.x.length=0,this.paintImages.y.length=0,this.paintImages.z.length=0,this.initPaintImages(this.nrrd_states.dimensions)}enableDownload(){this.downloadImage.download=`slice_${this.axis}_#${this.nrrd_states.currentIndex}`;const t=this.downloadCanvas.getContext("2d");this.downloadCanvas.width=this.nrrd_states.originWidth,this.downloadCanvas.height=this.nrrd_states.originHeight,t.drawImage(this.drawingCanvas,0,0,this.nrrd_states.originWidth,this.nrrd_states.originHeight),this.downloadImage.href=this.downloadCanvas.toDataURL(),this.downloadImage.click()}paintOnCanvasLayerOne(t,e){this.drawingLayerOneCtx.beginPath(),this.drawingLayerOneCtx.moveTo(this.nrrd_states.drawStartPos.x,this.nrrd_states.drawStartPos.y),this.gui_states.segmentation?(this.drawingLayerOneCtx.strokeStyle=this.gui_states.color,this.drawingLayerOneCtx.lineWidth=this.gui_states.lineWidth):(this.drawingLayerOneCtx.strokeStyle=this.gui_states.brushColor,this.drawingLayerOneCtx.lineWidth=this.gui_states.brushAndEraserSize),this.drawingLayerOneCtx.lineTo(t,e),this.drawingLayerOneCtx.stroke(),this.nrrd_states.drawStartPos.set(t,e),this.drawingLayerOneCtx.closePath(),this.mainPreSlice.mesh.material.map.needsUpdate=!0}configGui(t){t.__controllers.length>0&&this.removeGuiFolderChilden(t),t.open();const e=t.addFolder("Default Actions");e.add(this.gui_states,"cursor",["crosshair","pencil","dot"]).name("cursor icons").onChange(a=>{a==="crosshair"&&(this.nrrd_states.defaultPaintCursor="crosshair"),a==="pencil"&&(this.nrrd_states.defaultPaintCursor="url(https://raw.githubusercontent.com/LinkunGao/copper3d_icons/main/icons/pencil-black.svg), auto"),a==="dot"&&(this.nrrd_states.defaultPaintCursor="url(https://raw.githubusercontent.com/LinkunGao/copper3d-datasets/main/icons/dot.svg) 12 12,auto"),this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor}),e.add(this.gui_states,"mainAreaSize").name("zoom").min(1).max(8).onFinishChange(a=>{this.resetPaintArea(),this.nrrd_states.sizeFoctor=a,this.resizePaintArea(a)}),e.add(this.gui_states,"resetZoom"),e.add(this.gui_states,"globalAlpha").name("opacity").min(.1).max(1).step(.01),e.add(this.gui_states,"segmentation").name("Pencil"),e.add(this.gui_states,"brushAndEraserSize").min(5).max(50).step(1),e.add(this.gui_states,"Eraser").onChange(a=>{this.gui_states.Eraser=a,this.gui_states.Eraser?this.drawingCanvas.style.cursor="url(https://raw.githubusercontent.com/LinkunGao/copper3d_icons/main/icons/circular-cursor.png) 52 52, crosshair":this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor}),e.add(this.gui_states,"clear"),e.add(this.gui_states,"clearAll"),e.add(this.gui_states,"undo"),e.add(this.mainPreSlice.volume,"windowHigh",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Image contrast").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"windowHigh")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),e.add(this.gui_states,"exportMarks");const s=t.addFolder("Advance settings");s.add(this.gui_states,"dragSensitivity").min(1).max(this.nrrd_states.Max_sensitive).step(1);const i=s.addFolder("Pencil settings");i.add(this.gui_states,"lineWidth").name("outerLineWidth").min(1.7).max(3).step(.01),i.addColor(this.gui_states,"color"),i.addColor(this.gui_states,"fillColor"),s.addFolder("Brush settings").addColor(this.gui_states,"brushColor"),s.add(this.gui_states,"downloadCurrentMask");const o=s.addFolder("contrast advance settings");o.add(this.mainPreSlice.volume,"lowerThreshold",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Lower Threshold").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"lowerThreshold")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),o.add(this.mainPreSlice.volume,"upperThreshold",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Upper Threshold").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"upperThreshold")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),o.add(this.mainPreSlice.volume,"windowLow",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Window Low").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"windowLow")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),e.open()}updateSlicesContrast(t,e){switch(e){case"lowerThreshold":this.displaySlices.forEach((s,i)=>{s.volume.lowerThreshold=t});break;case"upperThreshold":this.displaySlices.forEach((s,i)=>{s.volume.upperThreshold=t});break;case"windowLow":this.displaySlices.forEach((s,i)=>{s.volume.windowLow=t});break;case"windowHigh":this.displaySlices.forEach((s,i)=>{s.volume.windowHigh=t});break}this.repraintCurrentContrastSlice()}resetPaintArea(t,e){t&&e?(this.displayCanvas.style.left=this.drawingCanvas.style.left=t+"px",this.displayCanvas.style.top=this.drawingCanvas.style.top=e+"px"):(this.displayCanvas.style.left=this.drawingCanvas.style.left="",this.displayCanvas.style.top=this.drawingCanvas.style.top="",this.mainAreaContainer.style.justifyContent="center",this.mainAreaContainer.style.alignItems="center")}redrawDisplayCanvas(){var t,e,s;this.updateCurrentContrastSlice(),this.displayCanvas.width=this.displayCanvas.width,this.displayCanvas.height=this.displayCanvas.height,this.originCanvas.width=this.originCanvas.width,this.currentShowingSlice&&(this.currentShowingSlice.repaint.call(this.currentShowingSlice),(t=this.displayCtx)==null||t.save(),this.flipDisplayImageByYAxis(),(e=this.displayCtx)==null||e.drawImage(this.currentShowingSlice.canvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),(s=this.displayCtx)==null||s.restore())}redrawMianPreOnDisplayCanvas(){var t;this.displayCanvas.width=this.displayCanvas.width,this.displayCanvas.height=this.displayCanvas.height,this.originCanvas.width=this.originCanvas.width,this.mainPreSlice&&(this.mainPreSlice.repaint.call(this.mainPreSlice),this.flipDisplayImageByYAxis(),(t=this.displayCtx)==null||t.drawImage(this.originCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.resizePaintArea(this.nrrd_states.sizeFoctor))}resizePaintArea(t){var e,s;switch(this.originCanvas.width=this.originCanvas.width,this.displayCanvas.width=this.displayCanvas.width,this.drawingCanvas.width=this.drawingCanvas.width,this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width,this.nrrd_states.changedWidth=this.nrrd_states.originWidth*t,this.nrrd_states.changedHeight=this.nrrd_states.originHeight*t,this.displayCanvas.width=this.nrrd_states.changedWidth,this.displayCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.width=this.nrrd_states.changedWidth,this.drawingCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvasLayerOne.width=this.nrrd_states.changedWidth,this.drawingCanvasLayerOne.height=this.nrrd_states.changedHeight,this.redrawDisplayCanvas(),this.axis){case"x":this.paintImages.x.length>0?this.paintedImage=this.filterDrawedImage("x",this.nrrd_states.currentIndex):this.paintedImage=void 0;break;case"y":this.paintImages.y.length>0?this.paintedImage=this.filterDrawedImage("y",this.nrrd_states.currentIndex):this.paintedImage=void 0;break;case"z":this.paintImages.z.length>0?this.paintedImage=this.filterDrawedImage("z",this.nrrd_states.currentIndex):this.paintedImage=void 0;break}(e=this.paintedImage)!=null&&e.image&&(this.emptyCanvas.width=this.nrrd_states.originWidth,this.emptyCanvas.height=this.nrrd_states.originHeight,this.emptyCtx.putImageData(this.paintedImage.image,0,0),(s=this.drawingLayerOneCtx)==null||s.drawImage(this.emptyCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight))}flipDisplayImageByYAxis(){var t,e;(t=this.displayCtx)==null||t.scale(-1,1),(e=this.displayCtx)==null||e.translate(-this.nrrd_states.changedWidth,0)}filterDrawedImage(t,e){return this.paintImages[t].filter(s=>s.index===e)[0]}removeGuiFolderChilden(t){const e=t.__controllers;e.length>0&&e.forEach(s=>{setTimeout(()=>{t.remove(s)},100)})}verifyCanvasIsEmpty(t){return this.emptyCanvas.width=t.width,this.emptyCanvas.height=t.height,t.toDataURL()===this.emptyCanvas.toDataURL()}clearDictionary(t){for(var e in t)delete t[e]}storeAllImages(){var i,n,o;this.emptyCanvas.width=this.nrrd_states.originWidth,this.emptyCanvas.height=this.nrrd_states.originHeight,this.emptyCtx.drawImage(this.drawingCanvasLayerOne,0,0,this.nrrd_states.originWidth,this.nrrd_states.originHeight);const t=this.emptyCtx.getImageData(0,0,this.emptyCanvas.width,this.emptyCanvas.height);switch(this.axis){case"x":this.emptyCtx.createImageData(this.nrrd_states.nrrd_z,this.nrrd_states.nrrd_y).data;const a=this.sliceArrayV(t.data,this.nrrd_states.nrrd_y,this.nrrd_states.nrrd_z),h=this.sliceArrayH(t.data,this.nrrd_states.nrrd_y,this.nrrd_states.nrrd_z),l=Math.floor(this.nrrd_states.currentIndex/this.nrrd_states.dimensions[0]*this.nrrd_states.nrrd_x);this.replaceVerticalColPixels(this.paintImages.z,this.nrrd_states.dimensions[2],this.nrrd_states.ratios.z,a,this.nrrd_states.nrrd_x,l),this.replaceVerticalColPixels(this.paintImages.y,this.nrrd_states.dimensions[1],this.nrrd_states.ratios.y,h,this.nrrd_states.nrrd_x,l);break;case"y":const d=this.sliceArrayV(t.data,this.nrrd_states.nrrd_z,this.nrrd_states.nrrd_x),g=this.sliceArrayH(t.data,this.nrrd_states.nrrd_z,this.nrrd_states.nrrd_x),p=Math.floor(this.nrrd_states.currentIndex/this.nrrd_states.dimensions[1]*this.nrrd_states.nrrd_y);this.replaceHorizontalRowPixels(this.paintImages.x,this.nrrd_states.dimensions[0],this.nrrd_states.ratios.x,d,this.nrrd_states.nrrd_z,p),this.replaceHorizontalRowPixels(this.paintImages.z,this.nrrd_states.dimensions[2],this.nrrd_states.ratios.z,g,this.nrrd_states.nrrd_x,p);break;case"z":let u=this.emptyCtx.createImageData(this.nrrd_states.nrrd_x,this.nrrd_states.nrrd_y).data;if(this.nrrd_states.sharedPlace.z.includes(this.nrrd_states.currentIndex)){const v=this.findSliceInSharedPlace();if(v.push(t),v.length>0)for(let r=0;r<v.length;r++)this.replaceArray(u,v[r].data)}else u=t.data;const w=this.sliceArrayV(u,this.nrrd_states.nrrd_y,this.nrrd_states.nrrd_x),_=this.sliceArrayH(u,this.nrrd_states.nrrd_y,this.nrrd_states.nrrd_x),S=Math.floor(this.nrrd_states.currentIndex/this.nrrd_states.dimensions[2]*this.nrrd_states.nrrd_z);this.replaceVerticalColPixels(this.paintImages.x,this.nrrd_states.dimensions[0],this.nrrd_states.ratios.x,w,this.nrrd_states.nrrd_z,S),this.replaceHorizontalRowPixels(this.paintImages.y,this.nrrd_states.dimensions[1],this.nrrd_states.ratios.y,_,this.nrrd_states.nrrd_x,S);break}let e={index:this.nrrd_states.currentIndex,image:t},s;switch(this.axis){case"x":s=this.filterDrawedImage("x",this.nrrd_states.currentIndex),s?s.image=t:(i=this.paintImages.x)==null||i.push(e);break;case"y":s=this.filterDrawedImage("y",this.nrrd_states.currentIndex),s?s.image=t:(n=this.paintImages.y)==null||n.push(e);break;case"z":s=this.filterDrawedImage("z",this.nrrd_states.currentIndex),s?s.image=t:(o=this.paintImages.z)==null||o.push(e);break}}sliceArrayH(t,e,s){const i=[];for(let n=0;n<e;n++){const o=n*s*4,a=(n+1)*s*4,h=t.slice(o,a);i.push(h)}return i}sliceArrayV(t,e,s){const i=[],n=s*4;for(let o=0;o<s;o++){const a=[];for(let h=0;h<e;h++){const l=n*h+o*4;a.push(t[l]),a.push(t[l+1]),a.push(t[l+2]),a.push(t[l+3])}i.push(a)}return i}replaceVerticalColPixels(t,e,s,i,n,o){for(let a=0,h=e;a<h;a++){const l=Math.floor(a*s),d=t[a].image.data,g=i[l],p=n*4;for(let u=0,w=g.length;u<w;u+=4){const _=u/4*p+o*4;d[_]=g[u],d[_+1]=g[u+1],d[_+2]=g[u+2],d[_+3]=g[u+3]}}}replaceHorizontalRowPixels(t,e,s,i,n,o){for(let a=0,h=e;a<h;a++){const l=Math.floor(a*s),d=t[a].image.data,g=i[l],p=n*o*4;for(let u=0,w=g.length;u<w;u++)d[p+u]=g[u]}}replaceArray(t,e){for(let s=0,i=e.length;s<i;s++)e[s]===0||t[s]!==0||(t[s]=e[s])}findSliceInSharedPlace(){const t=[],e=Math.floor(this.nrrd_states.currentIndex*this.nrrd_states.ratios[this.axis]);for(let s=1;s<=3;s++){const i=this.nrrd_states.currentIndex-s;if(i<this.nrrd_states.minIndex)break;Math.floor(i*this.nrrd_states.ratios[this.axis])===e&&t.push(this.paintImages[this.axis][i].image)}for(let s=1;s<=3;s++){const i=this.nrrd_states.currentIndex+s;if(i>this.nrrd_states.maxIndex)break;Math.floor(i*this.nrrd_states.ratios[this.axis])===e&&t.push(this.paintImages[this.axis][i].image)}return t}exportData(){let t={x:[],y:[],z:[]};t.x=this.restructData(this.paintImages.x,this.paintImages.x.length),t.y=this.restructData(this.paintImages.y,this.paintImages.y.length),t.z=this.restructData(this.paintImages.z,this.paintImages.z.length),window.alert("Export all images, starting!!!");try{for(let e=0;e<3;e++)switch(e){case 0:const s=new Blob([JSON.stringify(t.x)],{type:"text/plain;charset=utf-8"});Y(s,"copper3D_export data_x.json");break;case 1:const i=new Blob([JSON.stringify(t.y)],{type:"text/plain;charset=utf-8"});Y(i,"copper3D_export data_y.json");break;case 2:const n=new Blob([JSON.stringify(t.z)],{type:"text/plain;charset=utf-8"});Y(n,"copper3D_export data_z.json");break}window.alert("Export all images successfully!!!")}catch{window.alert("Export failed!")}}restructData(t,e){const s=[];for(let i=0;i<e;i++){let n={sliceIndex:0,dataFormat:"RGBA - Each successive 4-digit number forms a pixel point in data array",data:[]};n.sliceIndex=t[i].index;const o=[];for(let a=0;a<t[i].image.data.length;a++)o.push(t[i].image.data[a]);n.data=o,s.push(n)}return s}}const N=f=>(j("data-v-4ab276ea"),f=f(),G(),f),yt={class:"nav"},Ct={class:"content"},wt={class:"arrows"},St=N(()=>C("ion-icon",{name:"add-circle-outline"},null,-1)),It=[St],Pt=N(()=>C("ion-icon",{name:"remove-circle-outline"},null,-1)),Dt=[Pt],bt=N(()=>C("ion-icon",{name:"chevron-back-circle-outline"},null,-1)),At=[bt],Lt=N(()=>C("ion-icon",{name:"chevron-down-circle-outline"},null,-1)),zt=[Lt],Ot=N(()=>C("ion-icon",{name:"chevron-forward-circle-outline"},null,-1)),kt=[Ot],Mt=N(()=>C("ion-icon",{name:"cloud-upload-outline"},null,-1)),Nt=[Mt],Et=X({__name:"NavBar",props:{fileNum:{default:0},min:{default:0},max:{default:160},initSliceIndex:null,immediateSliceNum:{default:0},contrastIndex:{default:0},isAxisClicked:{type:Boolean,default:!1}},emits:["onSliceChange","resetMainAreaSize","onChangeOrientation","onOpenDialog"],setup(f,{emit:t}){const e=f,s=gt(e),{immediateSliceNum:i,contrastIndex:n,initSliceIndex:o,fileNum:a}=ut(s),h=P(0);let l=0,d=!1,g=!1;const p=()=>{t("onOpenDialog",!0)},u=v=>{d=!0,t("onChangeOrientation",v),d=!1},w=v=>{t("resetMainAreaSize",v)},_=()=>{const v=h.value-l;l+=v,!d&&!g&&t("onSliceChange",v),d=!1,g=!1};document.addEventListener("keydown",v=>{v.key==="ArrowUp"&&l>0&&(l-=1,S(),t("onSliceChange",-1)),v.key==="ArrowDown"&&l<e.max&&(l+=1,S(),t("onSliceChange",1))});const S=()=>{h.value=l};return U(()=>{l=i.value*a.value+n.value,S()}),U(()=>{o!=null&&o.value&&(l=(o==null?void 0:o.value)*a.value),S()}),(v,r)=>{const I=T("el-slider");return B(),V("div",yt,[C("div",Ct,[M(I,{modelValue:h.value,"onUpdate:modelValue":r[0]||(r[0]=y=>h.value=y),max:A(e).max,onInput:_,"show-input":""},null,8,["modelValue","max"]),C("div",wt,[C("span",{onClick:r[1]||(r[1]=y=>w(.5))},It),C("span",{onClick:r[2]||(r[2]=y=>w(-.5))},Dt),C("span",{onClick:r[3]||(r[3]=y=>u("x"))},At),C("span",{onClick:r[4]||(r[4]=y=>u("z"))},zt),C("span",{onClick:r[5]||(r[5]=y=>u("y"))},kt),C("span",{onClick:p},Nt)])])])}}});const Ft=J(Et,[["__scopeId","data-v-4ab276ea"]]),K=f=>(j("data-v-82614724"),f=f(),G(),f),Wt=K(()=>C("div",{class:"el-upload__text"},[pt(" Drop file here or "),C("em",null,"click to upload")],-1)),Ht=K(()=>C("div",{class:"el-upload__tip"},"Please drag or upload NRRD files!",-1)),Rt=X({__name:"Upload",props:{dialog:{type:Boolean,default:!1}},emits:["onCloseDialog","getLoadFilesUrls"],setup(f,{emit:t}){let e=[],s=[],i=!1;const n=d=>{let g=d.currentTarget,p=d.target;g===p&&(e.forEach(u=>{const w=URL.createObjectURL(u);s.push(w)}),t("getLoadFilesUrls",s),t("onCloseDialog",!1),i=!0,o())},o=()=>{e=[],s.forEach(d=>{URL.revokeObjectURL(d)}),s=[]},a=d=>{i&&(i=!1,o());let g=d.name,p;g.match(/\.(nrrd)$/)&&(p=d.raw,e.push(p)),p||l("No .nrrd asset found!")},h=d=>{e=e.filter(g=>g.name!==d.name),console.log(e)},l=d=>{let g=(d||{}).message||d.toString();g.match(/ProgressEvent/)?g="Unable to retrieve this file. Check JS console and browser network tab.":g.match(/Unexpected token/)?g=`Unable to parse file content. Verify that this file is valid. Error: "${g}"`:d&&d.target&&d.target instanceof Image&&(g="Missing texture: "+d.target.src.split("/").pop()),window.alert(g),console.error(d)};return(d,g)=>{const p=T("el-icon"),u=T("el-upload");return f.dialog?(B(),V("div",{key:0,onClick:n,class:"upload_container"},[M(u,{"auto-upload":!1,onChange:a,onRemove:h,class:"upload-demo",drag:"",action:"/",multiple:""},{tip:R(()=>[Ht]),default:R(()=>[M(p,{class:"el-icon--upload"},{default:R(()=>[M(A(mt))]),_:1}),Wt]),_:1})])):_t("",!0)}}});const Yt=J(Rt,[["__scopeId","data-v-82614724"]]),Ut={id:"bg",ref:"base_container"},$t=X({__name:"example13_segmentation_CS",setup(f){let t=null,e,s=P(0),i=P(0),n=P(0),o=P(!1),a=P(0),h,l=P(null),d=P(null),g=P(null),p=P(),u=new dt({width:300,autoPlace:!1}),w,_,S,v=[],r=P(0),I=!0,y=[],L=P(0);vt(()=>{let{$refs:m}=xt().proxy;t=m,l=t.base_container,d=m.c_gui,g=m.nrrd_c,d.appendChild(u.domElement),e=new ht(l),S=ot(),_=new ft(g),g.appendChild(S.loadingContainer),Q("nrrd_tools"),document.addEventListener("keydown",b=>{b.code==="KeyF"&&lt(l)}),w=u.addFolder("select display contrast"),e.animate()});const W=m=>{L.value=m.length,v=m,v.length>0&&tt(v)},E=m=>{o.value=m},z=m=>{o.value=m},O=m=>{_.setSliceOrientation(m),s.value=_.getMaxSliceNum()[1];const{currentIndex:b,contrastIndex:x}=_.getCurrentSlicesNumAndContrastNum();i.value=b,n.value=x},Z=m=>{_.setSliceMoving(m)};U(()=>{if(r.value!=0&&y.length!=0&&r.value===v.length){console.log("All files ready!"),_.clear(),y.sort((x,D)=>x.order-D.order),_.setShowInMainArea(!0),_.setAllSlices(y),a.value=_.getCurrentSliceIndex();const m=(x,D)=>{i.value=x,n.value=D};I?(_.drag({showNumber:!0,getSliceNum:m}),_.draw(h,u),h==null||h.addPreRenderCallbackFunction(_.start)):_.redrawMianPreOnDisplayCanvas(),s.value=_.getMaxSliceNum()[1],setTimeout(()=>{a.value=0,r.value=0},1e3),I=!1;const b={};for(let x=0;x<y.length;x++)if(x==0)b.pre=!0;else{const D="contrast"+x;b[D]=!0}_.removeGuiFolderChilden(w);for(let x=0;x<y.length;x++){let D="";x===0?D="pre":D="contrast"+x,w.add(b,D).onChange(F=>{F?(L.value+=1,_.addSkip(x)):(L.value-=1,_.removeSkip(x));const k=_.getMaxSliceNum()[1];if(k){s.value=k;const{currentIndex:H,contrastIndex:et}=_.getCurrentSlicesNumAndContrastNum();i.value=H,n.value=et+1}})}}});const q=m=>{_.setMainAreaSize(m)};function Q(m){h=e.getSceneByName(m),h==null&&(h=e.createScene(m),h&&(e.setCurrentScene(h),h&&h.loadViewUrl("/copper3d_examples/nrrd_view.json"),ct("/copper3d_examples/venice_sunset_1k.hdr"),h.updateBackground("#5454ad","#18e5a7")),e.updateEnvironment())}const tt=m=>{y=[];const b=(x,D,F)=>{const k=Object.assign(F,{order:0});y.push(k),p.value=F,r.value+=1};h==null||h.loadNrrd(m[0],S,b);for(let x=1;x<m.length;x++)h==null||h.loadNrrd(m[x],S,(D,F,k)=>{const H=Object.assign(k,{order:x});y.push(H),r.value+=1})};return(m,b)=>(B(),V("div",Ut,[C("div",{ref_key:"c_gui",ref:d,id:"gui"},null,512),C("div",{ref_key:"nrrd_c",ref:g,class:"nrrd_c"},null,512),M(Ft,{"file-num":A(L),max:A(s),"immediate-slice-num":A(i),"contrast-index":A(n),"init-slice-index":A(a),onOnSliceChange:Z,onResetMainAreaSize:q,onOnChangeOrientation:O,onOnOpenDialog:E},null,8,["file-num","max","immediate-slice-num","contrast-index","init-slice-index"]),M(Yt,{dialog:A(o),onOnCloseDialog:z,onGetLoadFilesUrls:W},null,8,["dialog"])],512))}});export{$t as default};
