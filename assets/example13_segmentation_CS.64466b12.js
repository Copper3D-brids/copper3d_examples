var Q=Object.defineProperty;var ee=(g,e,t)=>e in g?Q(g,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[e]=t;var d=(g,e,t)=>(ee(g,typeof e!="symbol"?e+"":e,t),t);import{V as te,t as $,G as se,c as ie,l as ae,f as ne,s as re}from"./index.34d4f25b.js";import{d as T,j as de,t as he,r as C,w as H,c as U,a as m,k as M,l as O,m as z,o as V,p as Y,b as R,_ as F,n as W,q as le,s as oe,v as ce,e as ge,g as ue}from"./index.7bb59f15.js";import"./___vite-browser-external_commonjs-proxy.cfb8bb19.js";class me{constructor(e){d(this,"container");d(this,"paintImages",{x:[],y:[],z:[]});d(this,"allSlicesArray",[]);d(this,"displaySlices",[]);d(this,"axis","z");d(this,"mainAreaContainer",document.createElement("div"));d(this,"showDragNumberDiv",document.createElement("div"));d(this,"drawingCanvas",document.createElement("canvas"));d(this,"displayCanvas",document.createElement("canvas"));d(this,"downloadCanvas",document.createElement("canvas"));d(this,"downloadImage",document.createElement("a"));d(this,"drawingCanvasLayerOne",document.createElement("canvas"));d(this,"currentShowingSlice");d(this,"displayCtx");d(this,"drawingCtx");d(this,"drawingLayerOneCtx");d(this,"originCanvas");d(this,"mainPreSlice");d(this,"sceneIn");d(this,"Is_Shift_Pressed",!1);d(this,"Is_Draw",!1);d(this,"sensitiveArray",[]);d(this,"handleWheelMove",()=>{});d(this,"start",()=>{});d(this,"paintedImage");d(this,"previousDrawingImage",new Image);d(this,"undoArray",[]);d(this,"nrrd_states",{originWidth:0,originHeight:0,changedWidth:0,changedHeight:0,oldIndex:0,maxIndex:0,minIndex:0,contrastNum:0,Max_sensitive:100,readyToUpdate:!0,showContrast:!1,Mouse_Over_x:0,Mouse_Over_y:0,Mouse_Over:!1,stepClear:1,drawStartPos:new te(1,1)});d(this,"gui_states",{mainAreaSize:1,dragSensitivity:50,Eraser:!1,globalAlpha:.3,lineWidth:2,color:"#f50a33",segmentation:!1,fillColor:"#3fac58",brushColor:"#3fac58",brushAndEraserSize:15,clearAll:()=>{this.clearAllPaint()},undo:()=>{this.undoLastPainting()},downloadCurrentImage:()=>{this.enableDownload()},subView:!1,subViewScale:1,resetView:()=>{var e;(e=this.sceneIn)==null||e.resetView()}});this.container=e,this.displayCtx=this.displayCanvas.getContext("2d"),this.drawingCtx=this.drawingCanvas.getContext("2d"),this.drawingLayerOneCtx=this.drawingCanvasLayerOne.getContext("2d"),this.init()}init(){this.showDragNumberDiv=this.createShowSliceNumberDiv(),this.mainAreaContainer.classList.add("copper3D_drawingCanvasContainer"),this.container.appendChild(this.mainAreaContainer),this.autoFocusDiv(this.container),this.downloadImage.href="",this.downloadImage.target="_blank";for(let e=0;e<this.nrrd_states.Max_sensitive;e++)this.sensitiveArray.push((e+1)/20);this.container.addEventListener("keydown",e=>{e.key==="Shift"&&(this.Is_Shift_Pressed=!0)}),this.container.addEventListener("keyup",e=>{e.key==="Shift"&&(this.Is_Shift_Pressed=!1)})}setAllSlices(e){this.allSlicesArray=[...e],this.setDisplaySlicesBaseOnAxis(),this.afterLoadSlice()}setSliceOrientation(e){this.axis=e,this.setDisplaySlicesBaseOnAxis(),this.updateMaxIndex(),this.setOriginCanvasAndPre(),this.updateShowNumDiv(this.nrrd_states.contrastNum),this.repraintCurrentContrastSlice(),this.resizePaintArea(this.gui_states.mainAreaSize),this.resetPaintArea()}setSliceMoving(e){this.mainPreSlice&&(this.Is_Draw=!0,this.setSyncsliceNum(),this.updateIndex(e),this.setIsDrawFalse(1e3))}setShowInMainArea(e){this.nrrd_states.showContrast=e,this.nrrd_states.contrastNum=0,this.mainPreSlice&&(this.redrawMianPreOnDisplayCanvas(),this.updateShowNumDiv(this.nrrd_states.contrastNum))}setMainAreaSize(e){this.resizePaintArea(e),this.resetPaintArea(),this.setIsDrawFalse(1e3)}getMaxSliceNum(){return this.nrrd_states.showContrast?[this.nrrd_states.maxIndex,this.nrrd_states.maxIndex*this.displaySlices.length]:[this.nrrd_states.maxIndex]}getIsShowContrastState(){return this.nrrd_states.showContrast}setIsDrawFalse(e){setTimeout(()=>{this.Is_Draw=!1},e)}setDisplaySlicesBaseOnAxis(){this.displaySlices=[],this.allSlicesArray.forEach(e=>{this.displaySlices.push(e[this.axis])})}setOriginCanvasAndPre(){this.mainPreSlice=this.displaySlices[0],this.nrrd_states.oldIndex>this.nrrd_states.maxIndex&&(this.nrrd_states.oldIndex=this.nrrd_states.maxIndex),this.mainPreSlice.index=this.nrrd_states.oldIndex,this.originCanvas=this.mainPreSlice.canvas,this.updateOriginAndChangedWH()}afterLoadSlice(){this.setOriginCanvasAndPre(),this.currentShowingSlice=this.mainPreSlice,this.undoArray=[{sliceIndex:this.mainPreSlice.index,undos:[]}],this.nrrd_states.oldIndex=this.mainPreSlice.index,this.updateMaxIndex(),this.updateShowNumDiv(this.nrrd_states.contrastNum)}updateMaxIndex(){switch(this.axis){case"x":this.nrrd_states.maxIndex=this.mainPreSlice.volume.RASDimensions[0];break;case"y":this.nrrd_states.maxIndex=this.mainPreSlice.volume.RASDimensions[1];break;case"z":this.nrrd_states.maxIndex=this.mainPreSlice.volume.RASDimensions[2]-1;break}}updateCurrentContrastSlice(){return this.currentShowingSlice=this.displaySlices[this.nrrd_states.contrastNum],this.currentShowingSlice}createShowSliceNumberDiv(){const e=document.createElement("div");return e.className="copper3d_sliceNumber",e.style.position="absolute",e.style.zIndex="100",e.style.top="20px",e.style.left="100px",e}updateOriginAndChangedWH(){this.nrrd_states.originWidth=this.originCanvas.width,this.nrrd_states.originHeight=this.originCanvas.height,this.nrrd_states.changedWidth=this.originCanvas.width*Number(this.gui_states.mainAreaSize),this.nrrd_states.changedHeight=this.originCanvas.height*Number(this.gui_states.mainAreaSize)}initAllCanvas(){this.displayCanvas.style.position="absolute",this.displayCanvas.style.zIndex="9",this.displayCanvas.width=this.nrrd_states.changedWidth,this.displayCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.style.zIndex="10",this.drawingCanvas.style.position="absolute",this.drawingCanvas.width=this.nrrd_states.changedWidth,this.drawingCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.style.cursor="crosshair",this.drawingCanvas.oncontextmenu=()=>!1,this.displayCanvas.style.left=this.drawingCanvas.style.left="0px",this.displayCanvas.style.top=this.drawingCanvas.style.top="0px",this.drawingCanvasLayerOne.width=this.nrrd_states.changedWidth,this.drawingCanvasLayerOne.height=this.nrrd_states.changedHeight,this.mainAreaContainer.style.width=this.nrrd_states.changedWidth+"px",this.mainAreaContainer.style.height=this.nrrd_states.changedHeight+"px",this.mainAreaContainer.appendChild(this.displayCanvas),this.mainAreaContainer.appendChild(this.drawingCanvas)}autoFocusDiv(e){e.tabIndex=10,e.addEventListener("mouseover",()=>{e.focus()}),e.style.outline="none"}setSyncsliceNum(){this.displaySlices.forEach((e,t)=>{t!==0&&(e.index=this.mainPreSlice.index)})}repraintCurrentContrastSlice(){this.setSyncsliceNum(),this.displaySlices.forEach((e,t)=>{e.repaint.call(e)})}repraintAllContrastSlices(){this.displaySlices.forEach((e,t)=>{e.volume.repaintAllSlices()})}updateShowNumDiv(e){this.nrrd_states.showContrast?this.showDragNumberDiv.innerHTML=`ContrastNum: ${e}/${this.displaySlices.length-1} SliceNum: ${this.mainPreSlice.index}/${this.nrrd_states.maxIndex}`:this.showDragNumberDiv.innerHTML=`SliceNum: ${this.mainPreSlice.index}/${this.nrrd_states.maxIndex}`}appendLoadingbar(e){this.mainAreaContainer.appendChild(e)}drag(e){let t,i,s=this.container.offsetHeight,r=1,l,o,a;this.sensitiveArray.reverse(),e!=null&&e.showNumber&&this.container.appendChild(this.showDragNumberDiv),o=h=>{this.drawingCanvas.removeEventListener("wheel",this.handleWheelMove),h.button===0&&(this.setSyncsliceNum(),i=h.offsetY/s,this.container.addEventListener("pointermove",a,!1),this.nrrd_states.oldIndex=this.mainPreSlice.index,r=this.sensitiveArray[this.gui_states.dragSensitivity-1])},a=$(h=>{this.nrrd_states.oldIndex=this.mainPreSlice.index,i-h.offsetY/s>=0?t=-Math.ceil((i-h.offsetY/s)*10/r):t=-Math.floor((i-h.offsetY/s)*10/r),this.updateIndex(t),e!=null&&e.getSliceNum&&e.getSliceNum(this.mainPreSlice.index,this.nrrd_states.contrastNum),i=h.offsetY/s},r*200),l=h=>{this.drawingCanvas.addEventListener("wheel",this.handleWheelMove),this.setSyncsliceNum(),this.container.removeEventListener("pointermove",a,!1)};const v=()=>{this.container.style.cursor="pointer",this.container.addEventListener("pointerdown",o,!0),this.container.addEventListener("pointerup",l,!0)};v(),this.container.addEventListener("keydown",h=>{h.key==="Shift"&&(this.container.style.cursor="",this.container.removeEventListener("pointerdown",o,!0),this.container.removeEventListener("pointerup",l,!1),this.setIsDrawFalse(1e3))}),this.container.addEventListener("keyup",h=>{h.key==="Shift"&&v()})}updateIndex(e){var r;let t=0,i=0;this.nrrd_states.showContrast?(i=e%this.displaySlices.length,this.nrrd_states.contrastNum+=i,e>0?(t=Math.floor(e/this.displaySlices.length),this.nrrd_states.contrastNum>this.displaySlices.length-1&&(t+=1,this.nrrd_states.contrastNum-=this.displaySlices.length)):(t=Math.ceil(e/this.displaySlices.length),this.nrrd_states.contrastNum<0&&(this.nrrd_states.contrastNum+=this.displaySlices.length,t-=1))):t=e;let s=this.nrrd_states.oldIndex+t;if(s!=this.nrrd_states.oldIndex||this.nrrd_states.showContrast){if(s>this.nrrd_states.maxIndex)s=this.nrrd_states.maxIndex,this.nrrd_states.contrastNum=4;else if(s<this.nrrd_states.minIndex)s=this.nrrd_states.minIndex,this.nrrd_states.contrastNum=0;else{this.mainPreSlice.index=s,s!=this.nrrd_states.oldIndex&&(this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width),this.displayCanvas.width=this.displayCanvas.width,this.nrrd_states.changedWidth===0&&(this.nrrd_states.changedWidth=this.nrrd_states.originWidth,this.nrrd_states.changedHeight=this.nrrd_states.originHeight),this.nrrd_states.showContrast?this.repraintCurrentContrastSlice():this.mainPreSlice.repaint.call(this.mainPreSlice);const l=this.updateCurrentContrastSlice();this.displayCtx.drawImage(l.canvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),(this.paintImages.x.length>0||this.paintImages.y.length>0||this.paintImages.z.length>0)&&s!=this.nrrd_states.oldIndex&&(this.paintedImage=this.filterDrawedImage(this.axis,this.mainPreSlice.index),(r=this.paintedImage)!=null&&r.image&&this.drawingLayerOneCtx.drawImage(this.paintedImage.image,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight))}this.nrrd_states.oldIndex=this.mainPreSlice.index,this.updateShowNumDiv(this.nrrd_states.contrastNum)}}draw(e,t){let i,s;this.sceneIn=e,e.controls.enabled=!1,this.gui_states.subView===!1&&e.subDiv&&(e.subDiv.style.display="none"),i=t.addFolder("Mode Parameters"),e.subDiv&&(s=t.addFolder("Sub View"),s.add(this.gui_states,"resetView"),s.add(this.gui_states,"subView").onChange(r=>{r?(e.controls.enabled=!0,e.subDiv&&(e.subDiv.style.display="block")):(e.subDiv&&(e.subDiv.style.display="none"),e.controls.enabled=!1)}),s.add(this.gui_states,"subViewScale").min(.25).max(2).step(.01).onFinishChange(r=>{e.subDiv&&(e.subDiv.style.width=200*r+"px"),e.subDiv&&(e.subDiv.style.height=200*r+"px")})),this.paintOnCanvas(i)}paintOnCanvas(e){var c,y;let t=!1,i=!1,s=0,r=0,l=this.mainPreSlice.index,o=!1,a=[];this.updateOriginAndChangedWH(),this.initAllCanvas(),this.configGui(e),(c=this.displayCtx)==null||c.drawImage(this.originCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.previousDrawingImage.src=this.drawingCanvas.toDataURL(),this.handleWheelMove=this.configMouseWheel((y=this.sceneIn)==null?void 0:y.controls),this.drawingCanvas.addEventListener("wheel",this.handleWheelMove,{passive:!1});const v=$(n=>{this.drawingCanvas.style.cursor="grabbing",this.displayCanvas.style.left=this.drawingCanvas.style.left=n.clientX-s+"px",this.displayCanvas.style.top=this.drawingCanvas.style.top=n.clientY-r+"px"},80),h=n=>{this.nrrd_states.Mouse_Over_x=n.offsetX,this.nrrd_states.Mouse_Over_y=n.offsetY,this.nrrd_states.Mouse_Over_x===void 0&&(this.nrrd_states.Mouse_Over_x=n.clientX,this.nrrd_states.Mouse_Over_y=n.clientY),n.type==="mouseout"?(this.nrrd_states.Mouse_Over=!1,this.drawingCanvas.removeEventListener("mousemove",h)):n.type==="mouseover"&&(this.nrrd_states.Mouse_Over=!0,this.drawingCanvas.addEventListener("mousemove",h)),n.preventDefault()};this.drawingCanvas.addEventListener("mouseover",h),this.drawingCanvas.addEventListener("mouseout",h),this.drawingCanvas.addEventListener("pointerdown",n=>{if(t||i){this.drawingCanvas.removeEventListener("pointerup",f),this.drawingLayerOneCtx.closePath();return}if(l!==this.mainPreSlice.index&&(this.previousDrawingImage.src="",l=this.mainPreSlice.index),this.drawingCanvas.removeEventListener("wheel",this.handleWheelMove),n.button===0){if(!this.Is_Shift_Pressed)return;t=!0,a=[],o=!0,this.Is_Draw=!0,this.gui_states.Eraser?this.drawingCanvas.style.cursor="url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/4273/circular-cursor.png) 52 52, crosshair":this.drawingCanvas.style.cursor="crosshair",this.nrrd_states.drawStartPos.set(n.offsetX,n.offsetY),this.drawingLayerOneCtx.beginPath(),this.drawingCanvas.addEventListener("pointerup",f),this.drawingCanvas.addEventListener("pointermove",L)}else if(n.button===2){let P=parseInt(this.drawingCanvas.style.left),w=parseInt(this.drawingCanvas.style.top);s=n.clientX-P,r=n.clientY-w,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.addEventListener("pointerup",f),this.drawingCanvas.addEventListener("pointermove",v)}else return},!0);const I=this.useEraser(),L=n=>{this.Is_Draw=!0,o&&(this.gui_states.Eraser?(this.nrrd_states.stepClear=1,I(n.offsetX,n.offsetY,this.gui_states.brushAndEraserSize)):(a.push({x:n.offsetX,y:n.offsetY}),this.paintOnCanvasLayerOne(n.offsetX,n.offsetY)))},f=n=>{var P;if(n.button===0){if(this.Is_Shift_Pressed||o){if(t=!1,this.drawingLayerOneCtx.closePath(),this.drawingCanvas.removeEventListener("pointermove",L),!this.gui_states.Eraser&&this.gui_states.segmentation){this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width;const _=(P=this.filterDrawedImage(this.axis,this.mainPreSlice.index))==null?void 0:P.image;_&&(this.previousDrawingImage=_),this.drawingLayerOneCtx.drawImage(this.previousDrawingImage,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingLayerOneCtx.beginPath(),this.drawingLayerOneCtx.moveTo(a[0].x,a[0].y);for(let A=1;A<a.length;A++)this.drawingLayerOneCtx.lineTo(a[A].x,a[A].y);this.drawingLayerOneCtx.closePath(),this.drawingLayerOneCtx.lineWidth=1,this.drawingLayerOneCtx.fillStyle=this.gui_states.fillColor,this.drawingLayerOneCtx.fill()}this.previousDrawingImage.src=this.drawingCanvasLayerOne.toDataURL(),this.storeAllImages(),console.log(this.drawingCtx.getImageData(0,0,this.drawingCanvas.width,this.drawingCanvas.height)),o=!1;const w=this.getCurrentUndo(),p=this.drawingCanvasLayerOne.toDataURL(),D=new Image;if(D.src=p,w.length>0)w[0].undos.push(D);else{const _={sliceIndex:this.mainPreSlice.index,undos:[]};_.undos.push(D),this.undoArray.push(_)}}}else if(n.button===2)i=!1,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.removeEventListener("pointermove",v);else return;this.drawingCanvas.addEventListener("wheel",this.handleWheelMove,{passive:!1}),this.gui_states.segmentation||this.setIsDrawFalse(100)};this.drawingCanvas.addEventListener("pointerleave",()=>{o=!1,this.gui_states.segmentation&&this.setIsDrawFalse(1e3)}),this.start=()=>{this.nrrd_states.readyToUpdate?(this.drawingCtx.clearRect(0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingCtx.globalAlpha=this.gui_states.globalAlpha,this.Is_Draw?(this.drawingLayerOneCtx.lineCap="round",this.drawingLayerOneCtx.globalAlpha=1):this.Is_Shift_Pressed&&!this.gui_states.segmentation&&!this.gui_states.Eraser&&this.nrrd_states.Mouse_Over&&(this.drawingCtx.clearRect(0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingCtx.fillStyle=this.gui_states.brushColor,this.drawingCtx.beginPath(),this.drawingCtx.arc(this.nrrd_states.Mouse_Over_x,this.nrrd_states.Mouse_Over_y,this.gui_states.brushAndEraserSize/2+1,0,Math.PI*2),this.drawingCtx.strokeStyle=this.gui_states.brushColor,this.drawingCtx.stroke()),this.drawingCtx.drawImage(this.drawingCanvasLayerOne,0,0)):this.redrawDisplayCanvas()},document.addEventListener("keydown",n=>{(n.ctrlKey||n.metaKey)&&n.code==="KeyZ"&&this.undoLastPainting()})}undoLastPainting(){this.Is_Draw=!0,this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width,this.mainPreSlice.repaint.call(this.mainPreSlice);const e=this.getCurrentUndo();if(e.length>0){const t=e[0];if(t.undos.length===0)return;if(t.undos.pop(),t.undos.length>0){const i=t.undos[t.undos.length-1];this.drawingLayerOneCtx.drawImage(i,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight)}this.previousDrawingImage.src=this.drawingCanvasLayerOne.toDataURL(),this.storeAllImages(),this.setIsDrawFalse(1e3)}}getCurrentUndo(){return this.undoArray.filter(e=>e.sliceIndex===this.mainPreSlice.index)}configMouseWheel(e){let t=1;return s=>{this.Is_Shift_Pressed||(s.preventDefault(),this.Is_Draw=!0,s.deltaY<0?t+=.1:s.deltaY>0&&(t-=.1),t>=8?t=8:t<=1&&(t=1),this.resizePaintArea(t),this.resetPaintArea(),e&&(e.enabled=!1),this.setIsDrawFalse(1e3))}}useEraser(){const e=(t,i,s)=>{var r=s-this.nrrd_states.stepClear,l=Math.sqrt(s*s-r*r),o=t-r,a=i-l,v=2*r,h=2*l;this.nrrd_states.stepClear<=s&&(this.drawingLayerOneCtx.clearRect(o,a,v,h),this.nrrd_states.stepClear+=1,e(t,i,s))};return e}clearAllPaint(){this.Is_Draw=!0,this.drawingCanvasLayerOne.width=this.drawingCanvas.width,this.originCanvas.width=this.originCanvas.width,this.mainPreSlice.repaint.call(this.mainPreSlice),this.previousDrawingImage.src="",this.storeAllImages(),this.setIsDrawFalse(1e3)}enableDownload(){this.downloadImage.download=`slice_${this.axis}_#${this.mainPreSlice.index}`;const e=this.downloadCanvas.getContext("2d");this.downloadCanvas.width=this.nrrd_states.originWidth,this.downloadCanvas.height=this.nrrd_states.originHeight,e.drawImage(this.displayCanvas,0,0,this.nrrd_states.originWidth,this.nrrd_states.originHeight),e.drawImage(this.drawingCanvas,0,0,this.nrrd_states.originWidth,this.nrrd_states.originHeight),this.downloadImage.href=this.downloadCanvas.toDataURL(),this.downloadImage.click()}paintOnCanvasLayerOne(e,t){this.drawingLayerOneCtx.beginPath(),this.drawingLayerOneCtx.moveTo(this.nrrd_states.drawStartPos.x,this.nrrd_states.drawStartPos.y),this.gui_states.segmentation?(this.drawingLayerOneCtx.strokeStyle=this.gui_states.color,this.drawingLayerOneCtx.lineWidth=this.gui_states.lineWidth):(this.drawingLayerOneCtx.strokeStyle=this.gui_states.brushColor,this.drawingLayerOneCtx.lineWidth=this.gui_states.brushAndEraserSize),this.drawingLayerOneCtx.lineTo(e,t),this.drawingLayerOneCtx.stroke(),this.nrrd_states.drawStartPos.set(e,t),this.drawingLayerOneCtx.closePath(),this.mainPreSlice.mesh.material.map.needsUpdate=!0}configGui(e){e.__controllers.length>0&&this.removeModeChilden(e),e.add(this.gui_states,"dragSensitivity").min(1).max(this.nrrd_states.Max_sensitive).step(1),e.add(this.gui_states,"mainAreaSize").min(1).max(8).onFinishChange(s=>{this.resetPaintArea(),this.resizePaintArea(s)}),e.add(this.gui_states,"globalAlpha").min(.1).max(1).step(.01),e.add(this.gui_states,"brushAndEraserSize").min(5).max(50).step(1),e.addColor(this.gui_states,"brushColor"),e.add(this.gui_states,"Eraser").onChange(s=>{this.gui_states.Eraser=s,this.gui_states.Eraser?this.drawingCanvas.style.cursor="url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/4273/circular-cursor.png) 52 52, crosshair":this.drawingCanvas.style.cursor="crosshair"}),e.add(this.gui_states,"clearAll"),e.add(this.gui_states,"undo"),e.add(this.gui_states,"downloadCurrentImage");const t=e.addFolder("segmentation");t.add(this.gui_states,"segmentation"),t.add(this.gui_states,"lineWidth").name("outerLineWidth").min(1.7).max(3).step(.01),t.addColor(this.gui_states,"color"),t.addColor(this.gui_states,"fillColor");const i=e.addFolder("contrast");i.open(),i.add(this.mainPreSlice.volume,"lowerThreshold",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Lower Threshold").onChange(s=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(s,"lowerThreshold")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),i.add(this.mainPreSlice.volume,"upperThreshold",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Upper Threshold").onChange(s=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(s,"upperThreshold")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),i.add(this.mainPreSlice.volume,"windowLow",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Window Low").onChange(s=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(s,"windowLow")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),i.add(this.mainPreSlice.volume,"windowHigh",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Window High").onChange(s=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(s,"windowHigh")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0})}updateSlicesContrast(e,t){switch(t){case"lowerThreshold":this.displaySlices.forEach((i,s)=>{s!==0&&(i.volume.lowerThreshold=e)});break;case"upperThreshold":this.displaySlices.forEach((i,s)=>{s!==0&&(i.volume.upperThreshold=e)});break;case"windowLow":this.displaySlices.forEach((i,s)=>{s!==0&&(i.volume.windowLow=e)});break;case"windowHigh":this.displaySlices.forEach((i,s)=>{s!==0&&(i.volume.windowHigh=e)});break}this.repraintCurrentContrastSlice()}resetPaintArea(){this.displayCanvas.style.left=this.drawingCanvas.style.left="0px",this.displayCanvas.style.top=this.drawingCanvas.style.top="0px"}redrawDisplayCanvas(){var e;this.updateCurrentContrastSlice(),this.displayCanvas.width=this.displayCanvas.width,this.displayCanvas.height=this.displayCanvas.height,this.originCanvas.width=this.originCanvas.width,this.currentShowingSlice.repaint.call(this.currentShowingSlice),(e=this.displayCtx)==null||e.drawImage(this.currentShowingSlice.canvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight)}redrawMianPreOnDisplayCanvas(){var e;this.displayCanvas.width=this.displayCanvas.width,this.displayCanvas.height=this.displayCanvas.height,this.originCanvas.width=this.originCanvas.width,this.mainPreSlice.repaint.call(this.mainPreSlice),(e=this.displayCtx)==null||e.drawImage(this.originCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight)}resizePaintArea(e){var t,i,s;switch(this.originCanvas.width=this.originCanvas.width,this.displayCanvas.width=this.displayCanvas.width,this.drawingCanvas.width=this.drawingCanvas.width,this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width,this.nrrd_states.changedWidth=this.nrrd_states.originWidth*e,this.nrrd_states.changedHeight=this.nrrd_states.originHeight*e,this.displayCanvas.width=this.nrrd_states.changedWidth,this.displayCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.width=this.nrrd_states.changedWidth,this.drawingCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvasLayerOne.width=this.nrrd_states.changedWidth,this.drawingCanvasLayerOne.height=this.nrrd_states.changedHeight,this.mainAreaContainer.style.width=this.nrrd_states.changedWidth+"px",this.mainAreaContainer.style.height=this.nrrd_states.changedHeight+"px",this.redrawDisplayCanvas(),(t=this.paintedImage)!=null&&t.image,this.axis){case"x":this.paintImages.x.length>0?this.paintedImage=this.filterDrawedImage("x",this.mainPreSlice.index):this.paintedImage=void 0;break;case"y":this.paintImages.y.length>0?this.paintedImage=this.filterDrawedImage("y",this.mainPreSlice.index):this.paintedImage=void 0;break;case"z":this.paintImages.z.length>0?this.paintedImage=this.filterDrawedImage("z",this.mainPreSlice.index):this.paintedImage=void 0;break}(i=this.paintedImage)!=null&&i.image&&((s=this.drawingLayerOneCtx)==null||s.drawImage(this.paintedImage.image,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight))}filterDrawedImage(e,t){return this.paintImages[e].filter(i=>i.index===t)[0]}removeModeChilden(e){const t=e.__controllers;t.length>0&&t.forEach(i=>{setTimeout(()=>{e.remove(i)},100)})}storeAllImages(){var s,r,l;const e=new Image;e.src=this.drawingCanvasLayerOne.toDataURL();let t={index:this.mainPreSlice.index,image:e},i;switch(this.axis){case"x":i=this.filterDrawedImage("x",this.mainPreSlice.index),i?i.image=e:(s=this.paintImages.x)==null||s.push(t);break;case"y":i=this.filterDrawedImage("y",this.mainPreSlice.index),i?i.image=e:(r=this.paintImages.y)==null||r.push(t);break;case"z":i=this.filterDrawedImage("z",this.mainPreSlice.index),i?i.image=e:(l=this.paintImages.z)==null||l.push(t);break}}}const N=g=>(Y("data-v-749430a4"),g=g(),R(),g),ve={class:"nav"},pe={class:"content"},_e={class:"arrows"},we=N(()=>m("ion-icon",{name:"add-circle-outline"},null,-1)),Ce=[we],fe=N(()=>m("ion-icon",{name:"remove-circle-outline"},null,-1)),ye=[fe],xe=N(()=>m("ion-icon",{name:"chevron-back-circle-outline"},null,-1)),Se=[xe],Ie=N(()=>m("ion-icon",{name:"chevron-down-circle-outline"},null,-1)),Pe=[Ie],De=N(()=>m("ion-icon",{name:"chevron-forward-circle-outline"},null,-1)),Le=[De],be=N(()=>m("ion-icon",{name:"cloud-upload-outline"},null,-1)),Oe=[be],Ae=T({__name:"NavBar",props:{fileNum:null,min:{default:0},max:{default:160},immediateSliceNum:{default:0},contrastIndex:{default:0},isAxisClicked:{type:Boolean,default:!1}},emits:["onSliceChange","resetMainAreaSize","onChangeOrientation","onOpenDialog"],setup(g,{emit:e}){const t=g,i=de(t),{max:s,immediateSliceNum:r,contrastIndex:l,isAxisClicked:o}=he(i),a=C(0);let v=t.min,h=0,I=!1,L=0,f=1;const c=()=>{e("onOpenDialog",!0)},y=w=>{e("onChangeOrientation",w)},n=w=>{f+=w,f>8&&(f=8),f<1&&(f=1),e("resetMainAreaSize",f)},P=()=>{v>s.value&&(v=s.value);const w=a.value-v;e("onSliceChange",w),v+=w};return H(()=>{I?a.value=r.value*t.fileNum+l.value:a.value=r.value}),H(()=>{o.value||(s.value>h&&(a.value=a.value*t.fileNum,L!==0&&(I=!0),L++),s.value<h&&(a.value=Math.floor(a.value/t.fileNum),I=!1),v=a.value,h=s.value)}),(w,p)=>{const D=z("el-slider");return V(),U("div",ve,[m("div",pe,[M(D,{modelValue:a.value,"onUpdate:modelValue":p[0]||(p[0]=_=>a.value=_),max:O(t).max,onInput:P,"show-input":""},null,8,["modelValue","max"]),m("div",_e,[m("span",{onClick:p[1]||(p[1]=_=>n(.2))},Ce),m("span",{onClick:p[2]||(p[2]=_=>n(-.2))},ye),m("span",{onClick:p[3]||(p[3]=_=>y("x"))},Se),m("span",{onClick:p[4]||(p[4]=_=>y("z"))},Pe),m("span",{onClick:p[5]||(p[5]=_=>y("y"))},Le),m("span",{onClick:c},Oe)])])])}}});const Me=F(Ae,[["__scopeId","data-v-749430a4"]]),B=g=>(Y("data-v-77702cf5"),g=g(),R(),g),Ne=B(()=>m("div",{class:"el-upload__text"},[ce(" Drop file here or "),m("em",null,"click to upload")],-1)),Ee=B(()=>m("div",{class:"el-upload__tip"}," jpg/png files with a size less than 500kb ",-1)),ke=T({__name:"Upload",props:{dialog:{type:Boolean,default:!1}},emits:["onCloseDialog"],setup(g,{emit:e}){let t=[];const i=r=>{let l=r.currentTarget,o=r.target;l===o&&(console.log(t),e("onCloseDialog",!1))},s=r=>{console.log(1)};return(r,l)=>{const o=z("el-icon"),a=z("el-upload");return g.dialog?(V(),U("div",{key:0,onClick:i,class:"upload_container"},[M(a,{"auto-upload":!1,onChange:s,class:"upload-demo",drag:"",action:"/",multiple:""},{tip:W(()=>[Ee]),default:W(()=>[M(o,{class:"el-icon--upload"},{default:W(()=>[M(O(oe))]),_:1}),Ne]),_:1})])):le("",!0)}}});const We=F(ke,[["__scopeId","data-v-77702cf5"]]),He={id:"bg",ref:"base_container"},Ye=T({__name:"example13_segmentation_CS",setup(g){let e=null,t,i=C(0),s=C(0),r=C(0),l=C(!1),o=C(!1),a,v=C(null),h=C(null),I=C(null),L=C(),f=new se({width:300,autoPlace:!1}),c,y,n=C(!1),P=C(!1),w=C(!1),p=C(!1),D=C(!1),_=[];ge(()=>{let{$refs:u}=ue().proxy;e=u,v=e.base_container,h=u.c_gui,I=u.nrrd_c,h.appendChild(f.domElement),t=new ie(v),y=ae(),c=new me(I),I.appendChild(y.loadingContainer);const x=["/copper3d_examples/nrrd/segmentation/ax dyn pre.nrrd","/copper3d_examples/nrrd/segmentation/ax dyn 1st pass.nrrd","/copper3d_examples/nrrd/segmentation/ax dyn 2nd pass.nrrd","/copper3d_examples/nrrd/segmentation/ax dyn 3rd pass.nrrd","/copper3d_examples/nrrd/segmentation/ax dyn 4th pass.nrrd"];document.addEventListener("keydown",S=>{S.code==="KeyF"&&ne(v)});const b={showContrast:!1};f.add(b,"showContrast").onChange(S=>{c.setShowInMainArea(S),l.value=!1,S?i.value=c.getMaxSliceNum()[1]:i.value=c.getMaxSliceNum()[0]}),q(x,"nrrd_tools"),t.animate()});const A=u=>{o.value=u},X=u=>{o.value=u},j=u=>{console.log(L.value),c.setSliceOrientation(u);const x=c.getIsShowContrastState();l.value=!0,x?i.value=c.getMaxSliceNum()[1]:i.value=c.getMaxSliceNum()[0]},G=u=>{n.value&&P.value&&w.value&&p.value&&D.value&&c.setSliceMoving(u)};H(()=>{if(n.value&&P.value&&w.value&&p.value&&D.value){console.log("All files ready!"),_.sort((x,b)=>x.order-b.order),c.setAllSlices(_);const u=(x,b)=>{s.value=x,r.value=b};c.drag({showNumber:!0,getSliceNum:u}),c.draw(a,f),a==null||a.addPreRenderCallbackFunction(c.start),i.value=c.getMaxSliceNum()[0]}});const K=u=>{c.setMainAreaSize(u)};function q(u,x){if(a=t.getSceneByName(x),a==null){if(a=t.createScene(x),a){t.setCurrentScene(a);const b=(S,Z,E)=>{const k=Object.assign(E,{order:0});_.push(k),L.value=E,n.value=!0};if(a){a==null||a.loadNrrd(u[0],y,b);for(let S=1;S<5;S++)a==null||a.loadNrrd(u[S],y,(Z,E,k)=>{const J=Object.assign(k,{order:S});switch(_.push(J),S){case 1:P.value=!0;break;case 2:w.value=!0;break;case 3:p.value=!0;break;case 4:D.value=!0;break}});a.loadViewUrl("/copper3d_examples/nrrd_view.json")}re("/copper3d_examples/venice_sunset_1k.hdr"),a.updateBackground("#5454ad","#18e5a7")}t.updateEnvironment()}}return(u,x)=>(V(),U("div",He,[m("div",{ref_key:"c_gui",ref:h,id:"gui"},null,512),m("div",{ref_key:"nrrd_c",ref:I,class:"nrrd_c"},null,512),M(Me,{"file-num":5,max:O(i),"immediate-slice-num":O(s),"contrast-index":O(r),"is-axis-clicked":O(l),onOnSliceChange:G,onResetMainAreaSize:K,onOnChangeOrientation:j,onOnOpenDialog:A},null,8,["max","immediate-slice-num","contrast-index","is-axis-clicked"]),M(We,{dialog:O(o),onOnCloseDialog:X},null,8,["dialog"])],512))}});export{Ye as default};
