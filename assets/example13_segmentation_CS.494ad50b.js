var at=Object.defineProperty;var rt=(v,t,s)=>t in v?at(v,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):v[t]=s;var l=(v,t,s)=>(rt(v,typeof t!="symbol"?t+"":t,s),s);import{b as nt,F as dt,V as ht,t as $,G as ot,c as lt,l as ct,f as gt,s as ut}from"./index.29cc5e99.js";import{d as R,j as _t,t as mt,r as P,w as Y,c as V,a as f,k as N,l as z,m as X,o as B,p as j,b as G,_ as J,n as U,q as pt,s as xt,v as vt,e as ft}from"./index.6ff88fa9.js";import"./___vite-browser-external_commonjs-proxy.c56ed110.js";function T(v,t){if(nt)dt.exports.saveAs(v,t);else{var s=require("file-saver");s.saveAs(v,t)}}class yt{constructor(t){l(this,"container");l(this,"paintImages",{x:[],y:[],z:[]});l(this,"allSlicesArray",[]);l(this,"displaySlices",[]);l(this,"backUpDisplaySlices",[]);l(this,"skipSlicesDic",{});l(this,"axis","z");l(this,"mainAreaContainer",document.createElement("div"));l(this,"showDragNumberDiv",document.createElement("div"));l(this,"drawingCanvas",document.createElement("canvas"));l(this,"displayCanvas",document.createElement("canvas"));l(this,"downloadCanvas",document.createElement("canvas"));l(this,"emptyCanvas",document.createElement("canvas"));l(this,"downloadImage",document.createElement("a"));l(this,"drawingCanvasLayerOne",document.createElement("canvas"));l(this,"currentShowingSlice");l(this,"displayCtx");l(this,"drawingCtx");l(this,"emptyCtx");l(this,"drawingLayerOneCtx");l(this,"originCanvas");l(this,"mainPreSlice");l(this,"sceneIn");l(this,"Is_Shift_Pressed",!1);l(this,"Is_Draw",!1);l(this,"sensitiveArray",[]);l(this,"handleWheelMove",()=>{});l(this,"start",()=>{});l(this,"paintedImage");l(this,"previousDrawingImage");l(this,"undoArray",[]);l(this,"initState",!0);l(this,"preTimer");l(this,"nrrd_states",{originWidth:0,originHeight:0,nrrd_x:0,nrrd_y:0,nrrd_z:0,changedWidth:0,changedHeight:0,oldIndex:0,currentIndex:0,maxIndex:0,minIndex:0,RSARatio:0,RSARatioArray:[],dimensions:[],ratios:{x:1,y:1,z:1},sharedPlace:{x:[-1],y:[-1],z:[-1]},latestNotEmptyImg:new Image,contrastNum:0,Max_sensitive:100,readyToUpdate:!0,showContrast:!1,enableCursorChoose:!1,isCursorSelect:!1,cursorPageX:0,cursorPageY:0,Mouse_Over_x:0,Mouse_Over_y:0,Mouse_Over:!1,stepClear:1,sizeFoctor:1,defaultPaintCursor:"url(https://raw.githubusercontent.com/LinkunGao/copper3d-datasets/main/icons/dot.svg) 12 12,auto",drawStartPos:new ht(1,1)});l(this,"cursorPage",{x:{cursorPageX:0,cursorPageY:0,index:0,updated:!1},y:{cursorPageX:0,cursorPageY:0,index:0,updated:!1},z:{cursorPageX:0,cursorPageY:0,index:0,updated:!1}});l(this,"gui_states",{mainAreaSize:1,dragSensitivity:75,Eraser:!1,globalAlpha:.7,lineWidth:2,color:"#f50a33",segmentation:!0,fillColor:"#3fac58",brushColor:"#3fac58",brushAndEraserSize:15,cursor:"dot",clear:()=>{this.clearPaint()},clearAll:()=>{confirm("Are you sure remove annotations on All slice?")===!0&&(this.clearPaint(),this.clearStoreImages())},undo:()=>{this.undoLastPainting()},downloadCurrentMask:()=>{this.enableDownload()},resetZoom:()=>{this.nrrd_states.sizeFoctor=1,this.resizePaintArea(1),this.resetPaintArea()},subView:!1,subViewScale:1,resetView:()=>{var t;(t=this.sceneIn)==null||t.resetView()},exportMarks:()=>{this.exportData()}});l(this,"drawLine",(t,s,e,i)=>{this.drawingCtx.beginPath(),this.drawingCtx.moveTo(t,s),this.drawingCtx.lineTo(e,i),this.drawingCtx.strokeStyle=this.gui_states.color,this.drawingCtx.stroke()});this.container=t,this.displayCtx=this.displayCanvas.getContext("2d"),this.drawingCtx=this.drawingCanvas.getContext("2d"),this.emptyCtx=this.emptyCanvas.getContext("2d"),this.drawingLayerOneCtx=this.drawingCanvasLayerOne.getContext("2d"),this.previousDrawingImage=this.emptyCtx.createImageData(1,1),this.init()}init(){this.showDragNumberDiv=this.createShowSliceNumberDiv(),this.mainAreaContainer.classList.add("copper3D_drawingCanvasContainer"),this.container.appendChild(this.mainAreaContainer),this.autoFocusDiv(this.container),this.downloadImage.href="",this.downloadImage.target="_blank";for(let t=0;t<this.nrrd_states.Max_sensitive;t++)this.sensitiveArray.push((t+1)/20);this.container.addEventListener("keydown",t=>{t.key==="Shift"&&(this.Is_Shift_Pressed=!0,this.nrrd_states.enableCursorChoose=!1),t.key==="s"&&(this.Is_Draw=!1,this.nrrd_states.enableCursorChoose=!this.nrrd_states.enableCursorChoose)}),this.container.addEventListener("keyup",t=>{t.key==="Shift"&&(this.Is_Shift_Pressed=!1)})}setAllSlices(t){this.allSlicesArray=[...t],this.nrrd_states.nrrd_x=this.allSlicesArray[0].z.canvas.width,this.nrrd_states.nrrd_y=this.allSlicesArray[0].z.canvas.height,this.nrrd_states.nrrd_z=this.allSlicesArray[0].x.canvas.width,this.nrrd_states.dimensions=this.allSlicesArray[0].x.volume.dimensions,this.nrrd_states.RSARatioArray=this.allSlicesArray[0].x.volume.spacing,this.allSlicesArray.forEach((s,e)=>{s.x.contrastOrder=e,s.y.contrastOrder=e,s.z.contrastOrder=e}),this.nrrd_states.ratios.x=this.nrrd_states.nrrd_x/this.nrrd_states.dimensions[0],this.nrrd_states.ratios.y=this.nrrd_states.nrrd_y/this.nrrd_states.dimensions[1],this.nrrd_states.ratios.z=this.nrrd_states.nrrd_z/this.nrrd_states.dimensions[2],this.nrrd_states.sharedPlace.x=this.getSharedPlace(this.nrrd_states.dimensions[0],this.nrrd_states.ratios.x),this.nrrd_states.sharedPlace.y=this.getSharedPlace(this.nrrd_states.dimensions[1],this.nrrd_states.ratios.y),this.nrrd_states.sharedPlace.z=this.getSharedPlace(this.nrrd_states.dimensions[2],this.nrrd_states.ratios.z),console.log(this.nrrd_states.sharedPlace),this.initPaintImages(this.nrrd_states.dimensions),this.setDisplaySlicesBaseOnAxis(),this.afterLoadSlice()}getSharedPlace(t,s){let e=-1,i=[],r=new Set;for(let h=0;h<t;h++){const a=Math.floor(h*s);a===e?(r.add(h-1),r.add(h)):e=a}return r.forEach(h=>{i.push(h)}),i}initPaintImages(t){for(let s=0;s<t[0];s++){const e=this.emptyCtx.createImageData(this.nrrd_states.nrrd_z,this.nrrd_states.nrrd_y),i={index:s,image:e};this.paintImages.x.push(i)}for(let s=0;s<t[1];s++){const e=this.emptyCtx.createImageData(this.nrrd_states.nrrd_x,this.nrrd_states.nrrd_z),i={index:s,image:e};this.paintImages.y.push(i)}for(let s=0;s<t[2];s++){const e=this.emptyCtx.createImageData(this.nrrd_states.nrrd_x,this.nrrd_states.nrrd_y),i={index:s,image:e};this.paintImages.z.push(i)}}setSliceOrientation(t){this.nrrd_states.enableCursorChoose&&(this.axis==="z"?(this.cursorPage.z.index=this.nrrd_states.currentIndex,this.cursorPage.z.cursorPageX=this.nrrd_states.cursorPageX,this.cursorPage.z.cursorPageY=this.nrrd_states.cursorPageY):this.axis==="x"?(this.cursorPage.x.index=this.nrrd_states.currentIndex,this.cursorPage.x.cursorPageX=this.nrrd_states.cursorPageX,this.cursorPage.x.cursorPageY=this.nrrd_states.cursorPageY):this.axis==="y"&&(this.cursorPage.y.index=this.nrrd_states.currentIndex,this.cursorPage.y.cursorPageX=this.nrrd_states.cursorPageX,this.cursorPage.y.cursorPageY=this.nrrd_states.cursorPageY),t==="z"?this.nrrd_states.isCursorSelect&&!this.cursorPage.z.updated?(this.axis==="x"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.x.cursorPageX/this.nrrd_states.nrrd_z*this.nrrd_states.dimensions[2]),this.nrrd_states.cursorPageX=Math.ceil(this.cursorPage.x.index/this.nrrd_states.dimensions[0]*this.nrrd_states.nrrd_x)),this.axis==="y"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.y.cursorPageY/this.nrrd_states.nrrd_z*this.nrrd_states.dimensions[2]),this.nrrd_states.cursorPageY=Math.ceil(this.cursorPage.y.index/this.nrrd_states.dimensions[1]*this.nrrd_states.nrrd_y)),this.cursorPage.z.updated=!0):(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=this.cursorPage.z.index,this.nrrd_states.cursorPageX=this.cursorPage.z.cursorPageX,this.nrrd_states.cursorPageY=this.cursorPage.z.cursorPageY):t==="x"?this.nrrd_states.isCursorSelect&&!this.cursorPage.x.updated?(this.axis==="z"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.z.cursorPageX/this.nrrd_states.nrrd_x*this.nrrd_states.dimensions[0]),this.nrrd_states.cursorPageX=Math.floor(this.cursorPage.z.index/this.nrrd_states.dimensions[2]*this.nrrd_states.nrrd_z)),this.axis==="y"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.y.cursorPageX/this.nrrd_states.nrrd_y*this.nrrd_states.dimensions[1]),this.nrrd_states.cursorPageX=this.cursorPage.y.cursorPageY,this.nrrd_states.cursorPageY=Math.ceil(this.cursorPage.y.index/this.nrrd_states.dimensions[1]*this.nrrd_states.nrrd_y)),this.cursorPage.x.updated=!0):(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=this.cursorPage.x.index,this.nrrd_states.cursorPageX=this.cursorPage.x.cursorPageX,this.nrrd_states.cursorPageY=this.cursorPage.x.cursorPageY):t==="y"&&(this.nrrd_states.isCursorSelect&&!this.cursorPage.y.updated?(this.axis==="z"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.z.cursorPageY/this.nrrd_states.nrrd_y*this.nrrd_states.dimensions[1]),this.nrrd_states.cursorPageY=Math.ceil(this.cursorPage.z.index/this.nrrd_states.dimensions[2]*this.nrrd_states.nrrd_z)),this.axis==="x"&&(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.x.cursorPageY/this.nrrd_states.nrrd_x*this.nrrd_states.dimensions[0]),this.nrrd_states.cursorPageX=Math.ceil(this.cursorPage.x.index/this.nrrd_states.dimensions[0]*this.nrrd_states.nrrd_x),this.nrrd_states.cursorPageY=this.cursorPage.x.cursorPageX),this.cursorPage.y.updated=!0):(this.nrrd_states.oldIndex=this.nrrd_states.currentIndex=this.cursorPage.y.index,this.nrrd_states.cursorPageX=this.cursorPage.y.cursorPageX,this.nrrd_states.cursorPageY=this.cursorPage.y.cursorPageY)),this.cursorPage.x.updated&&this.cursorPage.y.updated&&this.cursorPage.z.updated&&(this.nrrd_states.isCursorSelect=!1)),this.axis=t,this.resetDisplaySlicesStatus()}addSkip(t){this.skipSlicesDic[t]=this.backUpDisplaySlices[t],t>=this.displaySlices.length?this.nrrd_states.contrastNum=this.displaySlices.length:this.nrrd_states.contrastNum=t,this.resetDisplaySlicesStatus()}removeSkip(t){this.skipSlicesDic[t]=void 0,this.nrrd_states.contrastNum=0,this.resetDisplaySlicesStatus()}clear(){this.allSlicesArray.length=0,this.displaySlices.length=0,this.undoArray.length=0,this.paintImages.x.length=0,this.paintImages.y.length=0,this.paintImages.z.length=0,this.clearDictionary(this.skipSlicesDic),this.backUpDisplaySlices.length=0,this.mainPreSlice=void 0,this.currentShowingSlice=void 0,this.previousDrawingImage=this.emptyCtx.createImageData(1,1),this.initState=!0,this.axis="z",this.nrrd_states.sizeFoctor=1,this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width,this.drawingCanvas.width=this.drawingCanvas.width,this.displayCanvas.width=this.displayCanvas.width}setSliceMoving(t){this.mainPreSlice&&(this.Is_Draw=!0,this.setSyncsliceNum(),this.updateIndex(t),this.setIsDrawFalse(1e3))}setShowInMainArea(t){this.nrrd_states.showContrast=t,this.nrrd_states.contrastNum=0,this.mainPreSlice&&(this.redrawMianPreOnDisplayCanvas(),this.updateShowNumDiv(this.nrrd_states.contrastNum))}setMainAreaSize(t){this.nrrd_states.sizeFoctor+=t,this.nrrd_states.sizeFoctor>=8?this.nrrd_states.sizeFoctor=8:this.nrrd_states.sizeFoctor<=1&&(this.nrrd_states.sizeFoctor=1),this.resizePaintArea(this.nrrd_states.sizeFoctor),this.resetPaintArea(),this.setIsDrawFalse(1e3)}getMaxSliceNum(){return this.nrrd_states.showContrast?[this.nrrd_states.maxIndex,this.nrrd_states.maxIndex*this.displaySlices.length]:[this.nrrd_states.maxIndex]}getCurrentSlicesNumAndContrastNum(){return{currentIndex:this.nrrd_states.currentIndex,contrastIndex:this.nrrd_states.contrastNum}}getCurrentSliceIndex(){return Math.ceil(this.mainPreSlice.index)}getIsShowContrastState(){return this.nrrd_states.showContrast}setIsDrawFalse(t){this.preTimer=setTimeout(()=>{this.Is_Draw=!1,this.preTimer&&(window.clearTimeout(this.preTimer),this.preTimer=void 0)},t)}setDisplaySlicesBaseOnAxis(){this.displaySlices.length=0,this.backUpDisplaySlices.length=0,this.allSlicesArray.forEach(t=>{this.backUpDisplaySlices.push(t[this.axis])}),this.loadDisplaySlicesArray()}loadDisplaySlicesArray(){const t=Object.values(this.skipSlicesDic);t.length===0?this.backUpDisplaySlices.forEach((s,e)=>{this.skipSlicesDic[e]=s,this.displaySlices.push(s)}):t.forEach((s,e)=>{s&&(this.displaySlices.push(this.backUpDisplaySlices[e]),this.skipSlicesDic[e]=this.backUpDisplaySlices[e])})}resetDisplaySlicesStatus(){this.setDisplaySlicesBaseOnAxis(),this.setupConfigs()}setupConfigs(){this.setMainPreSlice(),this.updateMaxIndex(),this.setOriginCanvasAndPre(),this.updateShowNumDiv(this.nrrd_states.contrastNum),this.repraintCurrentContrastSlice(),this.resizePaintArea(this.nrrd_states.sizeFoctor),this.resetPaintArea()}setMainPreSlice(){this.mainPreSlice=this.displaySlices[0],this.mainPreSlice&&(this.nrrd_states.RSARatio=this.mainPreSlice.RSARatio)}setOriginCanvasAndPre(){this.mainPreSlice&&(this.nrrd_states.oldIndex>this.nrrd_states.maxIndex&&(this.nrrd_states.oldIndex=this.nrrd_states.maxIndex),this.initState?(this.nrrd_states.oldIndex=this.mainPreSlice.initIndex,this.nrrd_states.currentIndex=this.mainPreSlice.initIndex):this.mainPreSlice.index=this.nrrd_states.oldIndex,this.originCanvas=this.mainPreSlice.canvas,this.updateOriginAndChangedWH())}afterLoadSlice(){this.setMainPreSlice(),this.setOriginCanvasAndPre(),this.currentShowingSlice=this.mainPreSlice,this.undoArray=[{sliceIndex:this.mainPreSlice.index,undos:[]}],this.nrrd_states.oldIndex=this.mainPreSlice.initIndex,this.nrrd_states.currentIndex=this.mainPreSlice.initIndex,this.updateMaxIndex(),this.updateShowNumDiv(this.nrrd_states.contrastNum),this.initState=!1}updateMaxIndex(){this.mainPreSlice&&(this.nrrd_states.maxIndex=this.mainPreSlice.MaxIndex)}updateCurrentContrastSlice(){return this.currentShowingSlice=this.displaySlices[this.nrrd_states.contrastNum],this.currentShowingSlice}createShowSliceNumberDiv(){const t=document.createElement("div");return t.className="copper3d_sliceNumber",t.style.position="absolute",t.style.zIndex="100",t.style.top="20px",t.style.left="100px",t}updateOriginAndChangedWH(){this.nrrd_states.originWidth=this.originCanvas.width,this.nrrd_states.originHeight=this.originCanvas.height,this.nrrd_states.changedWidth=this.nrrd_states.originWidth*Number(this.gui_states.mainAreaSize),this.nrrd_states.changedHeight=this.nrrd_states.originWidth*Number(this.gui_states.mainAreaSize),this.resizePaintArea(1),this.resetPaintArea()}initAllCanvas(){this.displayCanvas.style.position="absolute",this.displayCanvas.style.zIndex="9",this.displayCanvas.width=this.nrrd_states.changedWidth,this.displayCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.style.zIndex="10",this.drawingCanvas.style.position="absolute",this.drawingCanvas.width=this.nrrd_states.changedWidth,this.drawingCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor,this.drawingCanvas.oncontextmenu=()=>!1,this.drawingCanvasLayerOne.width=this.nrrd_states.changedWidth,this.drawingCanvasLayerOne.height=this.nrrd_states.changedHeight,this.mainAreaContainer.style.width=this.nrrd_states.originWidth*8+"px",this.mainAreaContainer.style.height=this.nrrd_states.originHeight*8+"px",this.mainAreaContainer.appendChild(this.displayCanvas),this.mainAreaContainer.appendChild(this.drawingCanvas)}autoFocusDiv(t){t.tabIndex=10,t.addEventListener("mouseover",()=>{t.focus()}),t.style.outline="none"}setSyncsliceNum(){this.displaySlices.forEach((t,s)=>{s!==0&&(t.index=this.mainPreSlice.index)})}repraintCurrentContrastSlice(){this.setSyncsliceNum(),this.displaySlices.forEach((t,s)=>{t.repaint.call(t)})}repraintAllContrastSlices(){this.displaySlices.forEach((t,s)=>{t.volume.repaintAllSlices()})}updateShowNumDiv(t){this.mainPreSlice&&(this.nrrd_states.currentIndex>this.nrrd_states.maxIndex&&(this.nrrd_states.currentIndex=this.nrrd_states.maxIndex),this.nrrd_states.showContrast?this.showDragNumberDiv.innerHTML=`ContrastNum: ${t}/${this.displaySlices.length-1} SliceNum: ${this.nrrd_states.currentIndex}/${this.nrrd_states.maxIndex}`:this.showDragNumberDiv.innerHTML=`SliceNum: ${this.nrrd_states.currentIndex}/${this.nrrd_states.maxIndex}`)}appendLoadingbar(t){this.mainAreaContainer.appendChild(t)}drag(t){let s,e,i=this.container.offsetHeight,r=1,h,a,o;this.sensitiveArray.reverse(),t!=null&&t.showNumber&&this.container.appendChild(this.showDragNumberDiv),a=n=>{this.drawingCanvas.removeEventListener("wheel",this.handleWheelMove),n.button===0&&(this.setSyncsliceNum(),e=n.offsetY/i,this.container.addEventListener("pointermove",o,!1),r=this.sensitiveArray[this.gui_states.dragSensitivity-1])},o=$(n=>{e-n.offsetY/i>=0?s=-Math.ceil((e-n.offsetY/i)*10/r):s=-Math.floor((e-n.offsetY/i)*10/r),this.updateIndex(s),t!=null&&t.getSliceNum&&t.getSliceNum(this.nrrd_states.currentIndex,this.nrrd_states.contrastNum),e=n.offsetY/i},r*200),h=n=>{this.drawingCanvas.addEventListener("wheel",this.handleWheelMove),this.setSyncsliceNum(),this.container.removeEventListener("pointermove",o,!1)};const c=()=>{this.container.style.cursor="pointer",this.container.addEventListener("pointerdown",a,!0),this.container.addEventListener("pointerup",h,!0)};c(),this.container.addEventListener("keydown",n=>{n.key==="Shift"&&(this.container.style.cursor="",this.container.removeEventListener("pointerdown",a,!0),this.container.removeEventListener("pointerup",h,!1),this.setIsDrawFalse(1e3))}),this.container.addEventListener("keyup",n=>{n.key==="Shift"&&c()})}updateIndex(t){let s=0,e=0;this.nrrd_states.showContrast?(e=t%this.displaySlices.length,this.nrrd_states.contrastNum+=e,t>0?this.mainPreSlice.index<=this.nrrd_states.maxIndex?(s=Math.floor(t/this.displaySlices.length),this.nrrd_states.contrastNum>this.displaySlices.length-1&&(s+=1,this.nrrd_states.contrastNum-=this.displaySlices.length)):s=0:(s=Math.ceil(t/this.displaySlices.length),this.nrrd_states.contrastNum<0&&(this.nrrd_states.contrastNum+=this.displaySlices.length,s-=1))):s=t;let i=this.nrrd_states.oldIndex+s;if(i!=this.nrrd_states.oldIndex||this.nrrd_states.showContrast){if(i>this.nrrd_states.maxIndex)i=this.nrrd_states.maxIndex,this.nrrd_states.contrastNum=4;else if(i<this.nrrd_states.minIndex)i=this.nrrd_states.minIndex,this.nrrd_states.contrastNum=0;else{this.mainPreSlice.index=i,this.nrrd_states.currentIndex=i,i!=this.nrrd_states.oldIndex&&(this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width),this.displayCanvas.width=this.displayCanvas.width,this.nrrd_states.changedWidth===0&&(this.nrrd_states.changedWidth=this.nrrd_states.originWidth,this.nrrd_states.changedHeight=this.nrrd_states.originHeight);let r=this.updateCurrentContrastSlice();r.repaint.call(r),this.drawDragSlice(r.canvas,i)}this.nrrd_states.oldIndex=i,this.updateShowNumDiv(this.nrrd_states.contrastNum)}}drawDragSlice(t,s){var e;this.displayCtx.save(),this.flipDisplayImageByAxis(),this.displayCtx.drawImage(t,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.displayCtx.restore(),(this.paintImages.x.length>0||this.paintImages.y.length>0||this.paintImages.z.length>0)&&s!=this.nrrd_states.oldIndex&&(this.paintedImage=this.filterDrawedImage(this.axis,this.nrrd_states.currentIndex),(e=this.paintedImage)!=null&&e.image&&(this.emptyCanvas.width=this.nrrd_states.originWidth,this.emptyCanvas.height=this.nrrd_states.originHeight,this.emptyCtx.putImageData(this.paintedImage.image,0,0),this.drawingLayerOneCtx.drawImage(this.emptyCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight)))}draw(t,s){let e,i;this.sceneIn=t,t.controls.enabled=!1,this.gui_states.subView===!1&&t.subDiv&&(t.subDiv.style.display="none"),e=s.addFolder("Mode Parameters"),t.subDiv&&(i=s.addFolder("Sub View"),i.add(this.gui_states,"resetView"),i.add(this.gui_states,"subView").onChange(r=>{r?(t.controls.enabled=!0,t.subDiv&&(t.subDiv.style.display="block")):(t.subDiv&&(t.subDiv.style.display="none"),t.controls.enabled=!1)}),i.add(this.gui_states,"subViewScale").min(.25).max(2).step(.01).onFinishChange(r=>{t.subDiv&&(t.subDiv.style.width=200*r+"px"),t.subDiv&&(t.subDiv.style.height=200*r+"px")})),this.paintOnCanvas(e)}paintOnCanvas(t){var y,C,I,u;let s=!1,e=!1,i=0,r=0,h=this.mainPreSlice.index,a=!1,o=[];this.updateOriginAndChangedWH(),this.initAllCanvas(),this.configGui(t),(y=this.displayCtx)==null||y.save(),this.flipDisplayImageByAxis(),(C=this.displayCtx)==null||C.drawImage(this.originCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),(I=this.displayCtx)==null||I.restore(),this.previousDrawingImage=this.drawingCtx.getImageData(0,0,this.drawingCanvas.width,this.drawingCanvas.height),this.handleWheelMove=this.configMouseWheel((u=this.sceneIn)==null?void 0:u.controls),this.drawingCanvas.addEventListener("wheel",this.handleWheelMove,{passive:!1});const c=$(d=>{this.drawingCanvas.style.cursor="grabbing",this.displayCanvas.style.left=this.drawingCanvas.style.left=d.clientX-i+"px",this.displayCanvas.style.top=this.drawingCanvas.style.top=d.clientY-r+"px"},80),n=d=>{this.nrrd_states.Mouse_Over_x=d.offsetX,this.nrrd_states.Mouse_Over_y=d.offsetY,this.nrrd_states.Mouse_Over_x===void 0&&(this.nrrd_states.Mouse_Over_x=d.clientX,this.nrrd_states.Mouse_Over_y=d.clientY),d.type==="mouseout"?(this.nrrd_states.Mouse_Over=!1,this.drawingCanvas.removeEventListener("mousemove",n)):d.type==="mouseover"&&(this.nrrd_states.Mouse_Over=!0,this.drawingCanvas.addEventListener("mousemove",n)),d.preventDefault()};this.drawingCanvas.addEventListener("mouseover",n),this.drawingCanvas.addEventListener("mouseout",n),this.drawingCanvas.addEventListener("pointerdown",d=>{if(s||e){this.drawingCanvas.removeEventListener("pointerup",_),this.drawingLayerOneCtx.closePath();return}if(h!==this.mainPreSlice.index&&(this.previousDrawingImage=this.emptyCtx.createImageData(1,1),h=this.mainPreSlice.index),this.drawingCanvas.removeEventListener("wheel",this.handleWheelMove),d.button===0){if(this.Is_Shift_Pressed)s=!0,o=[],a=!0,this.Is_Draw=!0,this.gui_states.Eraser?this.drawingCanvas.style.cursor="url(https://raw.githubusercontent.com/LinkunGao/copper3d_icons/main/icons/circular-cursor.png) 52 52, crosshair":this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor,this.nrrd_states.drawStartPos.set(d.offsetX,d.offsetY),this.drawingLayerOneCtx.beginPath(),this.drawingCanvas.addEventListener("pointerup",_),this.drawingCanvas.addEventListener("pointermove",m);else if(this.nrrd_states.enableCursorChoose)switch(this.nrrd_states.cursorPageX=d.offsetX/this.nrrd_states.sizeFoctor,this.nrrd_states.cursorPageY=d.offsetY/this.nrrd_states.sizeFoctor,this.nrrd_states.isCursorSelect=!0,this.axis){case"x":this.cursorPage.x.updated=!0,this.cursorPage.y.updated=!1,this.cursorPage.z.updated=!1;break;case"y":this.cursorPage.x.updated=!1,this.cursorPage.y.updated=!0,this.cursorPage.z.updated=!1;break;case"z":this.cursorPage.x.updated=!1,this.cursorPage.y.updated=!1,this.cursorPage.z.updated=!0;break}}else if(d.button===2){e=!0;let S=parseInt(this.drawingCanvas.style.left),w=parseInt(this.drawingCanvas.style.top);i=d.clientX-S,r=d.clientY-w,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.addEventListener("pointerup",_),this.drawingCanvas.addEventListener("pointermove",c)}else return},!0);const g=this.useEraser(),m=d=>{this.Is_Draw=!0,a&&(this.gui_states.Eraser?(this.nrrd_states.stepClear=1,g(d.offsetX,d.offsetY,this.gui_states.brushAndEraserSize)):(o.push({x:d.offsetX,y:d.offsetY}),this.paintOnCanvasLayerOne(d.offsetX,d.offsetY)))},_=d=>{var S;if(d.button===0){if(this.Is_Shift_Pressed||a){if(s=!1,this.drawingLayerOneCtx.closePath(),this.drawingCanvas.removeEventListener("pointermove",m),!this.gui_states.Eraser&&this.gui_states.segmentation){this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width;const k=(S=this.filterDrawedImage(this.axis,this.nrrd_states.currentIndex))==null?void 0:S.image;k&&(this.previousDrawingImage=k),this.emptyCanvas.width=this.emptyCanvas.width,this.emptyCtx.putImageData(this.previousDrawingImage,0,0),this.drawingLayerOneCtx.drawImage(this.emptyCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingLayerOneCtx.beginPath(),this.drawingLayerOneCtx.moveTo(o[0].x,o[0].y);for(let O=1;O<o.length;O++)this.drawingLayerOneCtx.lineTo(o[O].x,o[O].y);this.drawingLayerOneCtx.closePath(),this.drawingLayerOneCtx.lineWidth=1,this.drawingLayerOneCtx.fillStyle=this.gui_states.fillColor,this.drawingLayerOneCtx.fill()}this.previousDrawingImage=this.drawingLayerOneCtx.getImageData(0,0,this.drawingCanvasLayerOne.width,this.drawingCanvasLayerOne.height),this.storeAllImages();const w=this.drawingCtx.getImageData(0,0,this.drawingCanvas.width,this.drawingCanvas.height);console.log("Paint mark data -----> :",w),a=!1;const F=this.getCurrentUndo(),b=this.drawingCanvasLayerOne.toDataURL(),A=new Image;if(A.src=b,F.length>0)F[0].undos.push(A);else{const k={sliceIndex:this.nrrd_states.currentIndex,undos:[]};k.undos.push(A),this.undoArray.push(k)}}}else if(d.button===2)e=!1,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.removeEventListener("pointermove",c);else return;this.drawingCanvas.addEventListener("wheel",this.handleWheelMove,{passive:!1}),this.gui_states.segmentation||this.setIsDrawFalse(100)};this.drawingCanvas.addEventListener("pointerleave",d=>{a=!1,s&&(s=!1,this.drawingLayerOneCtx.closePath(),this.drawingCanvas.removeEventListener("pointermove",m)),e&&(e=!1,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.removeEventListener("pointermove",c)),this.setIsDrawFalse(100),this.gui_states.segmentation&&this.setIsDrawFalse(1e3)}),this.start=()=>{if(this.nrrd_states.readyToUpdate){if(this.drawingCtx.clearRect(0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingCtx.globalAlpha=this.gui_states.globalAlpha,this.Is_Draw)this.drawingLayerOneCtx.lineCap="round",this.drawingLayerOneCtx.globalAlpha=1;else if(this.Is_Shift_Pressed&&!this.gui_states.segmentation&&!this.gui_states.Eraser&&this.nrrd_states.Mouse_Over&&(this.drawingCtx.clearRect(0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingCtx.fillStyle=this.gui_states.brushColor,this.drawingCtx.beginPath(),this.drawingCtx.arc(this.nrrd_states.Mouse_Over_x,this.nrrd_states.Mouse_Over_y,this.gui_states.brushAndEraserSize/2+1,0,Math.PI*2),this.drawingCtx.strokeStyle=this.gui_states.brushColor,this.drawingCtx.stroke()),this.nrrd_states.enableCursorChoose){this.drawingCtx.clearRect(0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight);const d=this.nrrd_states.cursorPageX*this.nrrd_states.sizeFoctor,S=this.nrrd_states.cursorPageY*this.nrrd_states.sizeFoctor;this.drawLine(d,0,d,this.drawingCanvas.height),this.drawLine(0,S,this.drawingCanvas.width,S)}this.drawingCtx.drawImage(this.drawingCanvasLayerOne,0,0)}else this.redrawDisplayCanvas()},document.addEventListener("keydown",d=>{(d.ctrlKey||d.metaKey)&&d.code==="KeyZ"&&this.undoLastPainting()})}undoLastPainting(){this.Is_Draw=!0,this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width,this.mainPreSlice.repaint.call(this.mainPreSlice);const t=this.getCurrentUndo();if(t.length>0){const s=t[0];if(s.undos.length===0)return;if(s.undos.pop(),s.undos.length>0){const e=s.undos[s.undos.length-1];this.drawingLayerOneCtx.drawImage(e,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight)}this.previousDrawingImage=this.drawingLayerOneCtx.getImageData(0,0,this.drawingCanvasLayerOne.width,this.drawingCanvasLayerOne.height),this.storeAllImages(),this.setIsDrawFalse(1e3)}}getCurrentUndo(){return this.undoArray.filter(t=>t.sliceIndex===this.nrrd_states.currentIndex)}configMouseWheel(t){let s=1;return i=>{if(this.Is_Shift_Pressed)return;i.preventDefault();const r=i.detail?i.detail>0:i.wheelDelta<0;this.Is_Draw=!0;const h=(i.clientX-this.mainAreaContainer.offsetLeft-this.drawingCanvas.offsetLeft)/this.drawingCanvas.offsetWidth,a=(i.clientY-this.mainAreaContainer.offsetTop-this.drawingCanvas.offsetTop)/this.drawingCanvas.offsetHeight,o=r?1-.1:1+.1,c=this.drawingCanvas.offsetWidth*o,n=this.drawingCanvas.offsetHeight*o,g=Math.round(i.clientX-this.mainAreaContainer.offsetLeft-c*h),m=Math.round(i.clientY-this.mainAreaContainer.offsetTop-n*a);s=c/this.nrrd_states.originWidth,s>8?s=8:s<1?s=1:(this.resizePaintArea(s),this.resetPaintArea(g,m),t&&(t.enabled=!1),this.setIsDrawFalse(1e3)),this.nrrd_states.sizeFoctor=s}}useEraser(){const t=(s,e,i)=>{var r=i-this.nrrd_states.stepClear,h=Math.sqrt(i*i-r*r),a=s-r,o=e-h,c=2*r,n=2*h;this.nrrd_states.stepClear<=i&&(this.drawingLayerOneCtx.clearRect(a,o,c,n),this.nrrd_states.stepClear+=1,t(s,e,i))};return t}clearPaint(){this.Is_Draw=!0,this.drawingCanvasLayerOne.width=this.drawingCanvas.width,this.originCanvas.width=this.originCanvas.width,this.mainPreSlice.repaint.call(this.mainPreSlice),this.previousDrawingImage=this.emptyCtx.createImageData(1,1),this.storeAllImages(),this.setIsDrawFalse(1e3)}clearStoreImages(){this.paintImages.x.length=0,this.paintImages.y.length=0,this.paintImages.z.length=0,this.initPaintImages(this.nrrd_states.dimensions)}enableDownload(){this.downloadImage.download=`slice_${this.axis}_#${this.nrrd_states.currentIndex}`;const t=this.downloadCanvas.getContext("2d");this.downloadCanvas.width=this.nrrd_states.originWidth,this.downloadCanvas.height=this.nrrd_states.originHeight,t.drawImage(this.drawingCanvas,0,0,this.nrrd_states.originWidth,this.nrrd_states.originHeight),this.downloadImage.href=this.downloadCanvas.toDataURL(),this.downloadImage.click()}paintOnCanvasLayerOne(t,s){this.drawingLayerOneCtx.beginPath(),this.drawingLayerOneCtx.moveTo(this.nrrd_states.drawStartPos.x,this.nrrd_states.drawStartPos.y),this.gui_states.segmentation?(this.drawingLayerOneCtx.strokeStyle=this.gui_states.color,this.drawingLayerOneCtx.lineWidth=this.gui_states.lineWidth):(this.drawingLayerOneCtx.strokeStyle=this.gui_states.brushColor,this.drawingLayerOneCtx.lineWidth=this.gui_states.brushAndEraserSize),this.drawingLayerOneCtx.lineTo(t,s),this.drawingLayerOneCtx.stroke(),this.nrrd_states.drawStartPos.set(t,s),this.drawingLayerOneCtx.closePath(),this.mainPreSlice.mesh.material.map.needsUpdate=!0}configGui(t){t.__controllers.length>0&&this.removeGuiFolderChilden(t),t.open();const s=t.addFolder("Default Actions");s.add(this.gui_states,"cursor",["crosshair","pencil","dot"]).name("cursor icons").onChange(a=>{a==="crosshair"&&(this.nrrd_states.defaultPaintCursor="crosshair"),a==="pencil"&&(this.nrrd_states.defaultPaintCursor="url(https://raw.githubusercontent.com/LinkunGao/copper3d_icons/main/icons/pencil-black.svg), auto"),a==="dot"&&(this.nrrd_states.defaultPaintCursor="url(https://raw.githubusercontent.com/LinkunGao/copper3d-datasets/main/icons/dot.svg) 12 12,auto"),this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor}),s.add(this.gui_states,"mainAreaSize").name("zoom").min(1).max(8).onFinishChange(a=>{this.resetPaintArea(),this.nrrd_states.sizeFoctor=a,this.resizePaintArea(a)}),s.add(this.gui_states,"resetZoom"),s.add(this.gui_states,"globalAlpha").name("opacity").min(.1).max(1).step(.01),s.add(this.gui_states,"segmentation").name("Pencil"),s.add(this.gui_states,"brushAndEraserSize").min(5).max(50).step(1),s.add(this.gui_states,"Eraser").onChange(a=>{this.gui_states.Eraser=a,this.gui_states.Eraser?this.drawingCanvas.style.cursor="url(https://raw.githubusercontent.com/LinkunGao/copper3d_icons/main/icons/circular-cursor.png) 52 52, crosshair":this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor}),s.add(this.gui_states,"clear"),s.add(this.gui_states,"clearAll"),s.add(this.gui_states,"undo"),s.add(this.mainPreSlice.volume,"windowHigh",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Image contrast").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"windowHigh")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),s.add(this.gui_states,"exportMarks");const e=t.addFolder("Advance settings");e.add(this.gui_states,"dragSensitivity").min(1).max(this.nrrd_states.Max_sensitive).step(1);const i=e.addFolder("Pencil settings");i.add(this.gui_states,"lineWidth").name("outerLineWidth").min(1.7).max(3).step(.01),i.addColor(this.gui_states,"color"),i.addColor(this.gui_states,"fillColor"),e.addFolder("Brush settings").addColor(this.gui_states,"brushColor"),e.add(this.gui_states,"downloadCurrentMask");const h=e.addFolder("contrast advance settings");h.add(this.mainPreSlice.volume,"lowerThreshold",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Lower Threshold").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"lowerThreshold")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),h.add(this.mainPreSlice.volume,"upperThreshold",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Upper Threshold").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"upperThreshold")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),h.add(this.mainPreSlice.volume,"windowLow",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Window Low").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"windowLow")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),s.open()}updateSlicesContrast(t,s){switch(s){case"lowerThreshold":this.displaySlices.forEach((e,i)=>{e.volume.lowerThreshold=t});break;case"upperThreshold":this.displaySlices.forEach((e,i)=>{e.volume.upperThreshold=t});break;case"windowLow":this.displaySlices.forEach((e,i)=>{e.volume.windowLow=t});break;case"windowHigh":this.displaySlices.forEach((e,i)=>{e.volume.windowHigh=t});break}this.repraintCurrentContrastSlice()}resetPaintArea(t,s){t&&s?(this.displayCanvas.style.left=this.drawingCanvas.style.left=t+"px",this.displayCanvas.style.top=this.drawingCanvas.style.top=s+"px"):(this.displayCanvas.style.left=this.drawingCanvas.style.left="",this.displayCanvas.style.top=this.drawingCanvas.style.top="",this.mainAreaContainer.style.justifyContent="center",this.mainAreaContainer.style.alignItems="center")}redrawDisplayCanvas(){var t,s,e;this.updateCurrentContrastSlice(),this.displayCanvas.width=this.displayCanvas.width,this.displayCanvas.height=this.displayCanvas.height,this.originCanvas.width=this.originCanvas.width,this.currentShowingSlice&&(this.currentShowingSlice.repaint.call(this.currentShowingSlice),(t=this.displayCtx)==null||t.save(),this.flipDisplayImageByAxis(),(s=this.displayCtx)==null||s.drawImage(this.currentShowingSlice.canvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),(e=this.displayCtx)==null||e.restore())}redrawMianPreOnDisplayCanvas(){var t;this.displayCanvas.width=this.displayCanvas.width,this.displayCanvas.height=this.displayCanvas.height,this.originCanvas.width=this.originCanvas.width,this.mainPreSlice&&(this.mainPreSlice.repaint.call(this.mainPreSlice),this.flipDisplayImageByAxis(),(t=this.displayCtx)==null||t.drawImage(this.originCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.resizePaintArea(this.nrrd_states.sizeFoctor))}resizePaintArea(t){var s,e;switch(this.originCanvas.width=this.originCanvas.width,this.displayCanvas.width=this.displayCanvas.width,this.drawingCanvas.width=this.drawingCanvas.width,this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width,this.nrrd_states.changedWidth=this.nrrd_states.originWidth*t,this.nrrd_states.changedHeight=this.nrrd_states.originHeight*t,this.displayCanvas.width=this.nrrd_states.changedWidth,this.displayCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.width=this.nrrd_states.changedWidth,this.drawingCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvasLayerOne.width=this.nrrd_states.changedWidth,this.drawingCanvasLayerOne.height=this.nrrd_states.changedHeight,this.redrawDisplayCanvas(),this.axis){case"x":this.paintImages.x.length>0?this.paintedImage=this.filterDrawedImage("x",this.nrrd_states.currentIndex):this.paintedImage=void 0;break;case"y":this.paintImages.y.length>0?this.paintedImage=this.filterDrawedImage("y",this.nrrd_states.currentIndex):this.paintedImage=void 0;break;case"z":this.paintImages.z.length>0?this.paintedImage=this.filterDrawedImage("z",this.nrrd_states.currentIndex):this.paintedImage=void 0;break}(s=this.paintedImage)!=null&&s.image&&(this.emptyCanvas.width=this.nrrd_states.originWidth,this.emptyCanvas.height=this.nrrd_states.originHeight,this.emptyCtx.putImageData(this.paintedImage.image,0,0),(e=this.drawingLayerOneCtx)==null||e.drawImage(this.emptyCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight))}flipDisplayImageByAxis(){var t,s,e,i;this.axis==="x"?((t=this.displayCtx)==null||t.scale(-1,-1),(s=this.displayCtx)==null||s.translate(-this.nrrd_states.changedWidth,-this.nrrd_states.changedHeight)):this.axis==="z"&&((e=this.displayCtx)==null||e.scale(1,-1),(i=this.displayCtx)==null||i.translate(0,-this.nrrd_states.changedHeight))}filterDrawedImage(t,s){return this.paintImages[t].filter(e=>e.index===s)[0]}removeGuiFolderChilden(t){const s=t.__controllers;s.length>0&&s.forEach(e=>{setTimeout(()=>{t.remove(e)},100)})}verifyCanvasIsEmpty(t){return this.emptyCanvas.width=t.width,this.emptyCanvas.height=t.height,t.toDataURL()===this.emptyCanvas.toDataURL()}clearDictionary(t){for(var s in t)delete t[s]}storeAllImages(){var i,r,h;this.emptyCanvas.width=this.nrrd_states.originWidth,this.emptyCanvas.height=this.nrrd_states.originHeight,this.emptyCtx.drawImage(this.drawingCanvasLayerOne,0,0,this.nrrd_states.originWidth,this.nrrd_states.originHeight);const t=this.emptyCtx.getImageData(0,0,this.emptyCanvas.width,this.emptyCanvas.height);switch(this.axis){case"x":const a=this.checkSharedPlaceSlice(this.nrrd_states.nrrd_x,this.nrrd_states.nrrd_y,t),o=this.sliceArrayV(a,this.nrrd_states.nrrd_y,this.nrrd_states.nrrd_z),c=this.sliceArrayH(a,this.nrrd_states.nrrd_y,this.nrrd_states.nrrd_z),n=Math.floor(this.nrrd_states.currentIndex/this.nrrd_states.dimensions[0]*this.nrrd_states.nrrd_x);this.replaceVerticalColPixels(this.paintImages.z,this.nrrd_states.dimensions[2],this.nrrd_states.ratios.z,o,this.nrrd_states.nrrd_x,n),this.replaceVerticalColPixels(this.paintImages.y,this.nrrd_states.dimensions[1],this.nrrd_states.ratios.y,c,this.nrrd_states.nrrd_x,n);break;case"y":const g=this.checkSharedPlaceSlice(this.nrrd_states.nrrd_x,this.nrrd_states.nrrd_y,t),m=this.sliceArrayV(g,this.nrrd_states.nrrd_z,this.nrrd_states.nrrd_x),_=this.sliceArrayH(g,this.nrrd_states.nrrd_z,this.nrrd_states.nrrd_x),y=Math.floor(this.nrrd_states.currentIndex/this.nrrd_states.dimensions[1]*this.nrrd_states.nrrd_y);this.replaceHorizontalRowPixels(this.paintImages.x,this.nrrd_states.dimensions[0],this.nrrd_states.ratios.x,m,this.nrrd_states.nrrd_z,y),this.replaceHorizontalRowPixels(this.paintImages.z,this.nrrd_states.dimensions[2],this.nrrd_states.ratios.z,_,this.nrrd_states.nrrd_x,y);break;case"z":const C=this.checkSharedPlaceSlice(this.nrrd_states.nrrd_x,this.nrrd_states.nrrd_y,t),I=this.sliceArrayV(C,this.nrrd_states.nrrd_y,this.nrrd_states.nrrd_x),u=this.sliceArrayH(C,this.nrrd_states.nrrd_y,this.nrrd_states.nrrd_x),d=Math.floor(this.nrrd_states.currentIndex/this.nrrd_states.dimensions[2]*this.nrrd_states.nrrd_z);this.replaceVerticalColPixels(this.paintImages.x,this.nrrd_states.dimensions[0],this.nrrd_states.ratios.x,I,this.nrrd_states.nrrd_z,d),this.replaceHorizontalRowPixels(this.paintImages.y,this.nrrd_states.dimensions[1],this.nrrd_states.ratios.y,u,this.nrrd_states.nrrd_x,d);break}let s={index:this.nrrd_states.currentIndex,image:t},e;switch(this.axis){case"x":e=this.filterDrawedImage("x",this.nrrd_states.currentIndex),e?e.image=t:(i=this.paintImages.x)==null||i.push(s);break;case"y":e=this.filterDrawedImage("y",this.nrrd_states.currentIndex),e?e.image=t:(r=this.paintImages.y)==null||r.push(s);break;case"z":e=this.filterDrawedImage("z",this.nrrd_states.currentIndex),e?e.image=t:(h=this.paintImages.z)==null||h.push(s);break}}sliceArrayH(t,s,e){const i=[];for(let r=0;r<s;r++){const h=r*e*4,a=(r+1)*e*4,o=t.slice(h,a);i.push(o)}return i}sliceArrayV(t,s,e){const i=[],r=e*4;for(let h=0;h<e;h++){const a=[];for(let o=0;o<s;o++){const c=r*o+h*4;a.push(t[c]),a.push(t[c+1]),a.push(t[c+2]),a.push(t[c+3])}i.push(a)}return i}replaceVerticalColPixels(t,s,e,i,r,h){for(let a=0,o=s;a<o;a++){const c=Math.floor(a*e),n=t[a].image.data,g=i[c],m=r*4;for(let _=0,y=g.length;_<y;_+=4){const C=_/4*m+h*4;n[C]=g[_],n[C+1]=g[_+1],n[C+2]=g[_+2],n[C+3]=g[_+3]}}}replaceHorizontalRowPixels(t,s,e,i,r,h){for(let a=0,o=s;a<o;a++){const c=Math.floor(a*e),n=t[a].image.data,g=i[c],m=r*h*4;for(let _=0,y=g.length;_<y;_++)n[m+_]=g[_]}}checkSharedPlaceSlice(t,s,e){let i=this.emptyCtx.createImageData(t,s).data;if(this.nrrd_states.sharedPlace.z.includes(this.nrrd_states.currentIndex)){const r=this.findSliceInSharedPlace();if(r.push(e),r.length>0)for(let h=0;h<r.length;h++)this.replaceArray(i,r[h].data)}else i=e.data;return i}replaceArray(t,s){for(let e=0,i=s.length;e<i;e++)s[e]===0||t[e]!==0||(t[e]=s[e])}findSliceInSharedPlace(){const t=[],s=Math.floor(this.nrrd_states.currentIndex*this.nrrd_states.ratios[this.axis]);for(let e=1;e<=3;e++){const i=this.nrrd_states.currentIndex-e;if(i<this.nrrd_states.minIndex)break;Math.floor(i*this.nrrd_states.ratios[this.axis])===s&&t.push(this.paintImages[this.axis][i].image)}for(let e=1;e<=3;e++){const i=this.nrrd_states.currentIndex+e;if(i>this.nrrd_states.maxIndex)break;Math.floor(i*this.nrrd_states.ratios[this.axis])===s&&t.push(this.paintImages[this.axis][i].image)}return t}exportData(){let t={x:[],y:[],z:[]};t.x=this.restructData(this.paintImages.x,this.paintImages.x.length),t.y=this.restructData(this.paintImages.y,this.paintImages.y.length),t.z=this.restructData(this.paintImages.z,this.paintImages.z.length),window.alert("Export all images, starting!!!");try{for(let s=0;s<3;s++)switch(s){case 0:const e=new Blob([JSON.stringify(t.x)],{type:"text/plain;charset=utf-8"});T(e,"copper3D_export data_x.json");break;case 1:const i=new Blob([JSON.stringify(t.y)],{type:"text/plain;charset=utf-8"});T(i,"copper3D_export data_y.json");break;case 2:const r=new Blob([JSON.stringify(t.z)],{type:"text/plain;charset=utf-8"});T(r,"copper3D_export data_z.json");break}window.alert("Export all images successfully!!!")}catch{window.alert("Export failed!")}}restructData(t,s){const e=[];for(let i=0;i<s;i++){let r={sliceIndex:0,dataFormat:"RGBA - Each successive 4-digit number forms a pixel point in data array",data:[]};r.sliceIndex=t[i].index;const h=[];for(let a=0;a<t[i].image.data.length;a++)h.push(t[i].image.data[a]);r.data=h,e.push(r)}return e}}const E=v=>(j("data-v-4ab276ea"),v=v(),G(),v),Ct={class:"nav"},wt={class:"content"},St={class:"arrows"},It=E(()=>f("ion-icon",{name:"add-circle-outline"},null,-1)),Pt=[It],Dt=E(()=>f("ion-icon",{name:"remove-circle-outline"},null,-1)),bt=[Dt],At=E(()=>f("ion-icon",{name:"chevron-back-circle-outline"},null,-1)),Lt=[At],zt=E(()=>f("ion-icon",{name:"chevron-down-circle-outline"},null,-1)),kt=[zt],Ot=E(()=>f("ion-icon",{name:"chevron-forward-circle-outline"},null,-1)),Mt=[Ot],Nt=E(()=>f("ion-icon",{name:"cloud-upload-outline"},null,-1)),Et=[Nt],Ft=R({__name:"NavBar",props:{fileNum:{default:0},min:{default:0},max:{default:160},initSliceIndex:null,immediateSliceNum:{default:0},contrastIndex:{default:0},isAxisClicked:{type:Boolean,default:!1}},emits:["onSliceChange","resetMainAreaSize","onChangeOrientation","onOpenDialog"],setup(v,{emit:t}){const s=v,e=_t(s),{immediateSliceNum:i,contrastIndex:r,initSliceIndex:h,fileNum:a}=mt(e),o=P(0);let c=0,n=!1,g=!1;const m=()=>{t("onOpenDialog",!0)},_=u=>{n=!0,t("onChangeOrientation",u),n=!1},y=u=>{t("resetMainAreaSize",u)},C=()=>{const u=o.value-c;c+=u,!n&&!g&&t("onSliceChange",u),n=!1,g=!1};document.addEventListener("keydown",u=>{u.key==="ArrowUp"&&c>0&&(c-=1,I(),t("onSliceChange",-1)),u.key==="ArrowDown"&&c<s.max&&(c+=1,I(),t("onSliceChange",1))});const I=()=>{o.value=c};return Y(()=>{c=i.value*a.value+r.value,I()}),Y(()=>{h!=null&&h.value&&(c=(h==null?void 0:h.value)*a.value),I()}),(u,d)=>{const S=X("el-slider");return B(),V("div",Ct,[f("div",wt,[N(S,{modelValue:o.value,"onUpdate:modelValue":d[0]||(d[0]=w=>o.value=w),max:z(s).max,onInput:C,"show-input":""},null,8,["modelValue","max"]),f("div",St,[f("span",{onClick:d[1]||(d[1]=w=>y(.5))},Pt),f("span",{onClick:d[2]||(d[2]=w=>y(-.5))},bt),f("span",{onClick:d[3]||(d[3]=w=>_("x"))},Lt),f("span",{onClick:d[4]||(d[4]=w=>_("z"))},kt),f("span",{onClick:d[5]||(d[5]=w=>_("y"))},Mt),f("span",{onClick:m},Et)])])])}}});const Wt=J(Ft,[["__scopeId","data-v-4ab276ea"]]),K=v=>(j("data-v-82614724"),v=v(),G(),v),Ht=K(()=>f("div",{class:"el-upload__text"},[vt(" Drop file here or "),f("em",null,"click to upload")],-1)),Ut=K(()=>f("div",{class:"el-upload__tip"},"Please drag or upload NRRD files!",-1)),Tt=R({__name:"Upload",props:{dialog:{type:Boolean,default:!1}},emits:["onCloseDialog","getLoadFilesUrls"],setup(v,{emit:t}){let s=[],e=[],i=!1;const r=n=>{let g=n.currentTarget,m=n.target;g===m&&(s.forEach(_=>{const y=URL.createObjectURL(_);e.push(y)}),t("getLoadFilesUrls",e),t("onCloseDialog",!1),i=!0,h())},h=()=>{s=[],e.forEach(n=>{URL.revokeObjectURL(n)}),e=[]},a=n=>{i&&(i=!1,h());let g=n.name,m;g.match(/\.(nrrd)$/)&&(m=n.raw,s.push(m)),m||c("No .nrrd asset found!")},o=n=>{s=s.filter(g=>g.name!==n.name),console.log(s)},c=n=>{let g=(n||{}).message||n.toString();g.match(/ProgressEvent/)?g="Unable to retrieve this file. Check JS console and browser network tab.":g.match(/Unexpected token/)?g=`Unable to parse file content. Verify that this file is valid. Error: "${g}"`:n&&n.target&&n.target instanceof Image&&(g="Missing texture: "+n.target.src.split("/").pop()),window.alert(g),console.error(n)};return(n,g)=>{const m=X("el-icon"),_=X("el-upload");return v.dialog?(B(),V("div",{key:0,onClick:r,class:"upload_container"},[N(_,{"auto-upload":!1,onChange:a,onRemove:o,class:"upload-demo",drag:"",action:"/",multiple:""},{tip:U(()=>[Ut]),default:U(()=>[N(m,{class:"el-icon--upload"},{default:U(()=>[N(z(xt))]),_:1}),Ht]),_:1})])):pt("",!0)}}});const Yt=J(Tt,[["__scopeId","data-v-82614724"]]),$t=R({__name:"example13_segmentation_CS",setup(v){let t,s=P(0),e=P(0),i=P(0),r=P(!1),h=P(0),a,o=P(),c=P(),n=P(),g,m,_,y=P(),C=new ot({width:300,autoPlace:!1}),I,u,d,S=[],w=P(0),F=!0,b=[],A=P(0);ft(()=>{g=o.value,m=c.value,_=n.value,m.appendChild(C.domElement),t=new lt(g),d=ct(),u=new yt(_),_.appendChild(d.loadingContainer),st("nrrd_tools"),document.addEventListener("keydown",p=>{p.code==="KeyF"&&gt(g)}),I=C.addFolder("select display contrast"),t.animate()});const k=p=>{A.value=p.length,S=p,S.length>0&&et(S)},O=p=>{r.value=p},Z=p=>{r.value=p},q=p=>{u.setSliceOrientation(p),s.value=u.getMaxSliceNum()[1];const{currentIndex:L,contrastIndex:x}=u.getCurrentSlicesNumAndContrastNum();e.value=L,i.value=x},Q=p=>{u.setSliceMoving(p)};Y(()=>{if(w.value!=0&&b.length!=0&&w.value===S.length){console.log("All files ready!"),u.clear(),b.sort((x,D)=>x.order-D.order),u.setShowInMainArea(!0),u.setAllSlices(b),h.value=u.getCurrentSliceIndex();const p=(x,D)=>{e.value=x,i.value=D};F?(u.drag({showNumber:!0,getSliceNum:p}),u.draw(a,C),a==null||a.addPreRenderCallbackFunction(u.start)):u.redrawMianPreOnDisplayCanvas(),s.value=u.getMaxSliceNum()[1],setTimeout(()=>{h.value=0,w.value=0},1e3),F=!1;const L={};for(let x=0;x<b.length;x++)if(x==0)L.pre=!0;else{const D="contrast"+x;L[D]=!0}u.removeGuiFolderChilden(I);for(let x=0;x<b.length;x++){let D="";x===0?D="pre":D="contrast"+x,I.add(L,D).onChange(W=>{W?(A.value+=1,u.addSkip(x)):(A.value-=1,u.removeSkip(x));const M=u.getMaxSliceNum()[1];if(M){s.value=M;const{currentIndex:H,contrastIndex:it}=u.getCurrentSlicesNumAndContrastNum();e.value=H,i.value=it+1}})}}});const tt=p=>{u.setMainAreaSize(p)};function st(p){a=t.getSceneByName(p),a==null&&(a=t.createScene(p),a&&(t.setCurrentScene(a),a&&a.loadViewUrl("/copper3d_examples/nrrd_view.json"),ut("/copper3d_examples/venice_sunset_1k.hdr"),a.updateBackground("#5454ad","#18e5a7")),t.updateEnvironment())}const et=p=>{b=[];const L=(x,D,W)=>{const M=Object.assign(W,{order:0});b.push(M),y.value=W,w.value+=1};a==null||a.loadNrrd(p[0],d,L);for(let x=1;x<p.length;x++)a==null||a.loadNrrd(p[x],d,(D,W,M)=>{const H=Object.assign(M,{order:x});b.push(H),w.value+=1})};return(p,L)=>(B(),V("div",{id:"bg",ref_key:"base_container",ref:o},[f("div",{ref_key:"c_gui_ref",ref:c,id:"gui"},null,512),f("div",{ref_key:"nrrd_c_ref",ref:n,class:"nrrd_c"},null,512),N(Wt,{"file-num":z(A),max:z(s),"immediate-slice-num":z(e),"contrast-index":z(i),"init-slice-index":z(h),onOnSliceChange:Q,onResetMainAreaSize:tt,onOnChangeOrientation:q,onOnOpenDialog:O},null,8,["file-num","max","immediate-slice-num","contrast-index","init-slice-index"]),N(Yt,{dialog:z(r),onOnCloseDialog:Z,onGetLoadFilesUrls:k},null,8,["dialog"])],512))}});export{$t as default};
