var E=Object.defineProperty;var N=(m,t,i)=>t in m?E(m,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):m[t]=i;var e=(m,t,i)=>(N(m,typeof t!="symbol"?t+"":t,i),i);import{W,P as H,a as T,c as P,e as z,R as k,C as U,t as M,V as Y}from"./index.665fbcc4.js";class ${constructor(t,i,s){e(this,"numberOfScene");e(this,"container");e(this,"elems");e(this,"scenes");e(this,"cameras");e(this,"renderer",new W({alpha:!0,antialias:!0}));e(this,"canvas");e(this,"sceneInfos");e(this,"pmremGenerator");e(this,"renderSceneInfo",t=>{const i=t.container,{left:s,right:a,top:r,bottom:o,width:d,height:c}=i.getBoundingClientRect();if(o<0||r>this.renderer.domElement.clientHeight||a<0||s>this.renderer.domElement.clientWidth)return;const l=this.renderer.domElement.clientHeight-o;this.renderer.setScissor(s,l,d,c),this.renderer.setViewport(s,l,d,c),t.render()});e(this,"resizeRendererToDisplaySize",()=>{const t=this.renderer.domElement.clientWidth,i=this.renderer.domElement.clientHeight;(this.renderer.domElement.width!==t||this.renderer.domElement.height!==i)&&(this.elems.map((a,r)=>{r===this.numberOfScene-1&&this.numberOfScene%2!==0?a.style.width=this.container.clientWidth+"px":a.style.width=this.container.clientWidth/2-2+"px",a.style.height=this.container.clientHeight/Math.ceil(this.numberOfScene/2)+"px"}),this.renderer.setSize(t,i,!1))});e(this,"animate",()=>{const t=new U("#000");this.renderer.setScissorTest(!1),this.renderer.setClearColor(t,0),this.renderer.clear(!0,!0),this.renderer.setScissorTest(!0),this.resizeRendererToDisplaySize(),this.sceneInfos.forEach(s=>{this.renderSceneInfo(s)});const i=`translateY(${window.scrollY}px)`;this.renderer.domElement.style.transform=i,window.requestAnimationFrame(this.animate)});this.numberOfScene=i>0?i:1,this.container=t,this.elems=[],this.scenes=[],this.cameras=[],this.sceneInfos=[],this.canvas=this.renderer.domElement,this.pmremGenerator=new H(this.renderer),this.init()}init(){this.renderer.physicallyCorrectLights=!0,this.renderer.outputEncoding=T,this.pmremGenerator.compileEquirectangularShader(),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.canvas.className="copper3D_canvas",this.container.className="copper3D_container_root",this.container.appendChild(this.canvas);for(let t=0;t<this.numberOfScene;t++){const i=document.createElement("div");i.className="copper3D_scene_div",this.container.appendChild(i),this.elems.push(i);const s=new P(i,this.renderer);this.updateEnvironment(s),this.sceneInfos.push(s)}}updateEnvironment(t){const i=z.filter(s=>s.name==="Venice Sunset")[0];this.getCubeMapTexture(i).then(s=>{s&&t.vignette&&t.scene.add(t.vignette.mesh),t.scene.environment=s,t.scene.background=s})}getCubeMapTexture(t){const{path:i}=t;return i?new Promise((s,a)=>{new k().load(i,r=>{const o=this.pmremGenerator.fromEquirectangular(r).texture;this.pmremGenerator.dispose(),s(o)},void 0,a)}):Promise.resolve({envMap:null})}}class X{constructor(t){e(this,"volume");e(this,"paintImages",{x:[],y:[],z:[]});e(this,"container");e(this,"drawingCanvasContainer",document.createElement("div"));e(this,"mainDisplayArea",document.createElement("div"));e(this,"contrast1Area",document.createElement("div"));e(this,"contrast2Area",document.createElement("div"));e(this,"contrast3Area",document.createElement("div"));e(this,"contrast4Area",document.createElement("div"));e(this,"start",()=>{});e(this,"slice");e(this,"oldIndex",0);e(this,"maxIndex",0);e(this,"minIndex",0);e(this,"contrastNum",0);e(this,"sliceModifyNum",0);e(this,"contrastModifyNum",0);e(this,"contrast1Slice");e(this,"contrast2Slice");e(this,"contrast3Slice");e(this,"contrast4Slice");e(this,"contrastShowInMain",!1);e(this,"axis","z");e(this,"originWidth",0);e(this,"originHeight",0);e(this,"changedWidth",0);e(this,"changedHeight",0);e(this,"contrastWidth",200);e(this,"contrastHeight",200);e(this,"Is_Shift_Pressed",!1);e(this,"Is_Draw",!1);e(this,"Mouse_Over_x",0);e(this,"Mouse_Over_y",0);e(this,"Mouse_Over",!1);e(this,"showDragNumberDiv",document.createElement("div"));e(this,"drawingCanvas",document.createElement("canvas"));e(this,"displayCanvas",document.createElement("canvas"));e(this,"displayContrast1Canvas",document.createElement("canvas"));e(this,"displayContrast2Canvas",document.createElement("canvas"));e(this,"displayContrast3Canvas",document.createElement("canvas"));e(this,"displayContrast4Canvas",document.createElement("canvas"));e(this,"drawingCanvasLayer1",document.createElement("canvas"));e(this,"originCanvas");e(this,"contrast1OriginCanvas");e(this,"contrast2OriginCanvas");e(this,"contrast3OriginCanvas");e(this,"contrast4OriginCanvas");e(this,"displayCtx");e(this,"drawingCtx");e(this,"drawingLayer1Ctx");e(this,"displayContrast1Ctx");e(this,"displayContrast2Ctx");e(this,"displayContrast3Ctx");e(this,"displayContrast4Ctx");e(this,"downloadImage",document.createElement("a"));e(this,"previousDrawingImage",new Image);e(this,"paintedImage");e(this,"readyToUpdate",!0);e(this,"addContrastArea",!1);e(this,"undoArray",[]);e(this,"stateMode",{dragSensitivity:5,size:1,globalAlpha:.3,lineWidth:2,color:"#f50a33",segmentation:!1,fillColor:"#3fac58",brushColor:"#3fac58",brushLineWidth:15,Eraser:!1,EraserSize:25,clearAll:()=>{this.clearAllPaint()},undo:()=>{this.undoLastPainting()},downloadCurrentImage:()=>{this.enableDownload()}});this.container=t,this.container.appendChild(this.mainDisplayArea),this.displayCtx=this.displayCanvas.getContext("2d"),this.displayContrast1Ctx=this.displayContrast1Canvas.getContext("2d"),this.displayContrast2Ctx=this.displayContrast2Canvas.getContext("2d"),this.displayContrast3Ctx=this.displayContrast3Canvas.getContext("2d"),this.displayContrast4Ctx=this.displayContrast4Canvas.getContext("2d"),this.drawingCtx=this.drawingCanvas.getContext("2d"),this.drawingLayer1Ctx=this.drawingCanvasLayer1.getContext("2d"),this.init()}init(){this.showDragNumberDiv=this.createShowSliceNumberDiv(),this.mainDisplayArea.classList.add("copper3D_display_area"),this.contrast1Area.classList.add("copper3D_display_area"),this.contrast2Area.classList.add("copper3D_display_area"),this.contrast3Area.classList.add("copper3D_display_area"),this.contrast4Area.classList.add("copper3D_display_area"),this.mainDisplayArea.classList.add("copper3D_mainDisplay"),this.contrast1Area.classList.add("copper3D_contrast1"),this.contrast2Area.classList.add("copper3D_contrast2"),this.contrast3Area.classList.add("copper3D_contrast3"),this.contrast4Area.classList.add("copper3D_contrast4"),this.displayContrast1Canvas.style.position="absolute",this.displayContrast2Canvas.style.position="absolute",this.displayContrast3Canvas.style.position="absolute",this.displayContrast4Canvas.style.position="absolute",this.mainDisplayArea.appendChild(this.drawingCanvasContainer);const t=this.createDescription("1st"),i=this.createDescription("2nd"),s=this.createDescription("3rd"),a=this.createDescription("4th");this.contrast1Area.appendChild(t),this.contrast2Area.appendChild(i),this.contrast3Area.appendChild(s),this.contrast4Area.appendChild(a),this.downloadImage.href="",this.downloadImage.target="_blank",this.drawingCanvasContainer.className="copper3D_drawingCanvasContainer"}afterLoadSlice(){switch(this.axis=this.slice.axis,this.originCanvas=this.slice.canvas,this.undoArray=[{sliceIndex:this.slice.index,contrastNum:this.contrastNum,undos:[]}],this.oldIndex=this.slice.index,this.axis){case"x":this.maxIndex=this.slice.volume.RASDimensions[0];break;case"y":this.maxIndex=this.slice.volume.RASDimensions[1];break;case"z":this.maxIndex=this.slice.volume.RASDimensions[2]-1;break}this.contrastShowInMain?this.showDragNumberDiv.innerHTML=`ContrastNum: ${this.contrastNum}/${4} SliceNum: ${0}/${this.maxIndex}`:this.showDragNumberDiv.innerHTML=`SliceNum: ${0}/${this.maxIndex}`}setVolume(t){this.volume=t,this.afterLoadSlice()}setSlice(t){this.slice=t,this.afterLoadSlice()}setVolumeAndSlice(t,i){this.volume=t,this.slice=i,this.afterLoadSlice()}setSyncsliceNum(){this.contrast1Slice&&this.contrast2Slice&&this.contrast3Slice&&this.contrast4Slice&&(this.contrast1Slice.index=this.slice.index,this.contrast2Slice.index=this.slice.index,this.contrast3Slice.index=this.slice.index,this.contrast4Slice.index=this.slice.index)}setContrastDisplayInMainArea(){this.contrastShowInMain=!0,this.addContrastArea=!0}getMaxSliceNum(){return this.contrastShowInMain?this.maxIndex*5:this.maxIndex}addContrastDisplay(){this.container.appendChild(this.contrast1Area),this.container.appendChild(this.contrast2Area),this.container.appendChild(this.contrast3Area),this.container.appendChild(this.contrast4Area),this.addContrastArea=!0}initDiplayContrastCanvas(t,i,s){t.width=this.contrastWidth,t.height=this.contrastHeight,i.drawImage(s,0,0,this.contrastWidth,this.contrastHeight)}setIsDrawFalse(t){setTimeout(()=>{this.Is_Draw=!1},t)}createDescription(t){const i=document.createElement("p");return i.innerText=t,i.style.position="absolute",i.style.bottom="5px",i}setContrastSize(t,i){this.contrastWidth=t,this.contrastHeight=i}setContrast1OriginCanvas(t){this.contrast1Slice=t,this.contrast1OriginCanvas=this.contrast1Slice.canvas,this.initDiplayContrastCanvas(this.displayContrast1Canvas,this.displayContrast1Ctx,this.contrast1OriginCanvas),this.contrast1Area.appendChild(this.displayContrast1Canvas)}setContrast2OriginCanvas(t){this.contrast2Slice=t,this.contrast2OriginCanvas=this.contrast2Slice.canvas,this.initDiplayContrastCanvas(this.displayContrast2Canvas,this.displayContrast2Ctx,this.contrast2OriginCanvas),this.contrast2Area.appendChild(this.displayContrast2Canvas)}setContrast3OriginCanvas(t){this.contrast3Slice=t,this.contrast3OriginCanvas=this.contrast3Slice.canvas,this.initDiplayContrastCanvas(this.displayContrast3Canvas,this.displayContrast3Ctx,this.contrast3OriginCanvas),this.contrast3Area.appendChild(this.displayContrast3Canvas)}setContrast4OriginCanvas(t){this.contrast4Slice=t,this.contrast4OriginCanvas=this.contrast4Slice.canvas,this.initDiplayContrastCanvas(this.displayContrast4Canvas,this.displayContrast4Ctx,this.contrast4OriginCanvas),this.contrast4Area.appendChild(this.displayContrast4Canvas)}dragImageWithMode(t,i){let s,a,r=this.container.offsetHeight,o=[10,9,8,7,6,5,4,3,2,1],d=1,c,g,l;this.originWidth=this.slice.canvas.width,this.originHeight=this.slice.canvas.height,this.container.tabIndex=10,i!=null&&i.showNumber&&this.container.appendChild(this.showDragNumberDiv),this.container.addEventListener("keydown",h=>{h.key==="Shift"&&(t.enabled=!1,this.container.style.cursor="pointer",this.Is_Shift_Pressed=!0,this.Is_Draw=!0,this.container.addEventListener("mousedown",g,!1),this.container.addEventListener("mouseup",c,!1))}),this.container.addEventListener("keyup",h=>{h.key==="Shift"&&(t.enabled=!0,this.container.style.cursor="",this.Is_Shift_Pressed=!1,this.container.removeEventListener("mousedown",g,!1),this.container.removeEventListener("mouseup",c,!1),this.container.removeEventListener("mousemove",l,!1),this.setIsDrawFalse(1e3))}),(i==null?void 0:i.mode)==="mode0"?(g=h=>{this.setSyncsliceNum(),a=h.offsetY/r},c=h=>{a-h.offsetY/r>=0?s=Math.ceil((a-h.offsetY/r)*20):s=Math.floor((a-h.offsetY/r)*20);let v=this.slice.index+s;v>this.maxIndex?v=this.maxIndex:v<this.minIndex?v=this.minIndex:(this.slice.index=v,this.slice.repaint.call(this.slice)),i!=null&&i.showNumber&&(this.showDragNumberDiv.innerHTML=`Slice number: ${v}/${this.maxIndex}`)}):(g=h=>{this.setSyncsliceNum(),a=h.offsetY/r,this.container.addEventListener("mousemove",l,!1),this.oldIndex=this.slice.index,d=o[this.stateMode.dragSensitivity-1]},l=M(h=>{this.oldIndex=this.slice.index,this.Is_Draw=!0,a-h.offsetY/r>=0?s=-Math.ceil((a-h.offsetY/r)*10/d):s=-Math.floor((a-h.offsetY/r)*10/d),this.updateIndex(s),a=h.offsetY/r},d*200),c=h=>{this.setSyncsliceNum(),this.container.removeEventListener("mousemove",l,!1)})}setSliceMoving(t){this.Is_Draw=!0,this.setSyncsliceNum(),this.updateIndex(t),this.setIsDrawFalse(1e3)}updateIndex(t){var r;let i=0,s=0;this.contrastShowInMain?(s=t%5,this.contrastNum+=s,t>0?(i=Math.floor(t/5),this.contrastNum>4&&(i+=1,this.contrastNum-=5)):(i=Math.ceil(t/5),this.contrastNum<0&&(this.contrastNum+=5,i-=1))):i=t;let a=this.oldIndex+i;if(a!=this.oldIndex||this.contrastShowInMain){if(a>this.maxIndex)a=this.maxIndex,this.contrastNum=4;else if(a<this.minIndex)a=this.minIndex,this.contrastNum=0;else{if(this.slice.index=a,this.slice.repaint.call(this.slice),this.addContrastArea&&this.updateContrastArea(),this.drawingCanvasLayer1.width=this.drawingCanvasLayer1.width,this.displayCanvas.width=this.displayCanvas.width,this.changedWidth===0&&(this.changedWidth=this.originWidth,this.changedHeight=this.originHeight),this.contrastShowInMain)switch(this.repraintCurrentContrastSlice(),this.contrastNum){case 0:this.displayCtx.drawImage(this.slice.canvas,0,0,this.changedWidth,this.changedHeight);break;case 1:this.displayCtx.drawImage(this.contrast1OriginCanvas,0,0,this.changedWidth,this.changedHeight);break;case 2:this.displayCtx.drawImage(this.contrast2OriginCanvas,0,0,this.changedWidth,this.changedHeight);break;case 3:this.displayCtx.drawImage(this.contrast3OriginCanvas,0,0,this.changedWidth,this.changedHeight);break;case 4:this.displayCtx.drawImage(this.contrast4OriginCanvas,0,0,this.changedWidth,this.changedHeight);break}else this.displayCtx.drawImage(this.slice.canvas,0,0,this.changedWidth,this.changedHeight);(this.paintImages.x.length>0||this.paintImages.y.length>0||this.paintImages.z.length>0)&&(this.paintedImage=this.filterDrawedImage(this.axis,this.contrastNum,this.slice.index),(r=this.paintedImage)!=null&&r.image&&this.drawingLayer1Ctx.drawImage(this.paintedImage.image,0,0,this.changedWidth,this.changedHeight))}this.oldIndex=this.slice.index,this.updateShowNumDiv(this.contrastNum,a)}}updateShowNumDiv(t,i){this.contrastShowInMain?this.showDragNumberDiv.innerHTML=`ContrastNum: ${t}/${4} SliceNum: ${this.slice.index}/${this.maxIndex}`:this.showDragNumberDiv.innerHTML=`SliceNum: ${this.slice.index}/${this.maxIndex}`}draw(t,i,s){let a,r;const o={subView:!0,scale:1,resetView:function(){i.resetView()}};s.add(o,"resetView"),a=s.addFolder("Mode Parameters"),r=s.addFolder("Sub View"),r.add(o,"subView").onChange(d=>{d?(t.enabled=!0,i.subDiv&&(i.subDiv.style.display="block")):(i.subDiv&&(i.subDiv.style.display="none"),t.enabled=!1)}),r.add(o,"scale").min(.25).max(2).step(.01).onFinishChange(d=>{i.subDiv&&(i.subDiv.style.width=200*d+"px"),i.subDiv&&(i.subDiv.style.height=200*d+"px")}),this.paintOnCanvas(t,a)}paintOnCanvas(t,i){var b;let s=!1,a=!1,r=0,o=0,d=this.slice.index,c=new Y(1,1),g=!1,l=[];this.originWidth=this.originCanvas.width,this.originHeight=this.originCanvas.height,this.changedWidth=this.originCanvas.width*Number(this.stateMode.size),this.changedHeight=this.originCanvas.height*Number(this.stateMode.size),this.configAllCanvas(),this.configGui(i),(b=this.displayCtx)==null||b.drawImage(this.originCanvas,0,0,this.changedWidth,this.changedHeight),this.previousDrawingImage.src=this.drawingCanvas.toDataURL(),this.drawingCanvas.oncontextmenu=()=>!1;const h=this.configMouseWheel(t),v=M(n=>{this.drawingCanvas.style.cursor="grabbing",this.displayCanvas.style.left=this.drawingCanvas.style.left=n.clientX-r+"px",this.displayCanvas.style.top=this.drawingCanvas.style.top=n.clientY-o+"px"},80),x=n=>{this.Mouse_Over_x=n.offsetX,this.Mouse_Over_y=n.offsetY,this.Mouse_Over_x===void 0&&(this.Mouse_Over_x=n.clientX,this.Mouse_Over_y=n.clientY),n.type==="mouseout"?(this.Mouse_Over=!1,this.drawingCanvas.removeEventListener("mousemove",x)):n.type==="mouseover"&&(this.Mouse_Over=!0,this.drawingCanvas.addEventListener("mousemove",x)),n.preventDefault()};this.drawingCanvas.addEventListener("mouseover",x),this.drawingCanvas.addEventListener("mouseout",x),this.drawingCanvas.addEventListener("pointerdown",n=>{if(s||a||this.Is_Shift_Pressed){this.drawingCanvas.removeEventListener("pointerup",S),this.drawingLayer1Ctx.closePath();return}if(d!==this.slice.index&&(this.previousDrawingImage.src="",d=this.slice.index),this.drawingCanvas.removeEventListener("wheel",h),t.enabled=!1,n.button===0)s=!0,l=[],g=!0,this.Is_Draw=!0,this.stateMode.Eraser?this.drawingCanvas.style.cursor="url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/4273/circular-cursor.png) 52 52, crosshair":this.drawingCanvas.style.cursor="crosshair",c.set(n.offsetX,n.offsetY),this.drawingLayer1Ctx.beginPath(),this.drawingCanvas.addEventListener("pointerup",S),this.drawingCanvas.addEventListener("pointermove",D);else if(n.button===2){let C=parseInt(this.drawingCanvas.style.left),p=parseInt(this.drawingCanvas.style.top);r=n.clientX-C,o=n.clientY-p,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.addEventListener("pointerup",S),this.drawingCanvas.addEventListener("pointermove",v)}else return},!0);var I=1;const L=(n,C,p)=>{var u=p-I,y=Math.sqrt(p*p-u*u),w=n-u,f=C-y,O=2*u,_=2*y;I<=p&&(this.drawingLayer1Ctx.clearRect(w,f,O,_),I+=1,L(n,C,p))},A=(n,C)=>{this.drawingLayer1Ctx.beginPath(),this.drawingLayer1Ctx.moveTo(c.x,c.y),this.stateMode.segmentation?(this.drawingLayer1Ctx.strokeStyle=this.stateMode.color,this.drawingLayer1Ctx.lineWidth=this.stateMode.lineWidth):(this.drawingLayer1Ctx.strokeStyle=this.stateMode.brushColor,this.drawingLayer1Ctx.lineWidth=this.stateMode.brushLineWidth),this.drawingLayer1Ctx.lineTo(n,C),this.drawingLayer1Ctx.stroke(),c.set(n,C),this.drawingLayer1Ctx.closePath(),this.slice.mesh.material.map.needsUpdate=!0},D=n=>{this.Is_Draw=!0,g&&(this.stateMode.Eraser?(I=1,L(n.offsetX,n.offsetY,this.stateMode.EraserSize)):(l.push({x:n.offsetX,y:n.offsetY}),A(n.offsetX,n.offsetY)))},S=n=>{var C;if(!this.Is_Shift_Pressed){if(n.button===0){if(s=!1,this.drawingLayer1Ctx.closePath(),this.drawingCanvas.removeEventListener("pointermove",D),!this.stateMode.Eraser&&this.stateMode.segmentation){this.drawingCanvasLayer1.width=this.drawingCanvasLayer1.width;const w=(C=this.filterDrawedImage(this.axis,this.contrastNum,this.slice.index))==null?void 0:C.image;w&&(this.previousDrawingImage=w),this.drawingLayer1Ctx.drawImage(this.previousDrawingImage,0,0,this.changedWidth,this.changedHeight),this.drawingLayer1Ctx.beginPath(),this.drawingLayer1Ctx.moveTo(l[0].x,l[0].y);for(let f=1;f<l.length;f++)this.drawingLayer1Ctx.lineTo(l[f].x,l[f].y);this.drawingLayer1Ctx.closePath(),this.drawingLayer1Ctx.lineWidth=1,this.drawingLayer1Ctx.fillStyle=this.stateMode.fillColor,this.drawingLayer1Ctx.fill()}this.previousDrawingImage.src=this.drawingCanvasLayer1.toDataURL(),this.storeAllImages(),console.log(this.drawingCtx.getImageData(0,0,this.drawingCanvas.width,this.drawingCanvas.height)),g=!1;const p=this.getCurrentUndo(),u=this.drawingCanvasLayer1.toDataURL(),y=new Image;if(y.src=u,p.length>0)p[0].undos.push(y);else{const w={sliceIndex:this.slice.index,contrastNum:this.contrastNum,undos:[]};w.undos.push(y),this.undoArray.push(w)}}else if(n.button===2)a=!1,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.removeEventListener("pointermove",v);else return;this.drawingCanvas.addEventListener("wheel",h,{passive:!1}),this.stateMode.segmentation||this.setIsDrawFalse(100)}};this.drawingCanvas.addEventListener("pointerleave",()=>{g=!1,t.enabled=!0,this.stateMode.segmentation&&this.setIsDrawFalse(1e3)}),this.start=()=>{this.readyToUpdate?(this.drawingCtx.clearRect(0,0,this.changedWidth,this.changedHeight),this.drawingCtx.globalAlpha=this.stateMode.globalAlpha,this.Is_Draw?(this.drawingLayer1Ctx.lineCap="round",this.drawingLayer1Ctx.globalAlpha=1,this.redrawOriginCanvas()):!this.stateMode.segmentation&&!this.stateMode.Eraser&&this.Mouse_Over&&(this.drawingCtx.fillStyle=this.stateMode.brushColor,this.drawingCtx.beginPath(),this.drawingCtx.arc(this.Mouse_Over_x,this.Mouse_Over_y,this.stateMode.brushLineWidth/2,0,Math.PI*2),this.drawingCtx.fill()),this.drawingCtx.drawImage(this.drawingCanvasLayer1,0,0)):(this.originCanvas.width=this.originCanvas.width,this.slice.repaint.call(this.slice),this.redrawDisplayCanvas(),this.addContrastArea&&this.updateContrastArea())},document.addEventListener("keydown",n=>{(n.ctrlKey||n.metaKey)&&n.code==="KeyZ"&&this.undoLastPainting()})}redrawOriginCanvas(){var t,i,s,a,r;this.slice.mesh.material.map.needsUpdate=!0,this.originCanvas.width=this.originCanvas.width,this.slice.repaint.call(this.slice),this.originCanvas.getContext("2d").globalAlpha=this.stateMode.globalAlpha,(t=this.originCanvas.getContext("2d"))==null||t.drawImage(this.drawingCanvasLayer1,0,0,this.originCanvas.width,this.originCanvas.height),!this.contrastShowInMain&&this.contrast1OriginCanvas&&this.contrast2OriginCanvas&&this.contrast3OriginCanvas&&this.contrast4OriginCanvas&&(this.contrast1OriginCanvas.width=this.contrast1OriginCanvas.width,this.contrast2OriginCanvas.width=this.contrast2OriginCanvas.width,this.contrast3OriginCanvas.width=this.contrast3OriginCanvas.width,this.contrast4OriginCanvas.width=this.contrast4OriginCanvas.width,this.repraintCurrentContrastSlice(),this.Is_Shift_Pressed&&(this.setSyncsliceNum(),this.repraintCurrentContrastSlice()),this.contrast1OriginCanvas.getContext("2d").globalAlpha=this.stateMode.globalAlpha,this.contrast2OriginCanvas.getContext("2d").globalAlpha=this.stateMode.globalAlpha,this.contrast3OriginCanvas.getContext("2d").globalAlpha=this.stateMode.globalAlpha,this.contrast4OriginCanvas.getContext("2d").globalAlpha=this.stateMode.globalAlpha,(i=this.contrast1OriginCanvas.getContext("2d"))==null||i.drawImage(this.drawingCanvasLayer1,0,0,this.contrast1OriginCanvas.width,this.contrast1OriginCanvas.height),(s=this.contrast2OriginCanvas.getContext("2d"))==null||s.drawImage(this.drawingCanvasLayer1,0,0,this.contrast2OriginCanvas.width,this.contrast2OriginCanvas.height),(a=this.contrast3OriginCanvas.getContext("2d"))==null||a.drawImage(this.drawingCanvasLayer1,0,0,this.contrast3OriginCanvas.width,this.contrast3OriginCanvas.height),(r=this.contrast4OriginCanvas.getContext("2d"))==null||r.drawImage(this.drawingCanvasLayer1,0,0,this.contrast4OriginCanvas.width,this.contrast4OriginCanvas.height),this.updateContrastArea())}updateContrastArea(){this.displayContrast1Canvas.width=this.displayContrast1Canvas.width,this.displayContrast2Canvas.width=this.displayContrast2Canvas.width,this.displayContrast3Canvas.width=this.displayContrast3Canvas.width,this.displayContrast4Canvas.width=this.displayContrast4Canvas.width,this.initDiplayContrastCanvas(this.displayContrast1Canvas,this.displayContrast1Ctx,this.contrast1OriginCanvas),this.initDiplayContrastCanvas(this.displayContrast2Canvas,this.displayContrast2Ctx,this.contrast2OriginCanvas),this.initDiplayContrastCanvas(this.displayContrast3Canvas,this.displayContrast3Ctx,this.contrast3OriginCanvas),this.initDiplayContrastCanvas(this.displayContrast4Canvas,this.displayContrast4Ctx,this.contrast4OriginCanvas)}updateContrastAreaValue(t,i){switch(i){case"lowerThreshold":this.contrast1Slice.volume.lowerThreshold=t,this.contrast2Slice.volume.lowerThreshold=t,this.contrast3Slice.volume.lowerThreshold=t,this.contrast4Slice.volume.lowerThreshold=t;break;case"upperThreshold":this.contrast1Slice.volume.upperThreshold=t,this.contrast2Slice.volume.upperThreshold=t,this.contrast3Slice.volume.upperThreshold=t,this.contrast4Slice.volume.upperThreshold=t;break;case"windowLow":this.contrast1Slice.volume.windowLow=t,this.contrast2Slice.volume.windowLow=t,this.contrast3Slice.volume.windowLow=t,this.contrast4Slice.volume.windowLow=t;break;case"windowHigh":this.contrast1Slice.volume.windowHigh=t,this.contrast2Slice.volume.windowHigh=t,this.contrast3Slice.volume.windowHigh=t,this.contrast4Slice.volume.windowHigh=t;break}this.repraintCurrentContrastSlice()}repraintCurrentContrastSlice(){this.contrast1Slice.repaint.call(this.contrast1Slice),this.contrast2Slice.repaint.call(this.contrast2Slice),this.contrast3Slice.repaint.call(this.contrast3Slice),this.contrast4Slice.repaint.call(this.contrast4Slice)}repraintAllContrastSlice(){this.contrast1Slice.volume.repaintAllSlices(),this.contrast2Slice.volume.repaintAllSlices(),this.contrast3Slice.volume.repaintAllSlices(),this.contrast4Slice.volume.repaintAllSlices()}configAllCanvas(){this.displayCanvas.style.position="absolute",this.displayCanvas.style.zIndex="9",this.displayCanvas.width=this.changedWidth,this.displayCanvas.height=this.changedHeight,this.drawingCanvas.style.zIndex="10",this.drawingCanvas.style.position="absolute",this.drawingCanvas.width=this.changedWidth,this.drawingCanvas.height=this.changedHeight,this.drawingCanvas.style.cursor="crosshair",this.displayCanvas.style.left=this.drawingCanvas.style.left="0px",this.displayCanvas.style.top=this.drawingCanvas.style.top="0px",this.drawingCanvasLayer1.width=this.changedWidth,this.drawingCanvasLayer1.height=this.changedHeight,this.drawingCanvasContainer.style.width=this.changedWidth+"px",this.drawingCanvasContainer.style.height=this.changedHeight+"px",this.drawingCanvasContainer.appendChild(this.displayCanvas),this.drawingCanvasContainer.appendChild(this.drawingCanvas)}createShowSliceNumberDiv(){const t=document.createElement("div");return t.className="copper3d_sliceNumber",t.style.position="absolute",t.style.zIndex="100",t.style.top="20px",t.style.left="100px",t}filterDrawedImage(t,i,s){return this.paintImages[t].filter(a=>a.index===s&&a.contrastNum===i)[0]}removeModeChilden(t){const i=t.__controllers;i.length>0&&i.forEach(s=>{setTimeout(()=>{t.remove(s)},100)})}clearAllPaint(){this.Is_Draw=!0,this.drawingCanvasLayer1.width=this.drawingCanvas.width,this.originCanvas.width=this.originCanvas.width,this.slice.repaint.call(this.slice),this.previousDrawingImage.src="",this.storeAllImages(),this.setIsDrawFalse(1e3)}enableDownload(){this.downloadImage.download=`slice_${this.axis}_#${this.slice.index}`,this.downloadImage.href=this.originCanvas.toDataURL(),this.downloadImage.click()}redrawDisplayCanvas(){var t;this.displayCanvas.width=this.displayCanvas.width,this.displayCanvas.height=this.displayCanvas.height,(t=this.displayCtx)==null||t.drawImage(this.originCanvas,0,0,this.changedWidth,this.changedHeight)}undoLastPainting(){this.Is_Draw=!0,this.drawingCanvasLayer1.width=this.drawingCanvasLayer1.width,this.slice.repaint.call(this.slice);const t=this.getCurrentUndo();if(t.length>0){const i=t[0];if(i.undos.length===0)return;if(i.undos.pop(),i.undos.length>0){const s=i.undos[i.undos.length-1];this.drawingLayer1Ctx.drawImage(s,0,0,this.changedWidth,this.changedHeight)}this.previousDrawingImage.src=this.drawingCanvasLayer1.toDataURL(),this.storeAllImages(),this.setIsDrawFalse(1e3)}}getCurrentUndo(){return this.undoArray.filter(t=>t.sliceIndex===this.slice.index&&t.contrastNum===this.contrastNum)}configGui(t){t.__controllers.length>0&&this.removeModeChilden(t),t.add(this.stateMode,"dragSensitivity").min(1).max(10).step(1),t.add(this.stateMode,"size").min(1).max(8).onFinishChange(s=>{this.resetPaintArea(),this.resizePaintArea(s)}),t.add(this.stateMode,"globalAlpha").min(.1).max(1).step(.01),t.add(this.stateMode,"segmentation"),t.addColor(this.stateMode,"color"),t.addColor(this.stateMode,"fillColor"),t.add(this.stateMode,"lineWidth").min(1.7).max(3).step(.01),t.add(this.stateMode,"brushLineWidth").min(5).max(50).step(1),t.addColor(this.stateMode,"brushColor"),t.add(this.stateMode,"EraserSize").min(1).max(50).step(1),t.add(this.stateMode,"Eraser").onChange(s=>{this.stateMode.Eraser=s,this.stateMode.Eraser?this.drawingCanvas.style.cursor="url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/4273/circular-cursor.png) 52 52, crosshair":this.drawingCanvas.style.cursor="crosshair"}),t.add(this.stateMode,"clearAll"),t.add(this.stateMode,"undo"),t.add(this.stateMode,"downloadCurrentImage");const i=t.addFolder("contrast");i.open(),i.add(this.slice.volume,"lowerThreshold",this.slice.volume.min,this.slice.volume.max,1).name("Lower Threshold").onChange(s=>{this.readyToUpdate=!1,this.addContrastArea&&this.updateContrastAreaValue(s,"lowerThreshold")}).onFinishChange(()=>{this.slice.volume.repaintAllSlices(),this.addContrastArea&&this.repraintAllContrastSlice(),this.readyToUpdate=!0}),i.add(this.slice.volume,"upperThreshold",this.slice.volume.min,this.slice.volume.max,1).name("Upper Threshold").onChange(s=>{this.readyToUpdate=!1,this.addContrastArea&&this.updateContrastAreaValue(s,"upperThreshold")}).onFinishChange(()=>{this.slice.volume.repaintAllSlices(),this.addContrastArea&&this.repraintAllContrastSlice(),this.readyToUpdate=!0}),i.add(this.slice.volume,"windowLow",this.slice.volume.min,this.slice.volume.max,1).name("Window Low").onChange(s=>{this.readyToUpdate=!1,this.addContrastArea&&this.updateContrastAreaValue(s,"windowLow")}).onFinishChange(()=>{this.slice.volume.repaintAllSlices(),this.addContrastArea&&this.repraintAllContrastSlice(),this.readyToUpdate=!0}),i.add(this.slice.volume,"windowHigh",this.slice.volume.min,this.slice.volume.max,1).name("Window High").onChange(s=>{this.readyToUpdate=!1,this.addContrastArea&&this.updateContrastAreaValue(s,"windowHigh")}).onFinishChange(()=>{this.slice.volume.repaintAllSlices(),this.addContrastArea&&this.repraintAllContrastSlice(),this.readyToUpdate=!0})}configMouseWheel(t){let i=1;const s=a=>{this.Is_Shift_Pressed||(a.preventDefault(),this.Is_Draw=!0,a.deltaY<0?i+=.1:a.deltaY>0&&(i-=.1),i>=8?i=8:i<=1&&(i=1),this.resizePaintArea(i),this.resetPaintArea(),t.enabled=!1,this.setIsDrawFalse(1e3))};return this.drawingCanvas.addEventListener("wheel",s,{passive:!1}),s}resetPaintArea(){this.displayCanvas.style.left=this.drawingCanvas.style.left="0px",this.displayCanvas.style.top=this.drawingCanvas.style.top="0px"}resizePaintArea(t){var i,s,a,r;this.originCanvas.width=this.originCanvas.width,this.displayCanvas.width=this.displayCanvas.width,this.drawingCanvas.width=this.drawingCanvas.width,this.drawingCanvasLayer1.width=this.drawingCanvasLayer1.width,this.changedWidth=this.originWidth*t,this.changedHeight=this.originHeight*t,this.displayCanvas.width=this.changedWidth,this.displayCanvas.height=this.changedHeight,this.drawingCanvas.width=this.changedWidth,this.drawingCanvas.height=this.changedHeight,this.drawingCanvasLayer1.width=this.changedWidth,this.drawingCanvasLayer1.height=this.changedHeight,this.drawingCanvasContainer.style.width=this.changedWidth+"px",this.drawingCanvasContainer.style.height=this.changedHeight+"px",this.slice.repaint.call(this.slice),(i=this.displayCtx)==null||i.drawImage(this.originCanvas,0,0,this.changedWidth,this.changedHeight),(s=this.paintedImage)!=null&&s.image||(this.paintImages.x.length>0?this.paintedImage=this.filterDrawedImage("x",this.contrastNum,this.slice.index):this.paintImages.y.length>0?this.paintedImage=this.filterDrawedImage("y",this.contrastNum,this.slice.index):this.paintImages.z.length>0&&(this.paintedImage=this.filterDrawedImage("z",this.contrastNum,this.slice.index))),(a=this.paintedImage)!=null&&a.image&&((r=this.drawingLayer1Ctx)==null||r.drawImage(this.paintedImage.image,0,0,this.changedWidth,this.changedHeight))}storeAllImages(){var a,r,o;const t=new Image;t.src=this.drawingCanvasLayer1.toDataURL();let i={index:this.slice.index,contrastNum:this.contrastNum,image:t},s;switch(this.axis){case"x":s=this.filterDrawedImage("x",this.contrastNum,this.slice.index),s?s.image=t:(a=this.paintImages.x)==null||a.push(i);break;case"y":s=this.filterDrawedImage("y",this.contrastNum,this.slice.index),s?s.image=t:(r=this.paintImages.y)==null||r.push(i);break;case"z":s=this.filterDrawedImage("z",this.contrastNum,this.slice.index),s?s.image=t:(o=this.paintImages.z)==null||o.push(i);break}}}export{$ as c,X as n};
