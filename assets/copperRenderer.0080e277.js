var _e=Object.defineProperty;var Ue=(e,t,r)=>t in e?_e(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var y=(e,t,r)=>(Ue(e,typeof t!="symbol"?t+"":t,r),r);import{b as Pe}from"./baseRenderer.5ed7b0fa.js";import{F as De,D as fe,R as ue,S as ve,V as de,G as pe,a as me,P as we,M as Z,g as Le,b as Ie,C as Ge,T as We,c as be,B as Be,d as oe,A as he,e as Ne,h as Oe,i as je,K as Ye,j as $e,p as Ke,k as ce,m as qe}from"./index.4ecf1bb4.js";var C=Uint8Array,R=Uint16Array,xe=Uint32Array,ye=new C([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ge=new C([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),He=new C([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ce=function(e,t){for(var r=new R(31),n=0;n<31;++n)r[n]=t+=1<<e[n-1];for(var i=new xe(r[30]),n=1;n<30;++n)for(var a=r[n];a<r[n+1];++a)i[a]=a-r[n]<<5|n;return[r,i]},Se=Ce(ye,2),ke=Se[0],Ze=Se[1];ke[28]=258,Ze[258]=28;var Je=Ce(ge,0),Qe=Je[0],q=new R(32768);for(var d=0;d<32768;++d){var F=(d&43690)>>>1|(d&21845)<<1;F=(F&52428)>>>2|(F&13107)<<2,F=(F&61680)>>>4|(F&3855)<<4,q[d]=((F&65280)>>>8|(F&255)<<8)>>>1}var D=function(e,t,r){for(var n=e.length,i=0,a=new R(t);i<n;++i)e[i]&&++a[e[i]-1];var l=new R(t);for(i=0;i<t;++i)l[i]=l[i-1]+a[i-1]<<1;var h;if(r){h=new R(1<<t);var s=15-t;for(i=0;i<n;++i)if(e[i])for(var o=i<<4|e[i],u=t-e[i],c=l[e[i]-1]++<<u,f=c|(1<<u)-1;c<=f;++c)h[q[c]>>>s]=o}else for(h=new R(n),i=0;i<n;++i)e[i]&&(h[i]=q[l[e[i]-1]++]>>>15-e[i]);return h},G=new C(288);for(var d=0;d<144;++d)G[d]=8;for(var d=144;d<256;++d)G[d]=9;for(var d=256;d<280;++d)G[d]=7;for(var d=280;d<288;++d)G[d]=8;var Ae=new C(32);for(var d=0;d<32;++d)Ae[d]=5;var Xe=D(G,9,1),Ve=D(Ae,5,1),Y=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},A=function(e,t,r){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(t&7)&r},$=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(t&7)},er=function(e){return(e+7)/8|0},J=function(e,t,r){(t==null||t<0)&&(t=0),(r==null||r>e.length)&&(r=e.length);var n=new(e.BYTES_PER_ELEMENT==2?R:e.BYTES_PER_ELEMENT==4?xe:C)(r-t);return n.set(e.subarray(t,r)),n},rr=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],k=function(e,t,r){var n=new Error(t||rr[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,k),!r)throw n;return n},tr=function(e,t,r){var n=e.length;if(!n||r&&r.f&&!r.l)return t||new C(0);var i=!t||r,a=!r||r.i;r||(r={}),t||(t=new C(n*3));var l=function(ie){var ae=t.length;if(ie>ae){var se=new C(Math.max(ae*2,ie));se.set(t),t=se}},h=r.f||0,s=r.p||0,o=r.b||0,u=r.l,c=r.d,f=r.m,p=r.n,g=n*8;do{if(!u){h=A(e,s,1);var m=A(e,s+1,3);if(s+=3,m)if(m==1)u=Xe,c=Ve,f=9,p=5;else if(m==2){var b=A(e,s,31)+257,Q=A(e,s+10,15)+4,X=b+A(e,s+5,31)+1;s+=14;for(var U=new C(X),B=new C(19),S=0;S<Q;++S)B[He[S]]=A(e,s+S*3,7);s+=Q*3;for(var V=Y(B),Ee=(1<<V)-1,Fe=D(B,V,1),S=0;S<X;){var ee=Fe[A(e,s,Ee)];s+=ee&15;var v=ee>>>4;if(v<16)U[S++]=v;else{var T=0,W=0;for(v==16?(W=3+A(e,s,3),s+=2,T=U[S-1]):v==17?(W=3+A(e,s,7),s+=3):v==18&&(W=11+A(e,s,127),s+=7);W--;)U[S++]=T}}var re=U.subarray(0,b),E=U.subarray(b);f=Y(re),p=Y(E),u=D(re,f,1),c=D(E,p,1)}else k(1);else{var v=er(s)+4,w=e[v-4]|e[v-3]<<8,x=v+w;if(x>n){a&&k(0);break}i&&l(o+w),t.set(e.subarray(v,x),o),r.b=o+=w,r.p=s=x*8,r.f=h;continue}if(s>g){a&&k(0);break}}i&&l(o+131072);for(var Re=(1<<f)-1,Te=(1<<p)-1,N=s;;N=s){var T=u[$(e,s)&Re],_=T>>>4;if(s+=T&15,s>g){a&&k(0);break}if(T||k(2),_<256)t[o++]=_;else if(_==256){N=s,u=null;break}else{var te=_-254;if(_>264){var S=_-257,P=ye[S];te=A(e,s,(1<<P)-1)+ke[S],s+=P}var O=c[$(e,s)&Te],j=O>>>4;O||k(3),s+=O&15;var E=Qe[j];if(j>3){var P=ge[j];E+=$(e,s)&(1<<P)-1,s+=P}if(s>g){a&&k(0);break}i&&l(o+131072);for(var ne=o+te;o<ne;o+=4)t[o]=t[o-E],t[o+1]=t[o+1-E],t[o+2]=t[o+2-E],t[o+3]=t[o+3-E];o=ne}}r.l=u,r.p=N,r.b=o,r.f=h,u&&(h=1,r.m=f,r.d=c,r.n=p)}while(!h);return o==t.length?t:J(t,0,o)},nr=new C(0),z=function(e,t){return e[t]|e[t+1]<<8},M=function(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0},K=function(e,t){return M(e,t)+M(e,t+4)*4294967296};function ir(e,t){return tr(e,t)}var H=typeof TextDecoder<"u"&&new TextDecoder,ar=0;try{H.decode(nr,{stream:!0}),ar=1}catch{}var sr=function(e){for(var t="",r=0;;){var n=e[r++],i=(n>127)+(n>223)+(n>239);if(r+i>e.length)return[t,J(e,r-1)];i?i==3?(n=((n&15)<<18|(e[r++]&63)<<12|(e[r++]&63)<<6|e[r++]&63)-65536,t+=String.fromCharCode(55296|n>>10,56320|n&1023)):i&1?t+=String.fromCharCode((n&31)<<6|e[r++]&63):t+=String.fromCharCode((n&15)<<12|(e[r++]&63)<<6|e[r++]&63):t+=String.fromCharCode(n)}};function or(e,t){if(t){for(var r="",n=0;n<e.length;n+=16384)r+=String.fromCharCode.apply(null,e.subarray(n,n+16384));return r}else{if(H)return H.decode(e);var i=sr(e),a=i[0],l=i[1];return l.length&&k(8),a}}var hr=function(e,t){return t+30+z(e,t+26)+z(e,t+28)},cr=function(e,t,r){var n=z(e,t+28),i=or(e.subarray(t+46,t+46+n),!(z(e,t+8)&2048)),a=t+46+n,l=M(e,t+20),h=r&&l==4294967295?lr(e,a):[l,M(e,t+24),M(e,t+42)],s=h[0],o=h[1],u=h[2];return[z(e,t+10),s,o,i,a+z(e,t+30)+z(e,t+32),u]},lr=function(e,t){for(;z(e,t)!=1;t+=4+z(e,t+2));return[K(e,t+12),K(e,t+4),K(e,t+20)]};function fr(e,t){for(var r={},n=e.length-22;M(e,n)!=101010256;--n)(!n||e.length-n>65558)&&k(13);var i=z(e,n+8);if(!i)return{};var a=M(e,n+16),l=a==4294967295;l&&(n=M(e,n-12),M(e,n)!=101075792&&k(13),i=M(e,n+32),a=M(e,n+48));for(var h=t&&t.filter,s=0;s<i;++s){var o=cr(e,a,l),u=o[0],c=o[1],f=o[2],p=o[3],g=o[4],m=o[5],v=hr(e,m);a=g,(!h||h({name:p,size:c,originalSize:f,compression:u}))&&(u?u==8?r[p]=ir(e.subarray(v,v+c),new C(f)):k(14,"unknown compression type "+u):r[p]=J(e,v,v+c))}return r}const Me=`#define GLSLIFY 1
uniform vec2 size;out vec2 vUv;void main(){gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);vUv.xy=position.xy/size+0.5;vUv.y=1.0-vUv.y;}`,ze=`precision highp float;precision highp int;precision highp sampler2DArray;
#define GLSLIFY 1
uniform sampler2DArray diffuse;in vec2 vUv;uniform int depth;out vec4 outColor;void main(){vec4 color=texture(diffuse,vec3(vUv,depth));outColor=vec4(color.rrr*1.5,1.0);}`;let L=80,I=80;function ur(e,t){new De().setResponseType("arraybuffer").load(e,function(r){const n=fr(new Uint8Array(r)),i=new Uint8Array(n.head256x256x109.buffer),a=new fe(i,256,256,109);a.format=ue,a.needsUpdate=!0;const l=new ve({uniforms:{diffuse:{value:a},depth:{value:1},size:{value:new de(L,I)}},vertexShader:Me,fragmentShader:ze,glslVersion:pe,side:me}),h=new we(L,I),s=new Z(h,l);s.name="texture2d_mesh_zip",t.add(s)})}function le(e,t,r,n){L=e.width/2,I=e.height/2;const i={windowWidth:e.windowWidth,windowCenter:e.windowCenter},a=new fe(e.uint8,e.width,e.height,t);a.format=ue,a.needsUpdate=!0,n&&(n.add(i,"windowWidth").min(1).max(e.windowWidth*2).step(1).onChange(()=>{o()}),n.add(i,"windowCenter").min(1).max(e.windowCenter*2).step(1).onChange(()=>{o()}));const l=new ve({uniforms:{diffuse:{value:a},depth:{value:1},size:{value:new de(L,I)}},vertexShader:Me,fragmentShader:ze,glslVersion:pe,side:me}),h=new we(L,I),s=new Z(h,l);r.add(s),s.name="texture2d_mesh_array";function o(){let u,c=Le(e.uint16,i.windowWidth,i.windowCenter,e.invert,u);for(let f=0,p=e.uint16.length;f<p;f++)e.uint8[f]=c.lutArray[e.uint16[f]];a.needsUpdate=!0}}class vr extends Ie{constructor(r,n){super(r,n);y(this,"controls");y(this,"clock",new Ge);y(this,"mixer",null);y(this,"playRate",1);y(this,"modelReady",!1);y(this,"clipAction");y(this,"pickableObjects",[]);y(this,"depthStep",.4);y(this,"texture2dMesh",null);y(this,"preRenderCallbackFunctions",[]);y(this,"sort",!0);this.controls=new We(this.camera,this.renderer.domElement),window.addEventListener("resize",this.onWindowResize,!1)}setDepth(r){this.depthStep=r}setDicomFilesOrder(r){r==="ascending"?this.sort=!0:r==="descending"&&(this.sort=!1)}loadGltf(r,n){be(this.renderer).load(r,a=>{const l=new Be().setFromObject(a.scene),h=l.getSize(new oe).length(),s=l.getCenter(new oe);this.controls.maxDistance=h*10,a.scene.position.x+=a.scene.position.x-s.x,a.scene.position.y+=a.scene.position.y-s.y,a.scene.position.z+=a.scene.position.z-s.z,this.cameraPositionFlag||(this.camera.position.copy(s),this.camera.position.x+=h/2,this.camera.position.y+=h/5,this.camera.position.z+=h/2,this.camera.lookAt(s),this.viewPoint=this.setViewPoint(this.camera,[s.x,s.y,s.z])),this.mixer=new he(a.scene),a.animations.forEach((o,u)=>{var c,f;u===0?this.clipAction=(c=this.mixer)==null?void 0:c.clipAction(o).play():(f=this.mixer)==null||f.clipAction(o).play()}),this.content=a.scene,this.exportContent.copy(a.scene),this.exportContent.animations=a.animations,this.scene.add(a.scene),this.modelReady=!0,n&&n(a.scene)},a=>{})}loadNrrd(r,n,i,a){Ne(r,n,i,a)}loadVtk(r){Oe(r,this.scene,this.content)}loadVtks(r){let n=0;const{vtkLoader:i,vtkmaterial:a}=qe(),l=new je,h=setInterval(()=>{n===r.length&&(this.scene.add(this.exportContent),this.mixer=new he(l),this.exportContent.animations.forEach(o=>{var c;const u=(c=this.mixer)==null?void 0:c.clipAction(o);u.timeScale=3,u.play()}),this.modelReady=!0,clearInterval(h))},100);r.forEach(o=>{const u=[];o.urls.forEach(c=>{i.load(c,f=>{f.center(),f.computeVertexNormals(),u.push(f),u.length===o.urls.length&&(s(u,o),n+=1)})})});const s=(o,u)=>{let c=o[0];o.forEach((w,x)=>{x===0?(c=w,c.morphAttributes.position=[]):c.morphAttributes.position.push(w.attributes.position)});const f=new Z(c,a);f.scale.multiplyScalar(.1),l.add(f),this.exportContent.add(l),f.morphTargetInfluences=[],f.name=u.name;let p=0,g=[],m=o.length-1;for(let w=0;w<m;w++){const x=new Ye(`${f.name}.morphTargetInfluences[${w}]`,[p,p+1,p+2],[0,1,0]);g.push(x),p=p+2}const v=new $e(`copper3d_heart_morph_${f.name}`,m,g);this.exportContent.animations.push(v)}}pickModel(r,n,i){r.traverse(a=>{if(a.isMesh){const l=a;i&&i.includes(l.name)||this.pickableObjects.push(l)}}),Ke(this.camera,this.container,this.pickableObjects,n)}loadDicom(r,n,i){if(Array.isArray(r)){const a=r.length,l=[];let h=[],s=[];r.forEach(u=>{ce(u,c=>{if(l.push(c),l.length===a){l.sort((v,w)=>this.sort?v.order-w.order:w.order-v.order),l.forEach(v=>{h.push(v.uint8),s.push(v.uint16)});const f=new Uint8ClampedArray(c.width*c.height*a),p=new Uint16Array(f.length);let g=0,m=0;h.forEach((v,w)=>{g=w*c.width*c.height;for(let x=0;x<v.length;x++)f[x+g]=v[x]}),s.forEach((v,w)=>{m=w*c.width*c.height;for(let x=0;x<v.length;x++)p[x+m]=v[x]}),c.uint8=f,c.uint16=p,o(c)}})});const o=u=>{i&&i.add(this,"depthStep").min(.01).max(1).step(.01),le(u,a,this.scene,i);const c=setInterval(()=>{var f;this.scene.children.forEach(p=>{if(p.isMesh&&p.name==="texture2d_mesh_array"){this.texture2dMesh=p;const g=()=>{if(this.texture2dMesh){let m=this.texture2dMesh.material.uniforms.depth.value;m+=this.depthStep,(m>a||m<0)&&(m>1&&(m=a*2-m),m<0&&(m=-m),this.depthStep=-this.depthStep),this.texture2dMesh.material.uniforms.depth.value=m}};this.addPreRenderCallbackFunction(g)}}),((f=this.texture2dMesh)==null?void 0:f.name)==="texture2d_mesh_array"&&(n&&n(this.texture2dMesh),clearInterval(c))},500)}}else ce(r,l=>{le(l,1,this.scene)})}texture2d(r){ur(r,this.scene);const n=setInterval(()=>{var i;this.scene.children.forEach(a=>{if(a.isMesh&&a.name==="texture2d_mesh_zip"){this.texture2dMesh=a;const l=()=>{if(this.texture2dMesh){let h=this.texture2dMesh.material.uniforms.depth.value;h+=this.depthStep,(h>109||h<0)&&(h>1&&(h=109*2-h),h<0&&(h=-h),this.depthStep=-this.depthStep),this.texture2dMesh.material.uniforms.depth.value=h}};this.addPreRenderCallbackFunction(l)}}),((i=this.texture2dMesh)==null?void 0:i.name)==="texture2d_mesh_zip"&&clearInterval(n)},500)}getPlayRate(){return this.playRate}setPlayRate(r){this.playRate=r}setModelPosition(r,n){n.x&&(r.position.x=n.x),n.y&&(r.position.y=n.y),n.z&&(r.position.z=n.z)}resetView(){this.controls.reset(),this.updateCamera(this.viewPoint)}updateCamera(r){this.cameraPositionFlag=!0,this.copperControl.updateCameraViewPoint(r)}getCurrentTime(){let r=0;return this.clipAction&&(r=this.clipAction.time/this.clipAction._clip.duration),r}getCurrentMixer(){return this.mixer}addPreRenderCallbackFunction(r){const n=this.preRenderCallbackFunctions.length+1,i={id:n,callback:r};return this.preRenderCallbackFunctions.push(i),n}render(){this.controls.update(),this.modelReady&&this.mixer&&this.mixer.update(this.clock.getDelta()*this.playRate),this.preRenderCallbackFunctions.forEach(r=>{r.callback.call(null)}),this.renderer.render(this.scene,this.camera)}}class wr extends Pe{constructor(r,n){super(r,n);y(this,"sceneMap",{});y(this,"animate",()=>{this.render(),this.stats.update(),requestAnimationFrame(this.animate)})}getSceneByName(r){return this.sceneMap[r]}setCurrentScene(r){var n;r&&(this.currentScene=r,(n=this.options)!=null&&n.guiOpen&&this.updateGui(),this.onWindowResize())}createScene(r){if(this.sceneMap[r]==null){const n=new vr(this.container,this.renderer);return n.sceneName=r,this.updateEnvironment(n.vignette),this.sceneMap[r]=n,n}}onWindowResize(){}render(){this.currentScene.render()}}export{wr as c};
