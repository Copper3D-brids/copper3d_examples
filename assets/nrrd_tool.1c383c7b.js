var b=Object.defineProperty;var L=(m,t,s)=>t in m?b(m,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):m[t]=s;var d=(m,t,s)=>(L(m,typeof t!="symbol"?t+"":t,s),s);import{Y as D,Z as A,_ as k,$ as O,a0 as P,a1 as M,a2 as E,a3 as W}from"./index.eb258893.js";function F(m,t){if(!!D&&!!A)A.saveAs(m,t);else if(D)k.exports.saveAs(m,t);else{var s=require("file-saver");s.saveAs(m,t)}}class Y{constructor(t){d(this,"container");d(this,"paintImages",{x:[],y:[],z:[]});d(this,"allSlicesArray",[]);d(this,"displaySlices",[]);d(this,"backUpDisplaySlices",[]);d(this,"skipSlicesDic",{});d(this,"axis","z");d(this,"mainAreaContainer",document.createElement("div"));d(this,"showDragNumberDiv",document.createElement("div"));d(this,"drawingCanvas",document.createElement("canvas"));d(this,"displayCanvas",document.createElement("canvas"));d(this,"downloadCanvas",document.createElement("canvas"));d(this,"emptyCanvas",document.createElement("canvas"));d(this,"downloadImage",document.createElement("a"));d(this,"drawingCanvasLayerOne",document.createElement("canvas"));d(this,"currentShowingSlice");d(this,"displayCtx");d(this,"drawingCtx");d(this,"emptyCtx");d(this,"drawingLayerOneCtx");d(this,"originCanvas");d(this,"mainPreSlice");d(this,"sceneIn");d(this,"Is_Shift_Pressed",!1);d(this,"Is_Draw",!1);d(this,"sensitiveArray",[]);d(this,"handleWheelMove",()=>{});d(this,"start",()=>{});d(this,"paintedImage");d(this,"previousDrawingImage");d(this,"undoArray",[]);d(this,"initState",!0);d(this,"preTimer");d(this,"nrrd_states",{originWidth:0,originHeight:0,nrrd_x_pixel:0,nrrd_y_pixel:0,nrrd_z_pixel:0,nrrd_x_centimeter:0,nrrd_y_centimeter:0,nrrd_z_centimeter:0,changedWidth:0,changedHeight:0,oldIndex:0,currentIndex:0,maxIndex:0,minIndex:0,RSARatio:0,voxelSpacing:[],spaceOrigin:[],dimensions:[],loadMaskJson:!1,ratios:{x:1,y:1,z:1},sharedPlace:{x:[-1],y:[-1],z:[-1]},latestNotEmptyImg:new Image,contrastNum:0,Max_sensitive:100,readyToUpdate:!0,showContrast:!1,enableCursorChoose:!1,isCursorSelect:!1,cursorPageX:0,cursorPageY:0,Mouse_Over_x:0,Mouse_Over_y:0,Mouse_Over:!1,stepClear:1,sizeFoctor:1,clearAllFlag:!1,previousPanelL:-99999,previousPanelT:-99999,getMask:(t,s,e,i,r)=>{},defaultPaintCursor:"url(https://raw.githubusercontent.com/LinkunGao/copper3d-datasets/main/icons/dot.svg) 12 12,auto",drawStartPos:new O(1,1)});d(this,"cursorPage",{x:{cursorPageX:0,cursorPageY:0,index:0,updated:!1},y:{cursorPageX:0,cursorPageY:0,index:0,updated:!1},z:{cursorPageX:0,cursorPageY:0,index:0,updated:!1}});d(this,"gui_states",{mainAreaSize:1,dragSensitivity:75,Eraser:!1,globalAlpha:.7,lineWidth:2,color:"#f50a33",segmentation:!0,fillColor:"#3fac58",brushColor:"#3fac58",brushAndEraserSize:15,cursor:"dot",clear:()=>{this.clearPaint()},clearAll:()=>{confirm("Are you sure remove annotations on All slice?")===!0&&(this.nrrd_states.clearAllFlag=!0,this.clearPaint(),this.clearStoreImages()),this.nrrd_states.clearAllFlag=!1},undo:()=>{this.undoLastPainting()},downloadCurrentMask:()=>{this.enableDownload()},resetZoom:()=>{this.nrrd_states.sizeFoctor=1,this.resizePaintArea(1),this.resetPaintArea()},subView:!1,subViewScale:1,resetView:()=>{var t;(t=this.sceneIn)==null||t.resetView()},exportMarks:()=>{this.exportData()}});d(this,"drawLine",(t,s,e,i)=>{this.drawingCtx.beginPath(),this.drawingCtx.moveTo(t,s),this.drawingCtx.lineTo(e,i),this.drawingCtx.strokeStyle=this.gui_states.color,this.drawingCtx.stroke()});this.container=t,this.displayCtx=this.displayCanvas.getContext("2d"),this.drawingCtx=this.drawingCanvas.getContext("2d"),this.emptyCtx=this.emptyCanvas.getContext("2d"),this.drawingLayerOneCtx=this.drawingCanvasLayerOne.getContext("2d"),this.previousDrawingImage=this.emptyCtx.createImageData(1,1),this.init()}init(){this.showDragNumberDiv=this.createShowSliceNumberDiv(),this.mainAreaContainer.classList.add("copper3D_drawingCanvasContainer"),this.container.appendChild(this.mainAreaContainer),this.autoFocusDiv(this.container),this.downloadImage.href="",this.downloadImage.target="_blank";for(let t=0;t<this.nrrd_states.Max_sensitive;t++)this.sensitiveArray.push((t+1)/20);this.container.addEventListener("keydown",t=>{t.key==="Shift"&&(this.Is_Shift_Pressed=!0,this.nrrd_states.enableCursorChoose=!1),t.key==="s"&&(this.Is_Draw=!1,this.nrrd_states.enableCursorChoose=!this.nrrd_states.enableCursorChoose)}),this.container.addEventListener("keyup",t=>{t.key==="Shift"&&(this.Is_Shift_Pressed=!1)})}setAllSlices(t){this.allSlicesArray=[...t],this.nrrd_states.nrrd_x_pixel=this.allSlicesArray[0].z.canvas.width,this.nrrd_states.nrrd_y_pixel=this.allSlicesArray[0].z.canvas.height,this.nrrd_states.nrrd_z_pixel=this.allSlicesArray[0].x.canvas.width,this.nrrd_states.nrrd_x_centimeter=this.allSlicesArray[0].x.volume.dimensions[0],this.nrrd_states.nrrd_y_centimeter=this.allSlicesArray[0].x.volume.dimensions[1],this.nrrd_states.nrrd_z_centimeter=this.allSlicesArray[0].x.volume.dimensions[2],this.nrrd_states.voxelSpacing=this.allSlicesArray[0].x.volume.spacing,this.nrrd_states.ratios.x=this.allSlicesArray[0].x.volume.spacing[0],this.nrrd_states.ratios.y=this.allSlicesArray[0].x.volume.spacing[1],this.nrrd_states.ratios.z=this.allSlicesArray[0].x.volume.spacing[2],this.nrrd_states.dimensions=this.allSlicesArray[0].x.volume.dimensions,this.allSlicesArray.forEach((s,e)=>{s.x.contrastOrder=e,s.y.contrastOrder=e,s.z.contrastOrder=e}),this.nrrd_states.spaceOrigin=this.allSlicesArray[0].x.volume.header.space_origin.map(s=>s*1),this.nrrd_states.sharedPlace.x=this.getSharedPlace(this.nrrd_states.dimensions[0],this.nrrd_states.ratios.x),this.nrrd_states.sharedPlace.y=this.getSharedPlace(this.nrrd_states.dimensions[1],this.nrrd_states.ratios.y),this.nrrd_states.sharedPlace.z=this.getSharedPlace(this.nrrd_states.dimensions[2],this.nrrd_states.ratios.z),this.initPaintImages(this.nrrd_states.dimensions),this.setDisplaySlicesBaseOnAxis(),this.afterLoadSlice()}setMasksData(t,s){if(t){if(this.nrrd_states.loadMaskJson=!0,s){let{loadingContainer:e,progress:i}=s;e.style.display="flex",i.innerText="Loading masks data......"}this.setEmptyCanvasSize(),t.forEach((e,i)=>{let r=this.emptyCtx.createImageData(this.nrrd_states.nrrd_x_centimeter,this.nrrd_states.nrrd_y_centimeter);this.setEmptyCanvasSize();for(let n=0;n<e.data.length;n++)r.data[n]=e.data[n];this.emptyCtx.putImageData(r,0,0),this.storeAllImages(i)}),this.nrrd_states.loadMaskJson=!1,this.gui_states.resetZoom(),s&&(s.loadingContainer.style.display="none")}}getCurrentImageDimension(){return this.nrrd_states.dimensions}getVoxelSpacing(){return this.nrrd_states.voxelSpacing}getSpaceOrigin(){return this.nrrd_states.spaceOrigin}getSharedPlace(t,s){let e=-1,i=[],r=new Set;for(let n=0;n<t;n++){const a=Math.floor(n*s);a===e?(r.add(n-1),r.add(n)):e=a}return r.forEach(n=>{i.push(n)}),i}initPaintImages(t){for(let s=0;s<t[0];s++){const e=this.emptyCtx.createImageData(this.nrrd_states.nrrd_z_centimeter,this.nrrd_states.nrrd_y_centimeter),i={index:s,image:e};this.paintImages.x.push(i)}for(let s=0;s<t[1];s++){const e=this.emptyCtx.createImageData(this.nrrd_states.nrrd_x_centimeter,this.nrrd_states.nrrd_z_centimeter),i={index:s,image:e};this.paintImages.y.push(i)}for(let s=0;s<t[2];s++){const e=this.emptyCtx.createImageData(this.nrrd_states.nrrd_x_centimeter,this.nrrd_states.nrrd_y_centimeter),i={index:s,image:e};this.paintImages.z.push(i)}}setSliceOrientation(t){this.nrrd_states.enableCursorChoose&&(this.axis==="z"?(this.cursorPage.z.index=this.nrrd_states.currentIndex,this.cursorPage.z.cursorPageX=this.nrrd_states.cursorPageX,this.cursorPage.z.cursorPageY=this.nrrd_states.cursorPageY):this.axis==="x"?(this.cursorPage.x.index=this.nrrd_states.currentIndex,this.cursorPage.x.cursorPageX=this.nrrd_states.cursorPageX,this.cursorPage.x.cursorPageY=this.nrrd_states.cursorPageY):this.axis==="y"&&(this.cursorPage.y.index=this.nrrd_states.currentIndex,this.cursorPage.y.cursorPageX=this.nrrd_states.cursorPageX,this.cursorPage.y.cursorPageY=this.nrrd_states.cursorPageY),t==="z"?this.nrrd_states.isCursorSelect&&!this.cursorPage.z.updated?(this.axis==="x"&&(this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.x.cursorPageX/this.nrrd_states.nrrd_z_pixel*this.nrrd_states.dimensions[2]),this.nrrd_states.oldIndex=this.nrrd_states.currentIndex*this.nrrd_states.ratios.z,this.nrrd_states.cursorPageX=Math.ceil(this.cursorPage.x.index/this.nrrd_states.dimensions[0]*this.nrrd_states.nrrd_x_pixel)),this.axis==="y"&&(this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.y.cursorPageY/this.nrrd_states.nrrd_z_pixel*this.nrrd_states.dimensions[2]),this.nrrd_states.oldIndex=this.nrrd_states.currentIndex*this.nrrd_states.ratios.z,this.nrrd_states.cursorPageY=Math.ceil(this.cursorPage.y.index/this.nrrd_states.dimensions[1]*this.nrrd_states.nrrd_y_pixel)),this.cursorPage.z.updated=!0):(this.nrrd_states.currentIndex=this.cursorPage.z.index,this.nrrd_states.oldIndex=this.cursorPage.z.index*this.nrrd_states.ratios.z,this.nrrd_states.cursorPageX=this.cursorPage.z.cursorPageX,this.nrrd_states.cursorPageY=this.cursorPage.z.cursorPageY):t==="x"?this.nrrd_states.isCursorSelect&&!this.cursorPage.x.updated?(this.axis==="z"&&(this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.z.cursorPageX/this.nrrd_states.nrrd_x_pixel*this.nrrd_states.dimensions[0]),this.nrrd_states.oldIndex=this.nrrd_states.currentIndex*this.nrrd_states.ratios.x,this.nrrd_states.cursorPageX=Math.floor(this.cursorPage.z.index/this.nrrd_states.dimensions[2]*this.nrrd_states.nrrd_z_pixel)),this.axis==="y"&&(this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.y.cursorPageX/this.nrrd_states.nrrd_y_pixel*this.nrrd_states.dimensions[1]),this.nrrd_states.oldIndex=this.nrrd_states.currentIndex*this.nrrd_states.ratios.x,this.nrrd_states.cursorPageX=this.cursorPage.y.cursorPageY,this.nrrd_states.cursorPageY=Math.ceil(this.cursorPage.y.index/this.nrrd_states.dimensions[1]*this.nrrd_states.nrrd_y_pixel)),this.cursorPage.x.updated=!0):(this.nrrd_states.currentIndex=this.cursorPage.x.index,this.nrrd_states.oldIndex=this.cursorPage.x.index*this.nrrd_states.ratios.x,this.nrrd_states.cursorPageX=this.cursorPage.x.cursorPageX,this.nrrd_states.cursorPageY=this.cursorPage.x.cursorPageY):t==="y"&&(this.nrrd_states.isCursorSelect&&!this.cursorPage.y.updated?(this.axis==="z"&&(this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.z.cursorPageY/this.nrrd_states.nrrd_y_pixel*this.nrrd_states.dimensions[1]),this.nrrd_states.oldIndex=this.nrrd_states.currentIndex*this.nrrd_states.ratios.y,this.nrrd_states.cursorPageY=Math.ceil(this.cursorPage.z.index/this.nrrd_states.dimensions[2]*this.nrrd_states.nrrd_z_pixel)),this.axis==="x"&&(this.nrrd_states.currentIndex=Math.ceil(this.cursorPage.x.cursorPageY/this.nrrd_states.nrrd_x_pixel*this.nrrd_states.dimensions[0]),this.nrrd_states.oldIndex=this.nrrd_states.currentIndex*this.nrrd_states.ratios.y,this.nrrd_states.cursorPageX=Math.ceil(this.cursorPage.x.index/this.nrrd_states.dimensions[0]*this.nrrd_states.nrrd_x_pixel),this.nrrd_states.cursorPageY=this.cursorPage.x.cursorPageX),this.cursorPage.y.updated=!0):(this.nrrd_states.currentIndex=this.cursorPage.y.index,this.nrrd_states.oldIndex=this.cursorPage.y.index*this.nrrd_states.ratios.y,this.nrrd_states.cursorPageX=this.cursorPage.y.cursorPageX,this.nrrd_states.cursorPageY=this.cursorPage.y.cursorPageY)),this.cursorPage.x.updated&&this.cursorPage.y.updated&&this.cursorPage.z.updated&&(this.nrrd_states.isCursorSelect=!1)),this.axis=t,this.resetDisplaySlicesStatus()}addSkip(t){this.skipSlicesDic[t]=this.backUpDisplaySlices[t],t>=this.displaySlices.length?this.nrrd_states.contrastNum=this.displaySlices.length:this.nrrd_states.contrastNum=t,this.resetDisplaySlicesStatus()}removeSkip(t){this.skipSlicesDic[t]=void 0,this.nrrd_states.contrastNum=0,this.resetDisplaySlicesStatus()}clear(){this.allSlicesArray.length=0,this.displaySlices.length=0,this.undoArray.length=0,this.paintImages.x.length=0,this.paintImages.y.length=0,this.paintImages.z.length=0,this.clearDictionary(this.skipSlicesDic),this.displayCanvas.style.left=this.drawingCanvas.style.left="",this.displayCanvas.style.top=this.drawingCanvas.style.top="",this.backUpDisplaySlices.length=0,this.mainPreSlice=void 0,this.currentShowingSlice=void 0,this.previousDrawingImage=this.emptyCtx.createImageData(1,1),this.initState=!0,this.axis="z",this.nrrd_states.sizeFoctor=1,this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width,this.drawingCanvas.width=this.drawingCanvas.width,this.displayCanvas.width=this.displayCanvas.width}setSliceMoving(t){this.mainPreSlice&&(this.Is_Draw=!0,this.setSyncsliceNum(),this.updateIndex(t),this.setIsDrawFalse(1e3))}setShowInMainArea(t){this.nrrd_states.showContrast=t,this.nrrd_states.contrastNum=0,this.mainPreSlice&&(this.redrawMianPreOnDisplayCanvas(),this.updateShowNumDiv(this.nrrd_states.contrastNum))}setMainAreaSize(t){this.nrrd_states.sizeFoctor+=t,this.nrrd_states.sizeFoctor>=8?this.nrrd_states.sizeFoctor=8:this.nrrd_states.sizeFoctor<=1&&(this.nrrd_states.sizeFoctor=1),this.resizePaintArea(this.nrrd_states.sizeFoctor),this.resetPaintArea(),this.setIsDrawFalse(1e3)}getMaxSliceNum(){return this.nrrd_states.showContrast?[this.nrrd_states.maxIndex,this.nrrd_states.maxIndex*this.displaySlices.length]:[this.nrrd_states.maxIndex]}getCurrentSlicesNumAndContrastNum(){return{currentIndex:this.nrrd_states.currentIndex,contrastIndex:this.nrrd_states.contrastNum}}getCurrentSliceIndex(){return Math.ceil(this.mainPreSlice.index/this.nrrd_states.RSARatio)}getIsShowContrastState(){return this.nrrd_states.showContrast}setIsDrawFalse(t){this.preTimer=setTimeout(()=>{this.Is_Draw=!1,this.preTimer&&(window.clearTimeout(this.preTimer),this.preTimer=void 0)},t)}setDisplaySlicesBaseOnAxis(){this.displaySlices.length=0,this.backUpDisplaySlices.length=0,this.allSlicesArray.forEach(t=>{this.backUpDisplaySlices.push(t[this.axis])}),this.loadDisplaySlicesArray()}loadDisplaySlicesArray(){const t=Object.values(this.skipSlicesDic);t.length===0?this.backUpDisplaySlices.forEach((s,e)=>{this.skipSlicesDic[e]=s,this.displaySlices.push(s)}):t.forEach((s,e)=>{s&&(this.displaySlices.push(this.backUpDisplaySlices[e]),this.skipSlicesDic[e]=this.backUpDisplaySlices[e])})}resetDisplaySlicesStatus(){this.setDisplaySlicesBaseOnAxis(),this.setupConfigs()}setupConfigs(){this.setMainPreSlice(),this.updateMaxIndex(),this.setOriginCanvasAndPre(),this.updateShowNumDiv(this.nrrd_states.contrastNum),this.repraintCurrentContrastSlice(),this.resizePaintArea(this.nrrd_states.sizeFoctor),this.resetPaintArea()}setMainPreSlice(){this.mainPreSlice=this.displaySlices[0],this.mainPreSlice&&(this.nrrd_states.RSARatio=this.mainPreSlice.RSARatio)}setOriginCanvasAndPre(){this.mainPreSlice&&(this.nrrd_states.oldIndex>this.nrrd_states.maxIndex&&(this.nrrd_states.oldIndex=this.nrrd_states.maxIndex),this.initState?(this.nrrd_states.oldIndex=this.mainPreSlice.initIndex*this.nrrd_states.RSARatio,this.nrrd_states.currentIndex=this.mainPreSlice.initIndex):this.mainPreSlice.index=this.nrrd_states.oldIndex,this.originCanvas=this.mainPreSlice.canvas,this.updateOriginAndChangedWH())}afterLoadSlice(){this.setMainPreSlice(),this.setOriginCanvasAndPre(),this.currentShowingSlice=this.mainPreSlice,this.nrrd_states.oldIndex=this.mainPreSlice.initIndex*this.nrrd_states.RSARatio,this.nrrd_states.currentIndex=this.mainPreSlice.initIndex,this.undoArray=[{sliceIndex:this.nrrd_states.currentIndex,undos:[]}],this.updateMaxIndex(),this.updateShowNumDiv(this.nrrd_states.contrastNum),this.initState=!1}updateMaxIndex(){this.mainPreSlice&&(this.nrrd_states.maxIndex=this.mainPreSlice.MaxIndex)}updateCurrentContrastSlice(){return this.currentShowingSlice=this.displaySlices[this.nrrd_states.contrastNum],this.currentShowingSlice}createShowSliceNumberDiv(){const t=document.createElement("div");return t.className="copper3d_sliceNumber",t.style.position="absolute",t.style.zIndex="100",t.style.top="20px",t.style.left="100px",t}updateOriginAndChangedWH(){this.nrrd_states.originWidth=this.originCanvas.width,this.nrrd_states.originHeight=this.originCanvas.height,this.nrrd_states.changedWidth=this.nrrd_states.originWidth*Number(this.gui_states.mainAreaSize),this.nrrd_states.changedHeight=this.nrrd_states.originWidth*Number(this.gui_states.mainAreaSize),this.resizePaintArea(1),this.resetPaintArea()}initAllCanvas(){this.displayCanvas.style.position="absolute",this.displayCanvas.style.zIndex="9",this.displayCanvas.width=this.nrrd_states.changedWidth,this.displayCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.style.zIndex="10",this.drawingCanvas.style.position="absolute",this.drawingCanvas.width=this.nrrd_states.changedWidth,this.drawingCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor,this.drawingCanvas.oncontextmenu=()=>!1,this.drawingCanvasLayerOne.width=this.nrrd_states.changedWidth,this.drawingCanvasLayerOne.height=this.nrrd_states.changedHeight,this.mainAreaContainer.style.width=this.nrrd_states.originWidth*8+"px",this.mainAreaContainer.style.height=this.nrrd_states.originHeight*8+"px",this.mainAreaContainer.appendChild(this.displayCanvas),this.mainAreaContainer.appendChild(this.drawingCanvas)}autoFocusDiv(t){t.tabIndex=10,t.addEventListener("mouseover",()=>{t.focus()}),t.style.outline="none"}setSyncsliceNum(){this.displaySlices.forEach((t,s)=>{s!==0&&(t.index=this.mainPreSlice.index)})}repraintCurrentContrastSlice(){this.setSyncsliceNum(),this.displaySlices.forEach((t,s)=>{t.repaint.call(t)})}repraintAllContrastSlices(){this.displaySlices.forEach((t,s)=>{t.volume.repaintAllSlices()})}updateShowNumDiv(t){this.mainPreSlice&&(this.nrrd_states.currentIndex>this.nrrd_states.maxIndex&&(this.nrrd_states.currentIndex=this.nrrd_states.maxIndex),this.nrrd_states.showContrast?this.showDragNumberDiv.innerHTML=`ContrastNum: ${t}/${this.displaySlices.length-1} SliceNum: ${this.nrrd_states.currentIndex}/${this.nrrd_states.maxIndex}`:this.showDragNumberDiv.innerHTML=`SliceNum: ${this.nrrd_states.currentIndex}/${this.nrrd_states.maxIndex}`)}appendLoadingbar(t){this.mainAreaContainer.appendChild(t)}drag(t){let s,e,i=this.container.offsetHeight,r=1,n,a,l;this.sensitiveArray.reverse(),t!=null&&t.showNumber&&this.container.appendChild(this.showDragNumberDiv),a=o=>{this.drawingCanvas.removeEventListener("wheel",this.handleWheelMove),o.button===0&&(this.setSyncsliceNum(),e=o.offsetY/i,this.container.addEventListener("pointermove",l,!1),r=this.sensitiveArray[this.gui_states.dragSensitivity-1])},l=W(o=>{e-o.offsetY/i>=0?s=-Math.ceil((e-o.offsetY/i)*10/r):s=-Math.floor((e-o.offsetY/i)*10/r),this.updateIndex(s),t!=null&&t.getSliceNum&&t.getSliceNum(this.nrrd_states.currentIndex,this.nrrd_states.contrastNum),e=o.offsetY/i},r*200),n=o=>{this.drawingCanvas.addEventListener("wheel",this.handleWheelMove),this.setSyncsliceNum(),this.container.removeEventListener("pointermove",l,!1)};const c=()=>{this.container.style.cursor="pointer",this.container.addEventListener("pointerdown",a,!0),this.container.addEventListener("pointerup",n,!0)};c(),this.container.addEventListener("keydown",o=>{o.key==="Shift"&&(this.container.style.cursor="",this.container.removeEventListener("pointerdown",a,!0),this.container.removeEventListener("pointerup",n,!1),this.setIsDrawFalse(1e3))}),this.container.addEventListener("keyup",o=>{o.key==="Shift"&&c()})}updateIndex(t){let s=0,e=0;this.nrrd_states.showContrast?(e=t%this.displaySlices.length,this.nrrd_states.contrastNum+=e,t>0?this.nrrd_states.currentIndex<=this.nrrd_states.maxIndex?(s=Math.floor(t/this.displaySlices.length),this.nrrd_states.contrastNum>this.displaySlices.length-1&&(s+=1,this.nrrd_states.contrastNum-=this.displaySlices.length)):s=0:(s=Math.ceil(t/this.displaySlices.length),this.nrrd_states.contrastNum<0&&(this.nrrd_states.contrastNum+=this.displaySlices.length,s-=1))):s=t;let i=this.nrrd_states.currentIndex+s;if(i!=this.nrrd_states.currentIndex||this.nrrd_states.showContrast){if(i>this.nrrd_states.maxIndex)i=this.nrrd_states.maxIndex,this.nrrd_states.contrastNum=this.displaySlices.length-1;else if(i<this.nrrd_states.minIndex)i=this.nrrd_states.minIndex,this.nrrd_states.contrastNum=0;else{this.mainPreSlice.index=i*this.nrrd_states.RSARatio,i!=this.nrrd_states.currentIndex&&(this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width),this.displayCanvas.width=this.displayCanvas.width,this.nrrd_states.changedWidth===0&&(this.nrrd_states.changedWidth=this.nrrd_states.originWidth,this.nrrd_states.changedHeight=this.nrrd_states.originHeight);let r=this.updateCurrentContrastSlice();r.repaint.call(r),this.drawDragSlice(r.canvas,i)}this.nrrd_states.currentIndex=i,this.nrrd_states.oldIndex=i*this.nrrd_states.RSARatio,this.updateShowNumDiv(this.nrrd_states.contrastNum)}}drawDragSlice(t,s){var e;this.displayCtx.save(),this.flipDisplayImageByAxis(),this.displayCtx.drawImage(t,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.displayCtx.restore(),(this.paintImages.x.length>0||this.paintImages.y.length>0||this.paintImages.z.length>0)&&s!=this.nrrd_states.currentIndex&&(this.paintedImage=this.filterDrawedImage(this.axis,this.nrrd_states.currentIndex),(e=this.paintedImage)!=null&&e.image&&(this.setEmptyCanvasSize(),this.emptyCtx.putImageData(this.paintedImage.image,0,0),this.drawingLayerOneCtx.drawImage(this.emptyCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight)))}draw(t,s,e){let i,r;e&&(this.nrrd_states.getMask=e==null?void 0:e.getMaskData),this.sceneIn=t,t.controls.enabled=!1,this.gui_states.subView===!1&&t.subDiv&&(t.subDiv.style.display="none"),i=s.addFolder("Mode Parameters"),t.subDiv&&(r=s.addFolder("Sub View"),r.add(this.gui_states,"resetView"),r.add(this.gui_states,"subView").onChange(n=>{n?(t.controls.enabled=!0,t.subDiv&&(t.subDiv.style.display="block")):(t.subDiv&&(t.subDiv.style.display="none"),t.controls.enabled=!1)}),r.add(this.gui_states,"subViewScale").min(.25).max(2).step(.01).onFinishChange(n=>{t.subDiv&&(t.subDiv.style.width=200*n+"px"),t.subDiv&&(t.subDiv.style.height=200*n+"px")})),this.paintOnCanvas(i)}paintOnCanvas(t){var y,p,v,w;let s=!1,e=!1,i=0,r=0,n=this.mainPreSlice.index,a=!1,l=[];this.updateOriginAndChangedWH(),this.initAllCanvas(),this.configGui(t),(y=this.displayCtx)==null||y.save(),this.flipDisplayImageByAxis(),(p=this.displayCtx)==null||p.drawImage(this.originCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),(v=this.displayCtx)==null||v.restore(),this.previousDrawingImage=this.drawingCtx.getImageData(0,0,this.drawingCanvas.width,this.drawingCanvas.height),this.handleWheelMove=this.configMouseWheel((w=this.sceneIn)==null?void 0:w.controls),this.drawingCanvas.addEventListener("wheel",this.handleWheelMove,{passive:!1});const c=h=>{this.drawingCanvas.style.cursor="grabbing",this.nrrd_states.previousPanelL=h.clientX-i,this.nrrd_states.previousPanelT=h.clientY-r,this.displayCanvas.style.left=this.drawingCanvas.style.left=this.nrrd_states.previousPanelL+"px",this.displayCanvas.style.top=this.drawingCanvas.style.top=this.nrrd_states.previousPanelT+"px"},o=h=>{this.nrrd_states.Mouse_Over_x=h.offsetX,this.nrrd_states.Mouse_Over_y=h.offsetY,this.nrrd_states.Mouse_Over_x===void 0&&(this.nrrd_states.Mouse_Over_x=h.clientX,this.nrrd_states.Mouse_Over_y=h.clientY),h.type==="mouseout"?(this.nrrd_states.Mouse_Over=!1,this.drawingCanvas.removeEventListener("mousemove",o)):h.type==="mouseover"&&(this.nrrd_states.Mouse_Over=!0,this.drawingCanvas.addEventListener("mousemove",o)),h.preventDefault()};this.drawingCanvas.addEventListener("mouseover",o),this.drawingCanvas.addEventListener("mouseout",o),this.drawingCanvas.addEventListener("pointerdown",h=>{if(s||e){this.drawingCanvas.removeEventListener("pointerup",g),this.drawingLayerOneCtx.closePath();return}if(n!==this.mainPreSlice.index&&(this.previousDrawingImage=this.emptyCtx.createImageData(1,1),n=this.mainPreSlice.index),this.drawingCanvas.removeEventListener("wheel",this.handleWheelMove),h.button===0){if(this.Is_Shift_Pressed)s=!0,l=[],a=!0,this.Is_Draw=!0,this.gui_states.Eraser?this.drawingCanvas.style.cursor=P(this.gui_states.brushAndEraserSize):this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor,this.nrrd_states.drawStartPos.set(h.offsetX,h.offsetY),this.drawingLayerOneCtx.beginPath(),this.drawingCanvas.addEventListener("pointerup",g),this.drawingCanvas.addEventListener("pointermove",u);else if(this.nrrd_states.enableCursorChoose)switch(this.nrrd_states.cursorPageX=h.offsetX/this.nrrd_states.sizeFoctor,this.nrrd_states.cursorPageY=h.offsetY/this.nrrd_states.sizeFoctor,this.nrrd_states.isCursorSelect=!0,this.axis){case"x":this.cursorPage.x.updated=!0,this.cursorPage.y.updated=!1,this.cursorPage.z.updated=!1;break;case"y":this.cursorPage.x.updated=!1,this.cursorPage.y.updated=!0,this.cursorPage.z.updated=!1;break;case"z":this.cursorPage.x.updated=!1,this.cursorPage.y.updated=!1,this.cursorPage.z.updated=!0;break}}else if(h.button===2){e=!0;let x=this.drawingCanvas.offsetLeft,f=this.drawingCanvas.offsetTop;i=h.clientX-x,r=h.clientY-f,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.addEventListener("pointerup",g),this.drawingCanvas.addEventListener("pointermove",c)}else return},!0);const _=this.useEraser(),u=h=>{this.Is_Draw=!0,a&&(this.gui_states.Eraser?(this.nrrd_states.stepClear=1,_(h.offsetX,h.offsetY,this.gui_states.brushAndEraserSize)):(l.push({x:h.offsetX,y:h.offsetY}),this.paintOnCanvasLayerOne(h.offsetX,h.offsetY)))},g=h=>{var x;if(h.button===0){if(this.Is_Shift_Pressed||a){if(s=!1,this.drawingLayerOneCtx.closePath(),this.drawingCanvas.removeEventListener("pointermove",u),!this.gui_states.Eraser&&this.gui_states.segmentation){this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width;const C=(x=this.filterDrawedImage(this.axis,this.nrrd_states.currentIndex))==null?void 0:x.image;C&&(this.previousDrawingImage=C),this.emptyCanvas.width=this.emptyCanvas.width,this.emptyCtx.putImageData(this.previousDrawingImage,0,0),this.drawingLayerOneCtx.drawImage(this.emptyCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingLayerOneCtx.beginPath(),this.drawingLayerOneCtx.moveTo(l[0].x,l[0].y);for(let S=1;S<l.length;S++)this.drawingLayerOneCtx.lineTo(l[S].x,l[S].y);this.drawingLayerOneCtx.closePath(),this.drawingLayerOneCtx.lineWidth=1,this.drawingLayerOneCtx.fillStyle=this.gui_states.fillColor,this.drawingLayerOneCtx.fill()}this.previousDrawingImage=this.drawingLayerOneCtx.getImageData(0,0,this.drawingCanvasLayerOne.width,this.drawingCanvasLayerOne.height),this.storeAllImages(this.nrrd_states.currentIndex),a=!1;const f=this.getCurrentUndo(),z=this.drawingCanvasLayerOne.toDataURL(),I=new Image;if(I.src=z,f.length>0)f[0].undos.push(I);else{const C={sliceIndex:this.nrrd_states.currentIndex,undos:[]};C.undos.push(I),this.undoArray.push(C)}}}else if(h.button===2)e=!1,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.removeEventListener("pointermove",c);else return;this.drawingCanvas.addEventListener("wheel",this.handleWheelMove,{passive:!1}),this.gui_states.segmentation||this.setIsDrawFalse(100)};this.drawingCanvas.addEventListener("pointerleave",h=>{a=!1,s&&(s=!1,this.drawingLayerOneCtx.closePath(),this.drawingCanvas.removeEventListener("pointermove",u)),e&&(e=!1,this.drawingCanvas.style.cursor="grab",this.drawingCanvas.removeEventListener("pointermove",c)),this.setIsDrawFalse(100),this.gui_states.segmentation&&this.setIsDrawFalse(1e3)}),this.start=()=>{if(this.nrrd_states.readyToUpdate){if(this.drawingCtx.clearRect(0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingCtx.globalAlpha=this.gui_states.globalAlpha,this.Is_Draw)this.drawingLayerOneCtx.lineCap="round",this.drawingLayerOneCtx.globalAlpha=1;else if(this.Is_Shift_Pressed&&!this.gui_states.segmentation&&!this.gui_states.Eraser&&this.nrrd_states.Mouse_Over&&(this.drawingCtx.clearRect(0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.drawingCtx.fillStyle=this.gui_states.brushColor,this.drawingCtx.beginPath(),this.drawingCtx.arc(this.nrrd_states.Mouse_Over_x,this.nrrd_states.Mouse_Over_y,this.gui_states.brushAndEraserSize/2+1,0,Math.PI*2),this.drawingCtx.strokeStyle=this.gui_states.brushColor,this.drawingCtx.stroke()),this.nrrd_states.enableCursorChoose){this.drawingCtx.clearRect(0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight);const h=this.nrrd_states.cursorPageX*this.nrrd_states.sizeFoctor,x=this.nrrd_states.cursorPageY*this.nrrd_states.sizeFoctor;this.drawLine(h,0,h,this.drawingCanvas.height),this.drawLine(0,x,this.drawingCanvas.width,x)}this.drawingCtx.drawImage(this.drawingCanvasLayerOne,0,0)}else this.redrawDisplayCanvas()},document.addEventListener("keydown",h=>{(h.ctrlKey||h.metaKey)&&h.code==="KeyZ"&&this.undoLastPainting()})}undoLastPainting(){this.Is_Draw=!0,this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width,this.mainPreSlice.repaint.call(this.mainPreSlice);const t=this.getCurrentUndo();if(t.length>0){const s=t[0];if(s.undos.length===0)return;if(s.undos.pop(),s.undos.length>0){const e=s.undos[s.undos.length-1];this.drawingLayerOneCtx.drawImage(e,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight)}this.previousDrawingImage=this.drawingLayerOneCtx.getImageData(0,0,this.drawingCanvasLayerOne.width,this.drawingCanvasLayerOne.height),this.storeAllImages(this.nrrd_states.currentIndex),this.setIsDrawFalse(1e3)}}getCurrentUndo(){return this.undoArray.filter(t=>t.sliceIndex===this.nrrd_states.currentIndex)}configMouseWheel(t){let s=1;return i=>{if(this.Is_Shift_Pressed)return;i.preventDefault();const r=i.detail?i.detail>0:i.wheelDelta<0;this.Is_Draw=!0;const n=(i.clientX-this.mainAreaContainer.offsetLeft-this.drawingCanvas.offsetLeft)/this.drawingCanvas.offsetWidth,a=(i.clientY-this.mainAreaContainer.offsetTop-this.drawingCanvas.offsetTop)/this.drawingCanvas.offsetHeight,l=r?1-.1:1+.1,c=this.drawingCanvas.offsetWidth*l,o=this.drawingCanvas.offsetHeight*l,_=Math.round(i.clientX-this.mainAreaContainer.offsetLeft-c*n),u=Math.round(i.clientY-this.mainAreaContainer.offsetTop-o*a);s=c/this.nrrd_states.originWidth,s>8?s=8:s<1?s=1:(this.resizePaintArea(s),this.resetPaintArea(_,u),t&&(t.enabled=!1),this.setIsDrawFalse(1e3)),this.nrrd_states.sizeFoctor=s}}useEraser(){const t=(s,e,i)=>{var r=i-this.nrrd_states.stepClear,n=Math.sqrt(i*i-r*r),a=s-r,l=e-n,c=2*r,o=2*n;this.nrrd_states.stepClear<=i&&(this.drawingLayerOneCtx.clearRect(a,l,c,o),this.nrrd_states.stepClear+=1,t(s,e,i))};return t}clearPaint(){this.Is_Draw=!0,this.drawingCanvasLayerOne.width=this.drawingCanvas.width,this.originCanvas.width=this.originCanvas.width,this.mainPreSlice.repaint.call(this.mainPreSlice),this.previousDrawingImage=this.emptyCtx.createImageData(1,1),this.storeAllImages(this.nrrd_states.currentIndex),this.setIsDrawFalse(1e3)}clearStoreImages(){this.paintImages.x.length=0,this.paintImages.y.length=0,this.paintImages.z.length=0,this.initPaintImages(this.nrrd_states.dimensions)}enableDownload(){this.downloadImage.download=`slice_${this.axis}_#${this.nrrd_states.currentIndex}`;const t=this.downloadCanvas.getContext("2d");this.downloadCanvas.width=this.nrrd_states.originWidth,this.downloadCanvas.height=this.nrrd_states.originHeight,t.drawImage(this.drawingCanvas,0,0,this.nrrd_states.originWidth,this.nrrd_states.originHeight),this.downloadImage.href=this.downloadCanvas.toDataURL(),this.downloadImage.click()}paintOnCanvasLayerOne(t,s){this.drawingLayerOneCtx.beginPath(),this.drawingLayerOneCtx.moveTo(this.nrrd_states.drawStartPos.x,this.nrrd_states.drawStartPos.y),this.gui_states.segmentation?(this.drawingLayerOneCtx.strokeStyle=this.gui_states.color,this.drawingLayerOneCtx.lineWidth=this.gui_states.lineWidth):(this.drawingLayerOneCtx.strokeStyle=this.gui_states.brushColor,this.drawingLayerOneCtx.lineWidth=this.gui_states.brushAndEraserSize),this.drawingLayerOneCtx.lineTo(t,s),this.drawingLayerOneCtx.stroke(),this.nrrd_states.drawStartPos.set(t,s),this.drawingLayerOneCtx.closePath(),this.mainPreSlice.mesh.material.map.needsUpdate=!0}configGui(t){t.__controllers.length>0&&this.removeGuiFolderChilden(t),t.open();const s=t.addFolder("Default Actions");s.add(this.gui_states,"cursor",["crosshair","pencil","dot"]).name("cursor icons").onChange(a=>{a==="crosshair"&&(this.nrrd_states.defaultPaintCursor="crosshair"),a==="pencil"&&(this.nrrd_states.defaultPaintCursor="url(https://raw.githubusercontent.com/LinkunGao/copper3d_icons/main/icons/pencil-black.svg), auto"),a==="dot"&&(this.nrrd_states.defaultPaintCursor="url(https://raw.githubusercontent.com/LinkunGao/copper3d-datasets/main/icons/dot.svg) 12 12,auto"),this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor}),s.add(this.gui_states,"mainAreaSize").name("zoom").min(1).max(8).onFinishChange(a=>{this.resetPaintArea(),this.nrrd_states.sizeFoctor=a,this.resizePaintArea(a)}),s.add(this.gui_states,"resetZoom"),s.add(this.gui_states,"globalAlpha").name("opacity").min(.1).max(1).step(.01),s.add(this.gui_states,"segmentation").name("Pencil"),s.add(this.gui_states,"brushAndEraserSize").min(5).max(50).step(1).onChange(()=>{this.gui_states.Eraser&&(this.drawingCanvas.style.cursor=P(this.gui_states.brushAndEraserSize))}),s.add(this.gui_states,"Eraser").onChange(a=>{this.gui_states.Eraser=a,this.gui_states.Eraser?this.drawingCanvas.style.cursor=P(this.gui_states.brushAndEraserSize):this.drawingCanvas.style.cursor=this.nrrd_states.defaultPaintCursor}),s.add(this.gui_states,"clear"),s.add(this.gui_states,"clearAll"),s.add(this.gui_states,"undo"),s.add(this.mainPreSlice.volume,"windowHigh",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Image contrast").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"windowHigh")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),s.add(this.gui_states,"exportMarks");const e=t.addFolder("Advance settings");e.add(this.gui_states,"dragSensitivity").min(1).max(this.nrrd_states.Max_sensitive).step(1);const i=e.addFolder("Pencil settings");i.add(this.gui_states,"lineWidth").name("outerLineWidth").min(1.7).max(3).step(.01),i.addColor(this.gui_states,"color"),i.addColor(this.gui_states,"fillColor"),e.addFolder("Brush settings").addColor(this.gui_states,"brushColor"),e.add(this.gui_states,"downloadCurrentMask");const n=e.addFolder("contrast advance settings");n.add(this.mainPreSlice.volume,"lowerThreshold",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Lower Threshold").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"lowerThreshold")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),n.add(this.mainPreSlice.volume,"upperThreshold",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Upper Threshold").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"upperThreshold")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),n.add(this.mainPreSlice.volume,"windowLow",this.mainPreSlice.volume.min,this.mainPreSlice.volume.max,1).name("Window Low").onChange(a=>{this.nrrd_states.readyToUpdate=!1,this.updateSlicesContrast(a,"windowLow")}).onFinishChange(()=>{this.repraintAllContrastSlices(),this.nrrd_states.readyToUpdate=!0}),s.open()}updateSlicesContrast(t,s){switch(s){case"lowerThreshold":this.displaySlices.forEach((e,i)=>{e.volume.lowerThreshold=t});break;case"upperThreshold":this.displaySlices.forEach((e,i)=>{e.volume.upperThreshold=t});break;case"windowLow":this.displaySlices.forEach((e,i)=>{e.volume.windowLow=t});break;case"windowHigh":this.displaySlices.forEach((e,i)=>{e.volume.windowHigh=t});break}this.repraintCurrentContrastSlice()}resetPaintArea(t,s){t&&s?(this.displayCanvas.style.left=this.drawingCanvas.style.left=t+"px",this.displayCanvas.style.top=this.drawingCanvas.style.top=s+"px"):(this.mainAreaContainer.style.justifyContent="center",this.mainAreaContainer.style.alignItems="center")}redrawDisplayCanvas(){var t,s,e;this.updateCurrentContrastSlice(),this.displayCanvas.width=this.displayCanvas.width,this.displayCanvas.height=this.displayCanvas.height,this.originCanvas.width=this.originCanvas.width,this.currentShowingSlice&&(this.currentShowingSlice.repaint.call(this.currentShowingSlice),(t=this.displayCtx)==null||t.save(),this.flipDisplayImageByAxis(),(s=this.displayCtx)==null||s.drawImage(this.currentShowingSlice.canvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),(e=this.displayCtx)==null||e.restore())}redrawMianPreOnDisplayCanvas(){var t;this.displayCanvas.width=this.displayCanvas.width,this.displayCanvas.height=this.displayCanvas.height,this.originCanvas.width=this.originCanvas.width,this.mainPreSlice&&(this.mainPreSlice.repaint.call(this.mainPreSlice),this.flipDisplayImageByAxis(),(t=this.displayCtx)==null||t.drawImage(this.originCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight),this.resizePaintArea(this.nrrd_states.sizeFoctor))}resizePaintArea(t){var s,e;switch(this.originCanvas.width=this.originCanvas.width,this.displayCanvas.width=this.displayCanvas.width,this.drawingCanvas.width=this.drawingCanvas.width,this.drawingCanvasLayerOne.width=this.drawingCanvasLayerOne.width,this.nrrd_states.changedWidth=this.nrrd_states.originWidth*t,this.nrrd_states.changedHeight=this.nrrd_states.originHeight*t,this.displayCanvas.width=this.nrrd_states.changedWidth,this.displayCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvas.width=this.nrrd_states.changedWidth,this.drawingCanvas.height=this.nrrd_states.changedHeight,this.drawingCanvasLayerOne.width=this.nrrd_states.changedWidth,this.drawingCanvasLayerOne.height=this.nrrd_states.changedHeight,this.redrawDisplayCanvas(),this.axis){case"x":this.paintImages.x.length>0?this.paintedImage=this.filterDrawedImage("x",this.nrrd_states.currentIndex):this.paintedImage=void 0;break;case"y":this.paintImages.y.length>0?this.paintedImage=this.filterDrawedImage("y",this.nrrd_states.currentIndex):this.paintedImage=void 0;break;case"z":this.paintImages.z.length>0?this.paintedImage=this.filterDrawedImage("z",this.nrrd_states.currentIndex):this.paintedImage=void 0;break}(s=this.paintedImage)!=null&&s.image&&(this.setEmptyCanvasSize(),this.emptyCtx.putImageData(this.paintedImage.image,0,0),(e=this.drawingLayerOneCtx)==null||e.drawImage(this.emptyCanvas,0,0,this.nrrd_states.changedWidth,this.nrrd_states.changedHeight))}flipDisplayImageByAxis(){var t,s,e,i;this.axis==="x"?((t=this.displayCtx)==null||t.scale(-1,-1),(s=this.displayCtx)==null||s.translate(-this.nrrd_states.changedWidth,-this.nrrd_states.changedHeight)):this.axis==="z"&&((e=this.displayCtx)==null||e.scale(1,-1),(i=this.displayCtx)==null||i.translate(0,-this.nrrd_states.changedHeight))}filterDrawedImage(t,s){return this.paintImages[t].filter(e=>e.index===s)[0]}removeGuiFolderChilden(t){const s=t.__controllers;s.length>0&&s.forEach(e=>{setTimeout(()=>{t.remove(e)},100)})}verifyCanvasIsEmpty(t){return this.emptyCanvas.width=t.width,this.emptyCanvas.height=t.height,t.toDataURL()===this.emptyCanvas.toDataURL()}clearDictionary(t){for(var s in t)delete t[s]}storeAllImages(t){var r,n,a;this.nrrd_states.loadMaskJson||(this.setEmptyCanvasSize(),this.emptyCtx.drawImage(this.drawingCanvasLayerOne,0,0,this.emptyCanvas.width,this.emptyCanvas.height));let s=this.emptyCtx.getImageData(0,0,this.emptyCanvas.width,this.emptyCanvas.height);switch(this.axis){case"x":const l=this.checkSharedPlaceSlice(this.nrrd_states.nrrd_x_centimeter,this.nrrd_states.nrrd_y_centimeter,s),c=this.sliceArrayV(l,this.nrrd_states.nrrd_y_centimeter,this.nrrd_states.nrrd_z_centimeter),o=this.sliceArrayH(l,this.nrrd_states.nrrd_y_centimeter,this.nrrd_states.nrrd_z_centimeter),_=t;this.replaceVerticalColPixels(this.paintImages.z,this.nrrd_states.dimensions[2],this.nrrd_states.ratios.z,c,this.nrrd_states.nrrd_x_centimeter,_),this.replaceVerticalColPixels(this.paintImages.y,this.nrrd_states.dimensions[1],this.nrrd_states.ratios.y,o,this.nrrd_states.nrrd_x_centimeter,_);break;case"y":const u=this.checkSharedPlaceSlice(this.nrrd_states.nrrd_x_centimeter,this.nrrd_states.nrrd_y_centimeter,s),g=this.sliceArrayV(u,this.nrrd_states.nrrd_z_centimeter,this.nrrd_states.nrrd_x_centimeter),y=this.sliceArrayH(u,this.nrrd_states.nrrd_z_centimeter,this.nrrd_states.nrrd_x_centimeter),p=t;this.replaceHorizontalRowPixels(this.paintImages.x,this.nrrd_states.dimensions[0],this.nrrd_states.ratios.x,g,this.nrrd_states.nrrd_z_centimeter,p),this.replaceHorizontalRowPixels(this.paintImages.z,this.nrrd_states.dimensions[2],this.nrrd_states.ratios.z,y,this.nrrd_states.nrrd_x_centimeter,p);break;case"z":const v=this.checkSharedPlaceSlice(this.nrrd_states.nrrd_x_centimeter,this.nrrd_states.nrrd_y_centimeter,s),w=this.sliceArrayV(v,this.nrrd_states.nrrd_y_centimeter,this.nrrd_states.nrrd_x_centimeter),h=this.sliceArrayH(v,this.nrrd_states.nrrd_y_centimeter,this.nrrd_states.nrrd_x_centimeter),x=t;this.replaceVerticalColPixels(this.paintImages.x,this.nrrd_states.dimensions[0],this.nrrd_states.ratios.x,w,this.nrrd_states.nrrd_z_centimeter,x),this.replaceHorizontalRowPixels(this.paintImages.y,this.nrrd_states.dimensions[1],this.nrrd_states.ratios.y,h,this.nrrd_states.nrrd_x_centimeter,x);break}let e={index:t,image:s},i;switch(this.axis){case"x":i=this.filterDrawedImage("x",t),i?i.image=s:(r=this.paintImages.x)==null||r.push(e);break;case"y":i=this.filterDrawedImage("y",t),i?i.image=s:(n=this.paintImages.y)==null||n.push(e);break;case"z":i=this.filterDrawedImage("z",t),i?i.image=s:(a=this.paintImages.z)==null||a.push(e);break}this.nrrd_states.loadMaskJson||this.nrrd_states.getMask(s,this.nrrd_states.currentIndex,this.nrrd_states.nrrd_x_centimeter,this.nrrd_states.nrrd_y_centimeter,this.nrrd_states.clearAllFlag)}sliceArrayH(t,s,e){const i=[];for(let r=0;r<s;r++){const n=r*e*4,a=(r+1)*e*4,l=t.slice(n,a);i.push(l)}return i}sliceArrayV(t,s,e){const i=[],r=e*4;for(let n=0;n<e;n++){const a=[];for(let l=0;l<s;l++){const c=r*l+n*4;a.push(t[c]),a.push(t[c+1]),a.push(t[c+2]),a.push(t[c+3])}i.push(a)}return i}replaceVerticalColPixels(t,s,e,i,r,n){for(let a=0,l=s;a<l;a++){const c=Math.floor(a*e),o=t[a].image.data,_=i[c],u=r*4;for(let g=0,y=_.length;g<y;g+=4){const p=g/4*u+n*4;o[p]=_[g],o[p+1]=_[g+1],o[p+2]=_[g+2],o[p+3]=_[g+3]}}}replaceHorizontalRowPixels(t,s,e,i,r,n){for(let a=0,l=s;a<l;a++){const c=Math.floor(a*e),o=t[a].image.data,_=i[c],u=r*n*4;for(let g=0,y=_.length;g<y;g++)o[u+g]=_[g]}}setEmptyCanvasSize(){switch(this.axis){case"x":this.emptyCanvas.width=this.nrrd_states.nrrd_z_centimeter,this.emptyCanvas.height=this.nrrd_states.nrrd_y_centimeter;break;case"y":this.emptyCanvas.width=this.nrrd_states.nrrd_x_centimeter,this.emptyCanvas.height=this.nrrd_states.nrrd_z_centimeter;break;case"z":this.emptyCanvas.width=this.nrrd_states.nrrd_x_centimeter,this.emptyCanvas.height=this.nrrd_states.nrrd_y_centimeter;break}}checkSharedPlaceSlice(t,s,e){let i=this.emptyCtx.createImageData(t,s).data;if(this.nrrd_states.sharedPlace.z.includes(this.nrrd_states.currentIndex)){const r=this.findSliceInSharedPlace();if(r.push(e),r.length>0)for(let n=0;n<r.length;n++)this.replaceArray(i,r[n].data)}else i=e.data;return i}replaceArray(t,s){for(let e=0,i=s.length;e<i;e++)s[e]===0||t[e]!==0||(t[e]=s[e])}findSliceInSharedPlace(){const t=[],s=Math.floor(this.nrrd_states.currentIndex*this.nrrd_states.ratios[this.axis]);for(let e=1;e<=3;e++){const i=this.nrrd_states.currentIndex-e;if(i<this.nrrd_states.minIndex)break;Math.floor(i*this.nrrd_states.ratios[this.axis])===s&&t.push(this.paintImages[this.axis][i].image)}for(let e=1;e<=3;e++){const i=this.nrrd_states.currentIndex+e;if(i>this.nrrd_states.maxIndex)break;Math.floor(i*this.nrrd_states.ratios[this.axis])===s&&t.push(this.paintImages[this.axis][i].image)}return t}exportData(){window.alert("Export masks, starting!!!");const t=M(this.paintImages.z,this.nrrd_states.nrrd_z_centimeter,this.nrrd_states.nrrd_x_centimeter,this.nrrd_states.nrrd_y_centimeter),s=E(t);s?(F(s,"copper3D_export data_z.json"),window.alert("Export masks successfully!!!")):window.alert("Export failed!")}}export{Y as n};
