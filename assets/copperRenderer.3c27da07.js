var Xe=Object.defineProperty;var Je=(r,e,t)=>e in r?Xe(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var v=(r,e,t)=>(Je(r,typeof e!="symbol"?e+"":e,t),t);import{b as Q,S as qe,L as Ze,d as $e,D as he,B as $,M as Qe,g as ee,I as et,h as tt,i as ve,j as nt,N as st,k as it,m as rt,n as ot,o as at,p as ct,q as lt,r as ht,u as ut,a as be,W as ft,P as dt,v as Ce,e as pt,R as mt,G as gt,F as xt,w as Le,x as Ne,y as Fe,V as _e,z as Ue,A as ke,E as ue,H as wt,J as vt,T as Tt,K as yt,O as Et,Q as Te,U as Mt,X as St,Y as At,Z as Rt,_ as It,$ as bt,a0 as ye,a1 as Ct}from"./index.665fbcc4.js";var W=function(){var r=0,e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",function(u){u.preventDefault(),n(++r%e.children.length)},!1);function t(u){return e.appendChild(u.dom),u}function n(u){for(var l=0;l<e.children.length;l++)e.children[l].style.display=l===u?"block":"none";r=u}var s=(performance||Date).now(),i=s,o=0,a=t(new W.Panel("FPS","#0ff","#002")),c=t(new W.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var h=t(new W.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:e,addPanel:t,showPanel:n,begin:function(){s=(performance||Date).now()},end:function(){o++;var u=(performance||Date).now();if(c.update(u-s,200),u>=i+1e3&&(a.update(o*1e3/(u-i),100),i=u,o=0,h)){var l=performance.memory;h.update(l.usedJSHeapSize/1048576,l.jsHeapSizeLimit/1048576)}return u},update:function(){s=this.end()},domElement:e,setMode:n}};W.Panel=function(r,e,t){var n=1/0,s=0,i=Math.round,o=i(window.devicePixelRatio||1),a=80*o,c=48*o,h=3*o,u=2*o,l=3*o,d=15*o,f=74*o,g=30*o,p=document.createElement("canvas");p.width=a,p.height=c,p.style.cssText="width:80px;height:48px";var m=p.getContext("2d");return m.font="bold "+9*o+"px Helvetica,Arial,sans-serif",m.textBaseline="top",m.fillStyle=t,m.fillRect(0,0,a,c),m.fillStyle=e,m.fillText(r,h,u),m.fillRect(l,d,f,g),m.fillStyle=t,m.globalAlpha=.9,m.fillRect(l,d,f,g),{dom:p,update:function(x,E){n=Math.min(n,x),s=Math.max(s,x),m.fillStyle=t,m.globalAlpha=1,m.fillRect(0,0,a,d),m.fillStyle=e,m.fillText(i(x)+" "+r+" ("+i(n)+"-"+i(s)+")",h,u),m.drawImage(p,l+o,d,f-o,g,l,d,f-o,g),m.fillRect(l+f-o,d,o,g),m.fillStyle=t,m.globalAlpha=.9,m.fillRect(l+f-o,d,o,i((1-x/E)*g))}}};const Lt=W;class fe{constructor(){this.pluginCallbacks=[],this.register(function(e){return new zt(e)}),this.register(function(e){return new Ot(e)}),this.register(function(e){return new Bt(e)}),this.register(function(e){return new jt(e)}),this.register(function(e){return new Yt(e)}),this.register(function(e){return new Ht(e)}),this.register(function(e){return new Vt(e)})}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,s){const i=new Dt,o=[];for(let a=0,c=this.pluginCallbacks.length;a<c;a++)o.push(this.pluginCallbacks[a](i));i.setPlugins(o),i.write(e,t,s).catch(n)}parseAsync(e,t){const n=this;return new Promise(function(s,i){n.parse(e,s,i,t)})}}const T={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,FLOAT:5126,UNSIGNED_INT:5125,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},L={};L[st]=T.NEAREST;L[it]=T.NEAREST_MIPMAP_NEAREST;L[rt]=T.NEAREST_MIPMAP_LINEAR;L[ot]=T.LINEAR;L[at]=T.LINEAR_MIPMAP_NEAREST;L[ct]=T.LINEAR_MIPMAP_LINEAR;L[lt]=T.CLAMP_TO_EDGE;L[ht]=T.REPEAT;L[ut]=T.MIRRORED_REPEAT;const Ee={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},Me=12,Nt=1179937895,Ft=2,Se=8,_t=1313821514,Ut=5130562;function Y(r,e){return r.length===e.length&&r.every(function(t,n){return t===e[n]})}function kt(r){return new TextEncoder().encode(r).buffer}function Pt(r){return Y(r.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function Gt(r,e,t){const n={min:new Array(r.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(r.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let s=e;s<e+t;s++)for(let i=0;i<r.itemSize;i++){let o;r.itemSize>4?o=r.array[s*r.itemSize+i]:i===0?o=r.getX(s):i===1?o=r.getY(s):i===2?o=r.getZ(s):i===3&&(o=r.getW(s)),n.min[i]=Math.min(n.min[i],o),n.max[i]=Math.max(n.max[i],o)}return n}function Pe(r){return Math.ceil(r/4)*4}function ie(r,e=0){const t=Pe(r.byteLength);if(t!==r.byteLength){const n=new Uint8Array(t);if(n.set(new Uint8Array(r)),e!==0)for(let s=r.byteLength;s<t;s++)n[s]=e;return n.buffer}return r}function Ae(){return typeof document>"u"&&typeof OffscreenCanvas<"u"?new OffscreenCanvas(1,1):document.createElement("canvas")}function Re(r,e){if(r.toBlob!==void 0)return new Promise(n=>r.toBlob(n,e));let t;return e==="image/jpeg"?t=.92:e==="image/webp"&&(t=.8),r.convertToBlob({type:e,quality:t})}class Dt{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,n){this.options=Object.assign({},{binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);const s=this,i=s.buffers,o=s.json;n=s.options;const a=s.extensionsUsed,c=new Blob(i,{type:"application/octet-stream"}),h=Object.keys(a);if(h.length>0&&(o.extensionsUsed=h),o.buffers&&o.buffers.length>0&&(o.buffers[0].byteLength=c.size),n.binary===!0){const u=new FileReader;u.readAsArrayBuffer(c),u.onloadend=function(){const l=ie(u.result),d=new DataView(new ArrayBuffer(Se));d.setUint32(0,l.byteLength,!0),d.setUint32(4,Ut,!0);const f=ie(kt(JSON.stringify(o)),32),g=new DataView(new ArrayBuffer(Se));g.setUint32(0,f.byteLength,!0),g.setUint32(4,_t,!0);const p=new ArrayBuffer(Me),m=new DataView(p);m.setUint32(0,Nt,!0),m.setUint32(4,Ft,!0);const x=Me+g.byteLength+f.byteLength+d.byteLength+l.byteLength;m.setUint32(8,x,!0);const E=new Blob([p,g,f,d,l],{type:"application/octet-stream"}),w=new FileReader;w.readAsArrayBuffer(E),w.onloadend=function(){t(w.result)}}}else if(o.buffers&&o.buffers.length>0){const u=new FileReader;u.readAsDataURL(c),u.onloadend=function(){const l=u.result;o.buffers[0].uri=l,t(o)}}else t(o)}serializeUserData(e,t){if(Object.keys(e.userData).length===0)return;const n=this.options,s=this.extensionsUsed;try{const i=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&i.gltfExtensions){t.extensions===void 0&&(t.extensions={});for(const o in i.gltfExtensions)t.extensions[o]=i.gltfExtensions[o],s[o]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(i){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+i.message)}}getUID(e,t=!1){if(this.uids.has(e)===!1){const s=new Map;s.set(!0,this.uid++),s.set(!1,this.uid++),this.uids.set(e,s)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const n=new Q;for(let s=0,i=e.count;s<i;s++)if(Math.abs(n.fromBufferAttribute(e,s).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const n=e.clone(),s=new Q;for(let i=0,o=n.count;i<o;i++)s.fromBufferAttribute(n,i),s.x===0&&s.y===0&&s.z===0?s.setX(1):s.normalize(),n.setXYZ(i,s.x,s.y,s.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1;const s={};(t.offset.x!==0||t.offset.y!==0)&&(s.offset=t.offset.toArray(),n=!0),t.rotation!==0&&(s.rotation=t.rotation,n=!0),(t.repeat.x!==1||t.repeat.y!==1)&&(s.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=s,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,t){if(e===t)return e;function n(f){return f.encoding===be?function(p){return p<.04045?p*.0773993808:Math.pow(p*.9478672986+.0521327014,2.4)}:function(p){return p}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures.");const s=e==null?void 0:e.image,i=t==null?void 0:t.image,o=Math.max((s==null?void 0:s.width)||0,(i==null?void 0:i.width)||0),a=Math.max((s==null?void 0:s.height)||0,(i==null?void 0:i.height)||0),c=Ae();c.width=o,c.height=a;const h=c.getContext("2d");h.fillStyle="#00ffff",h.fillRect(0,0,o,a);const u=h.getImageData(0,0,o,a);if(s){h.drawImage(s,0,0,o,a);const f=n(e),g=h.getImageData(0,0,o,a).data;for(let p=2;p<g.length;p+=4)u.data[p]=f(g[p]/256)*256}if(i){h.drawImage(i,0,0,o,a);const f=n(t),g=h.getImageData(0,0,o,a).data;for(let p=1;p<g.length;p+=4)u.data[p]=f(g[p]/256)*256}h.putImageData(u,0,0);const d=(e||t).clone();return d.source=new qe(c),d.encoding=Ze,d}processBuffer(e){const t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,s,i){const o=this.json;o.bufferViews||(o.bufferViews=[]);let a;t===T.UNSIGNED_BYTE?a=1:t===T.UNSIGNED_SHORT?a=2:a=4;const c=Pe(s*e.itemSize*a),h=new DataView(new ArrayBuffer(c));let u=0;for(let f=n;f<n+s;f++)for(let g=0;g<e.itemSize;g++){let p;e.itemSize>4?p=e.array[f*e.itemSize+g]:g===0?p=e.getX(f):g===1?p=e.getY(f):g===2?p=e.getZ(f):g===3&&(p=e.getW(f)),t===T.FLOAT?h.setFloat32(u,p,!0):t===T.UNSIGNED_INT?h.setUint32(u,p,!0):t===T.UNSIGNED_SHORT?h.setUint16(u,p,!0):t===T.UNSIGNED_BYTE&&h.setUint8(u,p),u+=a}const l={buffer:this.processBuffer(h.buffer),byteOffset:this.byteOffset,byteLength:c};return i!==void 0&&(l.target=i),i===T.ARRAY_BUFFER&&(l.byteStride=e.itemSize*a),this.byteOffset+=c,o.bufferViews.push(l),{id:o.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(s){const i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){const o=ie(i.result),a={buffer:t.processBuffer(o),byteOffset:t.byteOffset,byteLength:o.byteLength};t.byteOffset+=o.byteLength,s(n.bufferViews.push(a)-1)}})}processAccessor(e,t,n,s){const i=this.options,o=this.json,a={1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"};let c;if(e.array.constructor===Float32Array)c=T.FLOAT;else if(e.array.constructor===Uint32Array)c=T.UNSIGNED_INT;else if(e.array.constructor===Uint16Array)c=T.UNSIGNED_SHORT;else if(e.array.constructor===Uint8Array)c=T.UNSIGNED_BYTE;else throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");if(n===void 0&&(n=0),s===void 0&&(s=e.count),i.truncateDrawRange&&t!==void 0&&t.index===null){const f=n+s,g=t.drawRange.count===1/0?e.count:t.drawRange.start+t.drawRange.count;n=Math.max(n,t.drawRange.start),s=Math.min(f,g)-n,s<0&&(s=0)}if(s===0)return null;const h=Gt(e,n,s);let u;t!==void 0&&(u=e===t.index?T.ELEMENT_ARRAY_BUFFER:T.ARRAY_BUFFER);const l=this.processBufferView(e,c,n,s,u),d={bufferView:l.id,byteOffset:l.byteOffset,componentType:c,count:s,max:h.max,min:h.min,type:a[e.itemSize]};return e.normalized===!0&&(d.normalized=!0),o.accessors||(o.accessors=[]),o.accessors.push(d)-1}processImage(e,t,n,s="image/png"){const i=this,o=i.cache,a=i.json,c=i.options,h=i.pending;o.images.has(e)||o.images.set(e,{});const u=o.images.get(e),l=s+":flipY/"+n.toString();if(u[l]!==void 0)return u[l];a.images||(a.images=[]);const d={mimeType:s},f=Ae();f.width=Math.min(e.width,c.maxTextureSize),f.height=Math.min(e.height,c.maxTextureSize);const g=f.getContext("2d");if(n===!0&&(g.translate(0,f.height),g.scale(1,-1)),e.data!==void 0){t!==$e&&console.error("GLTFExporter: Only RGBAFormat is supported."),(e.width>c.maxTextureSize||e.height>c.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const m=new Uint8ClampedArray(e.height*e.width*4);for(let x=0;x<m.length;x+=4)m[x+0]=e.data[x+0],m[x+1]=e.data[x+1],m[x+2]=e.data[x+2],m[x+3]=e.data[x+3];g.putImageData(new ImageData(m,e.width,e.height),0,0)}else g.drawImage(e,0,0,f.width,f.height);c.binary===!0?h.push(Re(f,s).then(m=>i.processBufferViewImage(m)).then(m=>{d.bufferView=m})):f.toDataURL!==void 0?d.uri=f.toDataURL(s):h.push(Re(f,s).then(m=>new FileReader().readAsDataURL(m)).then(m=>{d.uri=m}));const p=a.images.push(d)-1;return u[l]=p,p}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const n={magFilter:L[e.magFilter],minFilter:L[e.minFilter],wrapS:L[e.wrapS],wrapT:L[e.wrapT]};return t.samplers.push(n)-1}processTexture(e){const t=this.cache,n=this.json;if(t.textures.has(e))return t.textures.get(e);n.textures||(n.textures=[]);let s=e.userData.mimeType;s==="image/webp"&&(s="image/png");const i={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,s)};e.name&&(i.name=e.name),this._invokeAll(function(a){a.writeTexture&&a.writeTexture(e,i)});const o=n.textures.push(i)-1;return t.textures.set(e,o),o}processMaterial(e){const t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);const s={pbrMetallicRoughness:{}};e.isMeshStandardMaterial!==!0&&e.isMeshBasicMaterial!==!0&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const i=e.color.toArray().concat([e.opacity]);if(Y(i,[1,1,1,1])||(s.pbrMetallicRoughness.baseColorFactor=i),e.isMeshStandardMaterial?(s.pbrMetallicRoughness.metallicFactor=e.metalness,s.pbrMetallicRoughness.roughnessFactor=e.roughness):(s.pbrMetallicRoughness.metallicFactor=.5,s.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){const a=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),c={index:this.processTexture(a)};this.applyTextureTransform(c,a),s.pbrMetallicRoughness.metallicRoughnessTexture=c}if(e.map){const a={index:this.processTexture(e.map)};this.applyTextureTransform(a,e.map),s.pbrMetallicRoughness.baseColorTexture=a}if(e.emissive){const a=e.emissive.clone().multiplyScalar(e.emissiveIntensity),c=Math.max(a.r,a.g,a.b);if(c>1&&(a.multiplyScalar(1/c),console.warn("THREE.GLTFExporter: Some emissive components exceed 1; emissive has been limited")),c>0&&(s.emissiveFactor=a.toArray()),e.emissiveMap){const h={index:this.processTexture(e.emissiveMap)};this.applyTextureTransform(h,e.emissiveMap),s.emissiveTexture=h}}if(e.normalMap){const a={index:this.processTexture(e.normalMap)};e.normalScale&&e.normalScale.x!==1&&(a.scale=e.normalScale.x),this.applyTextureTransform(a,e.normalMap),s.normalTexture=a}if(e.aoMap){const a={index:this.processTexture(e.aoMap),texCoord:1};e.aoMapIntensity!==1&&(a.strength=e.aoMapIntensity),this.applyTextureTransform(a,e.aoMap),s.occlusionTexture=a}e.transparent?s.alphaMode="BLEND":e.alphaTest>0&&(s.alphaMode="MASK",s.alphaCutoff=e.alphaTest),e.side===he&&(s.doubleSided=!0),e.name!==""&&(s.name=e.name),this.serializeUserData(e,s),this._invokeAll(function(a){a.writeMaterial&&a.writeMaterial(e,s)});const o=n.materials.push(s)-1;return t.materials.set(e,o),o}processMesh(e){const t=this.cache,n=this.json,s=[e.geometry.uuid];if(Array.isArray(e.material))for(let w=0,S=e.material.length;w<S;w++)s.push(e.material[w].uuid);else s.push(e.material.uuid);const i=s.join(":");if(t.meshes.has(i))return t.meshes.get(i);const o=e.geometry;let a;e.isLineSegments?a=T.LINES:e.isLineLoop?a=T.LINE_LOOP:e.isLine?a=T.LINE_STRIP:e.isPoints?a=T.POINTS:a=e.material.wireframe?T.LINES:T.TRIANGLES;const c={},h={},u=[],l=[],d={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},f=o.getAttribute("normal");f!==void 0&&!this.isNormalizedNormalAttribute(f)&&(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),o.setAttribute("normal",this.createNormalizedNormalAttribute(f)));let g=null;for(let w in o.attributes){if(w.slice(0,5)==="morph")continue;const S=o.attributes[w];if(w=d[w]||w.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(w)||(w="_"+w),t.attributes.has(this.getUID(S))){h[w]=t.attributes.get(this.getUID(S));continue}g=null;const M=S.array;w==="JOINTS_0"&&!(M instanceof Uint16Array)&&!(M instanceof Uint8Array)&&(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),g=new $(new Uint16Array(M),S.itemSize,S.normalized));const A=this.processAccessor(g||S,o);A!==null&&(h[w]=A,t.attributes.set(this.getUID(S),A))}if(f!==void 0&&o.setAttribute("normal",f),Object.keys(h).length===0)return null;if(e.morphTargetInfluences!==void 0&&e.morphTargetInfluences.length>0){const w=[],S=[],R={};if(e.morphTargetDictionary!==void 0)for(const M in e.morphTargetDictionary)R[e.morphTargetDictionary[M]]=M;for(let M=0;M<e.morphTargetInfluences.length;++M){const A={};let I=!1;for(const G in o.morphAttributes){if(G!=="position"&&G!=="normal"){I||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),I=!0);continue}const k=o.morphAttributes[G][M],V=G.toUpperCase(),O=o.attributes[G];if(t.attributes.has(this.getUID(k,!0))){A[V]=t.attributes.get(this.getUID(k,!0));continue}const P=k.clone();if(!o.morphTargetsRelative)for(let b=0,Z=k.count;b<Z;b++)P.setXYZ(b,k.getX(b)-O.getX(b),k.getY(b)-O.getY(b),k.getZ(b)-O.getZ(b));A[V]=this.processAccessor(P,o),t.attributes.set(this.getUID(O,!0),A[V])}l.push(A),w.push(e.morphTargetInfluences[M]),e.morphTargetDictionary!==void 0&&S.push(R[M])}c.weights=w,S.length>0&&(c.extras={},c.extras.targetNames=S)}const p=Array.isArray(e.material);if(p&&o.groups.length===0)return null;const m=p?e.material:[e.material],x=p?o.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let w=0,S=x.length;w<S;w++){const R={mode:a,attributes:h};if(this.serializeUserData(o,R),l.length>0&&(R.targets=l),o.index!==null){let A=this.getUID(o.index);(x[w].start!==void 0||x[w].count!==void 0)&&(A+=":"+x[w].start+":"+x[w].count),t.attributes.has(A)?R.indices=t.attributes.get(A):(R.indices=this.processAccessor(o.index,o,x[w].start,x[w].count),t.attributes.set(A,R.indices)),R.indices===null&&delete R.indices}const M=this.processMaterial(m[x[w].materialIndex]);M!==null&&(R.material=M),u.push(R)}c.primitives=u,n.meshes||(n.meshes=[]),this._invokeAll(function(w){w.writeMesh&&w.writeMesh(e,c)});const E=n.meshes.push(c)-1;return t.meshes.set(i,E),E}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const n=e.isOrthographicCamera,s={type:n?"orthographic":"perspective"};return n?s.orthographic={xmag:e.right*2,ymag:e.top*2,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:s.perspective={aspectRatio:e.aspect,yfov:Qe.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},e.name!==""&&(s.name=e.type),t.cameras.push(s)-1}processAnimation(e,t){const n=this.json,s=this.nodeMap;n.animations||(n.animations=[]),e=fe.Utils.mergeMorphTargetTracks(e.clone(),t);const i=e.tracks,o=[],a=[];for(let c=0;c<i.length;++c){const h=i[c],u=ee.parseTrackName(h.name);let l=ee.findNode(t,u.nodeName);const d=Ee[u.propertyName];if(u.objectName==="bones"&&(l.isSkinnedMesh===!0?l=l.skeleton.getBoneByName(u.objectIndex):l=void 0),!l||!d)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',h.name),null;const f=1;let g=h.values.length/h.times.length;d===Ee.morphTargetInfluences&&(g/=l.morphTargetInfluences.length);let p;h.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===!0?(p="CUBICSPLINE",g/=3):h.getInterpolation()===et?p="STEP":p="LINEAR",a.push({input:this.processAccessor(new $(h.times,f)),output:this.processAccessor(new $(h.values,g)),interpolation:p}),o.push({sampler:a.length-1,target:{node:s.get(l),path:d}})}return n.animations.push({name:e.name||"clip_"+n.animations.length,samplers:a,channels:o}),n.animations.length-1}processSkin(e){const t=this.json,n=this.nodeMap,s=t.nodes[n.get(e)],i=e.skeleton;if(i===void 0)return null;const o=e.skeleton.bones[0];if(o===void 0)return null;const a=[],c=new Float32Array(i.bones.length*16),h=new tt;for(let l=0;l<i.bones.length;++l)a.push(n.get(i.bones[l])),h.copy(i.boneInverses[l]),h.multiply(e.bindMatrix).toArray(c,l*16);return t.skins===void 0&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new $(c,16)),joints:a,skeleton:n.get(o)}),s.skin=t.skins.length-1}processNode(e){const t=this.json,n=this.options,s=this.nodeMap;t.nodes||(t.nodes=[]);const i={};if(n.trs){const a=e.quaternion.toArray(),c=e.position.toArray(),h=e.scale.toArray();Y(a,[0,0,0,1])||(i.rotation=a),Y(c,[0,0,0])||(i.translation=c),Y(h,[1,1,1])||(i.scale=h)}else e.matrixAutoUpdate&&e.updateMatrix(),Pt(e.matrix)===!1&&(i.matrix=e.matrix.elements);if(e.name!==""&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){const a=this.processMesh(e);a!==null&&(i.mesh=a)}else e.isCamera&&(i.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const a=[];for(let c=0,h=e.children.length;c<h;c++){const u=e.children[c];if(u.visible||n.onlyVisible===!1){const l=this.processNode(u);l!==null&&a.push(l)}}a.length>0&&(i.children=a)}this._invokeAll(function(a){a.writeNode&&a.writeNode(e,i)});const o=t.nodes.push(i)-1;return s.set(e,o),o}processScene(e){const t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);const s={};e.name!==""&&(s.name=e.name),t.scenes.push(s);const i=[];for(let o=0,a=e.children.length;o<a;o++){const c=e.children[o];if(c.visible||n.onlyVisible===!1){const h=this.processNode(c);h!==null&&i.push(h)}}i.length>0&&(s.nodes=i),this.serializeUserData(e,s)}processObjects(e){const t=new ve;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);this.processScene(t)}processInput(e){const t=this.options;e=e instanceof Array?e:[e],this._invokeAll(function(s){s.beforeParse&&s.beforeParse(e)});const n=[];for(let s=0;s<e.length;s++)e[s]instanceof ve?this.processScene(e[s]):n.push(e[s]);n.length>0&&this.processObjects(n);for(let s=0;s<this.skins.length;++s)this.processSkin(this.skins[s]);for(let s=0;s<t.animations.length;++s)this.processAnimation(t.animations[s],e[0]);this._invokeAll(function(s){s.afterParse&&s.afterParse(e)})}_invokeAll(e){for(let t=0,n=this.plugins.length;t<n;t++)e(this.plugins[t])}}class zt{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);return}const n=this.writer,s=n.json,i=n.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,o.spot.outerConeAngle=e.angle),e.decay!==void 0&&e.decay!==2&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||e.target.position.x!==0||e.target.position.y!==0||e.target.position.z!==-1)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(s.extensions=s.extensions||{},s.extensions[this.name]={lights:[]},i[this.name]=!0);const a=s.extensions[this.name].lights;a.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:a.length-1}}}class Ot{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const s=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},s[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class Bt{constructor(e){this.writer=e,this.name="KHR_materials_pbrSpecularGlossiness"}writeMaterial(e,t){if(!e.isGLTFSpecularGlossinessMaterial)return;const n=this.writer,s=n.extensionsUsed,i={};t.pbrMetallicRoughness.baseColorFactor&&(i.diffuseFactor=t.pbrMetallicRoughness.baseColorFactor);const o=[1,1,1];if(e.specular.toArray(o,0),i.specularFactor=o,i.glossinessFactor=e.glossiness,t.pbrMetallicRoughness.baseColorTexture&&(i.diffuseTexture=t.pbrMetallicRoughness.baseColorTexture),e.specularMap){const a={index:n.processTexture(e.specularMap)};n.applyTextureTransform(a,e.specularMap),i.specularGlossinessTexture=a}t.extensions=t.extensions||{},t.extensions[this.name]=i,s[this.name]=!0}}class Ht{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial)return;const n=this.writer,s=n.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){const o={index:n.processTexture(e.clearcoatMap)};n.applyTextureTransform(o,e.clearcoatMap),i.clearcoatTexture=o}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const o={index:n.processTexture(e.clearcoatRoughnessMap)};n.applyTextureTransform(o,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=o}if(e.clearcoatNormalMap){const o={index:n.processTexture(e.clearcoatNormalMap)};n.applyTextureTransform(o,e.clearcoatNormalMap),i.clearcoatNormalTexture=o}t.extensions=t.extensions||{},t.extensions[this.name]=i,s[this.name]=!0}}class Vt{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial)return;const n=this.writer,s=n.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){const o={index:n.processTexture(e.iridescenceMap)};n.applyTextureTransform(o,e.iridescenceMap),i.iridescenceTexture=o}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const o={index:n.processTexture(e.iridescenceThicknessMap)};n.applyTextureTransform(o,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=o}t.extensions=t.extensions||{},t.extensions[this.name]=i,s[this.name]=!0}}class jt{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;const n=this.writer,s=n.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){const o={index:n.processTexture(e.transmissionMap)};n.applyTextureTransform(o,e.transmissionMap),i.transmissionTexture=o}t.extensions=t.extensions||{},t.extensions[this.name]=i,s[this.name]=!0}}class Yt{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;const n=this.writer,s=n.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){const o={index:n.processTexture(e.thicknessMap)};n.applyTextureTransform(o,e.thicknessMap),i.thicknessTexture=o}i.attenuationDistance=e.attenuationDistance,i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,s[this.name]=!0}}fe.Utils={insertKeyframe:function(r,e){const n=r.getValueSize(),s=new r.TimeBufferType(r.times.length+1),i=new r.ValueBufferType(r.values.length+n),o=r.createInterpolant(new r.ValueBufferType(n));let a;if(r.times.length===0){s[0]=e;for(let c=0;c<n;c++)i[c]=0;a=0}else if(e<r.times[0]){if(Math.abs(r.times[0]-e)<.001)return 0;s[0]=e,s.set(r.times,1),i.set(o.evaluate(e),0),i.set(r.values,n),a=0}else if(e>r.times[r.times.length-1]){if(Math.abs(r.times[r.times.length-1]-e)<.001)return r.times.length-1;s[s.length-1]=e,s.set(r.times,0),i.set(r.values,0),i.set(o.evaluate(e),r.values.length),a=s.length-1}else for(let c=0;c<r.times.length;c++){if(Math.abs(r.times[c]-e)<.001)return c;if(r.times[c]<e&&r.times[c+1]>e){s.set(r.times.slice(0,c+1),0),s[c+1]=e,s.set(r.times.slice(c+1),c+2),i.set(r.values.slice(0,(c+1)*n),0),i.set(o.evaluate(e),(c+1)*n),i.set(r.values.slice((c+1)*n),(c+2)*n),a=c+1;break}}return r.times=s,r.values=i,a},mergeMorphTargetTracks:function(r,e){const t=[],n={},s=r.tracks;for(let i=0;i<s.length;++i){let o=s[i];const a=ee.parseTrackName(o.name),c=ee.findNode(e,a.nodeName);if(a.propertyName!=="morphTargetInfluences"||a.propertyIndex===void 0){t.push(o);continue}if(o.createInterpolant!==o.InterpolantFactoryMethodDiscrete&&o.createInterpolant!==o.InterpolantFactoryMethodLinear){if(o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),o=o.clone(),o.setInterpolation(nt)}const h=c.morphTargetInfluences.length,u=c.morphTargetDictionary[a.propertyIndex];if(u===void 0)throw new Error("THREE.GLTFExporter: Morph target name not found: "+a.propertyIndex);let l;if(n[c.uuid]===void 0){l=o.clone();const f=new l.ValueBufferType(h*l.times.length);for(let g=0;g<l.times.length;g++)f[g*h+u]=l.values[g];l.name=(a.nodeName||"")+".morphTargetInfluences",l.values=f,n[c.uuid]=l,t.push(l);continue}const d=o.createInterpolant(new o.ValueBufferType(1));l=n[c.uuid];for(let f=0;f<l.times.length;f++)l.values[f*h+u]=d.evaluate(l.times[f]);for(let f=0;f<o.times.length;f++){const g=this.insertKeyframe(l,o.times[f]);l.values[g*h+u]=o.values[f]}}return r.tracks=t,r}};class Wt{constructor(e){v(this,"gltfExporter",new fe);v(this,"options",{trs:!1,onlyVisible:!0,truncateDrawRange:!0,binary:!1,maxTextureSize:4096e7,animations:[]});v(this,"link");Object.assign(this.options,e),this.link=document.createElement("a"),this.link.style.display="none",document.body.appendChild(this.link)}export(e){const t=e.name?e.name:"export";this.gltfExporter.parse(e,n=>{if(n instanceof ArrayBuffer)this.saveArrayBuffer(n,t+".glb");else{const s=JSON.stringify(n,null,2);this.saveString(s,t+".gltf")}},function(n){console.log("An error happened during parsing",n)},this.options)}save(e,t){this.link.href=URL.createObjectURL(e),this.link.download=t,this.link.click()}saveString(e,t){this.save(new Blob([e],{type:"text/plain"}),t)}saveArrayBuffer(e,t){this.save(new Blob([e],{type:"application/octet-stream"}),t)}}class Kt{constructor(e,t){v(this,"container");v(this,"renderer");v(this,"gui");v(this,"stats");v(this,"currentScene");v(this,"pmremGenerator");v(this,"options");v(this,"state");v(this,"visualiseFolder");v(this,"visualCtrls",[]);v(this,"cameraFolder");v(this,"exporter",null);this.container=e,this.options=t,this.renderer=new ft({antialias:!0}),this.renderer.physicallyCorrectLights=!0,this.renderer.outputEncoding=be,this.gui=null,this.stats=Lt(),this.pmremGenerator=new dt(this.renderer),this.pmremGenerator.compileEquirectangularShader(),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.currentScene=new Ce(this.container,this.renderer),this.currentScene.sceneName="default",this.updateEnvironment(this.currentScene.vignette),this.state={playbackSpeed:1,wireframe:!1,skeleton:!1,grid:!1,addLights:!0,exposure:1,ambientIntensity:.3,ambientColor:2105376,directIntensity:.8*Math.PI,directColor:16777215,bgColor1:"#5454ad",bgColor2:"#18e5a7",exportGltf:()=>{this.exporter||(this.exporter=new Wt({animations:this.currentScene.exportContent.animations})),this.exporter.export(this.currentScene.exportContent)}},this.visualiseFolder=null,this.cameraFolder=null,this.init()}init(){var e;this.currentScene.sceneName===""&&(this.currentScene.sceneName="default"),((e=this.options)==null?void 0:e.guiOpen)&&!this.gui&&this.addGui(),[].forEach.call(this.stats.dom.children,t=>t.style.display=""),this.container.appendChild(this.renderer.domElement)}updateEnvironment(e){const t=pt.filter(n=>n.name==="Venice Sunset")[0];this.getCubeMapTexture(t).then(n=>{const s=this.getCurrentScene();n&&e&&(s==null||s.scene.add(e.mesh)),s.scene.environment=n,s.scene.background=n})}getCubeMapTexture(e){const{path:t}=e;return t?new Promise((n,s)=>{new mt().load(t,i=>{const o=this.pmremGenerator.fromEquirectangular(i).texture;this.pmremGenerator.dispose(),n(o)},void 0,s)}):Promise.resolve({envMap:null})}getCurrentScene(){return this.currentScene}hideGui(){this.gui&&this.gui.hide()}closeGui(){this.gui&&(this.gui.closed=!0)}addGui(){var o,a,c;const e=this.gui=new gt({width:260}),t=e.addFolder("Visualisation settings");t.add(this.state,"wireframe").onChange(()=>this.currentScene.updateDisplay(this.state)),this.visualiseFolder=t.addFolder("ModelVisualisation");const s=t.addColor(this.state,"bgColor1"),i=t.addColor(this.state,"bgColor2");if(s.onChange(()=>this.currentScene.updateBackground(this.state.bgColor1,this.state.bgColor2)),i.onChange(()=>this.currentScene.updateBackground(this.state.bgColor1,this.state.bgColor2)),(o=this.options)!=null&&o.camera&&(this.cameraFolder=e.addFolder("Camera")),(a=this.options)!=null&&a.performance){const h=e.addFolder("Performance"),u=document.createElement("li");this.stats.dom.style.position="static",u.appendChild(this.stats.dom),u.style.height="50px",h.__ul.appendChild(u)}if((c=this.options)!=null&&c.light){const h=e.addFolder("LightsFolder");[h.add(this.state,"addLights").listen(),h.add(this.state,"ambientIntensity",0,2),h.addColor(this.state,"ambientColor"),h.add(this.state,"directIntensity",0,4),h.addColor(this.state,"directColor")].forEach(u=>u.onChange(()=>this.currentScene.updateLights(this.state)))}e.add(this.state,"exportGltf")}updateGui(){this.visualCtrls.length!==0&&this.visualCtrls.forEach(e=>{var t;(t=this.visualiseFolder)==null||t.remove(e)}),this.visualCtrls=[],setTimeout(()=>{var n,s,i,o,a,c,h,u;let e=[];(n=this.currentScene.content)==null||n.children;const t=l=>{if(l.isMesh){const d={name:l.name||"Untitled",visible:l.visible,mesh:l};e.push(d)}};if((s=this.currentScene.content)==null||s.traverse(l=>{l.isMesh&&t(l)}),e.forEach(l=>{const d=this.visualiseFolder.add(l,"visible").name(l.name).onChange(()=>{this.currentScene.updateModelChildrenVisualisation(l.mesh)});this.visualCtrls.push(d)}),this.cameraFolder){if(this.cameraFolder.__controllers.length>0){const g=[];this.cameraFolder.__controllers.forEach(p=>{g.push(p)}),g.forEach(p=>{var m;(m=this.cameraFolder)==null||m.remove(p)})}(i=this.cameraFolder)==null||i.add(this.currentScene.camera,"near"),(o=this.cameraFolder)==null||o.add(this.currentScene.camera,"far");const l=(a=this.cameraFolder)==null?void 0:a.__folders;for(let g in l)if(Object.prototype.hasOwnProperty.call(l,g)){const p=l[g];(c=this.cameraFolder)==null||c.removeFolder(p)}const d=(h=this.cameraFolder)==null?void 0:h.addFolder("position");d.add(this.currentScene.camera.position,"x"),d.add(this.currentScene.camera.position,"y"),d.add(this.currentScene.camera.position,"z");const f=(u=this.cameraFolder)==null?void 0:u.addFolder("up");f.add(this.currentScene.camera.up,"x"),f.add(this.currentScene.camera.up,"y"),f.add(this.currentScene.camera.up,"z")}},1500)}}var C=Uint8Array,B=Uint16Array,Ge=Uint32Array,De=new C([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ze=new C([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Xt=new C([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Oe=function(r,e){for(var t=new B(31),n=0;n<31;++n)t[n]=e+=1<<r[n-1];for(var s=new Ge(t[30]),n=1;n<30;++n)for(var i=t[n];i<t[n+1];++i)s[i]=i-t[n]<<5|n;return[t,s]},Be=Oe(De,2),He=Be[0],Jt=Be[1];He[28]=258,Jt[258]=28;var qt=Oe(ze,0),Zt=qt[0],ce=new B(32768);for(var y=0;y<32768;++y){var z=(y&43690)>>>1|(y&21845)<<1;z=(z&52428)>>>2|(z&13107)<<2,z=(z&61680)>>>4|(z&3855)<<4,ce[y]=((z&65280)>>>8|(z&255)<<8)>>>1}var K=function(r,e,t){for(var n=r.length,s=0,i=new B(e);s<n;++s)r[s]&&++i[r[s]-1];var o=new B(e);for(s=0;s<e;++s)o[s]=o[s-1]+i[s-1]<<1;var a;if(t){a=new B(1<<e);var c=15-e;for(s=0;s<n;++s)if(r[s])for(var h=s<<4|r[s],u=e-r[s],l=o[r[s]-1]++<<u,d=l|(1<<u)-1;l<=d;++l)a[ce[l]>>>c]=h}else for(a=new B(n),s=0;s<n;++s)r[s]&&(a[s]=ce[o[r[s]-1]++]>>>15-r[s]);return a},q=new C(288);for(var y=0;y<144;++y)q[y]=8;for(var y=144;y<256;++y)q[y]=9;for(var y=256;y<280;++y)q[y]=7;for(var y=280;y<288;++y)q[y]=8;var Ve=new C(32);for(var y=0;y<32;++y)Ve[y]=5;var $t=K(q,9,1),Qt=K(Ve,5,1),re=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},F=function(r,e,t){var n=e/8|0;return(r[n]|r[n+1]<<8)>>(e&7)&t},oe=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},en=function(r){return(r+7)/8|0},de=function(r,e,t){(e==null||e<0)&&(e=0),(t==null||t>r.length)&&(t=r.length);var n=new(r.BYTES_PER_ELEMENT==2?B:r.BYTES_PER_ELEMENT==4?Ge:C)(t-e);return n.set(r.subarray(e,t)),n},tn=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],N=function(r,e,t){var n=new Error(e||tn[r]);if(n.code=r,Error.captureStackTrace&&Error.captureStackTrace(n,N),!t)throw n;return n},nn=function(r,e,t){var n=r.length;if(!n||t&&t.f&&!t.l)return e||new C(0);var s=!e||t,i=!t||t.i;t||(t={}),e||(e=new C(n*3));var o=function(ge){var xe=e.length;if(ge>xe){var we=new C(Math.max(xe*2,ge));we.set(e),e=we}},a=t.f||0,c=t.p||0,h=t.b||0,u=t.l,l=t.d,d=t.m,f=t.n,g=n*8;do{if(!u){a=F(r,c,1);var p=F(r,c+1,3);if(c+=3,p)if(p==1)u=$t,l=Qt,d=9,f=5;else if(p==2){var w=F(r,c,31)+257,S=F(r,c+10,15)+4,R=w+F(r,c+5,31)+1;c+=14;for(var M=new C(R),A=new C(19),I=0;I<S;++I)A[Xt[I]]=F(r,c+I*3,7);c+=S*3;for(var G=re(A),k=(1<<G)-1,V=K(A,G,1),I=0;I<R;){var O=V[F(r,c,k)];c+=O&15;var m=O>>>4;if(m<16)M[I++]=m;else{var P=0,b=0;for(m==16?(b=3+F(r,c,3),c+=2,P=M[I-1]):m==17?(b=3+F(r,c,7),c+=3):m==18&&(b=11+F(r,c,127),c+=7);b--;)M[I++]=P}}var Z=M.subarray(0,w),D=M.subarray(w);d=re(Z),f=re(D),u=K(Z,d,1),l=K(D,f,1)}else N(1);else{var m=en(c)+4,x=r[m-4]|r[m-3]<<8,E=m+x;if(E>n){i&&N(0);break}s&&o(h+x),e.set(r.subarray(m,E),h),t.b=h+=x,t.p=c=E*8,t.f=a;continue}if(c>g){i&&N(0);break}}s&&o(h+131072);for(var We=(1<<d)-1,Ke=(1<<f)-1,te=c;;te=c){var P=u[oe(r,c)&We],H=P>>>4;if(c+=P&15,c>g){i&&N(0);break}if(P||N(2),H<256)e[h++]=H;else if(H==256){te=c,u=null;break}else{var pe=H-254;if(H>264){var I=H-257,j=De[I];pe=F(r,c,(1<<j)-1)+He[I],c+=j}var ne=l[oe(r,c)&Ke],se=ne>>>4;ne||N(3),c+=ne&15;var D=Zt[se];if(se>3){var j=ze[se];D+=oe(r,c)&(1<<j)-1,c+=j}if(c>g){i&&N(0);break}s&&o(h+131072);for(var me=h+pe;h<me;h+=4)e[h]=e[h-D],e[h+1]=e[h+1-D],e[h+2]=e[h+2-D],e[h+3]=e[h+3-D];h=me}}t.l=u,t.p=te,t.b=h,t.f=a,u&&(a=1,t.m=d,t.d=l,t.n=f)}while(!a);return h==e.length?e:de(e,0,h)},sn=new C(0),U=function(r,e){return r[e]|r[e+1]<<8},_=function(r,e){return(r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24)>>>0},ae=function(r,e){return _(r,e)+_(r,e+4)*4294967296};function rn(r,e){return nn(r,e)}var le=typeof TextDecoder<"u"&&new TextDecoder,on=0;try{le.decode(sn,{stream:!0}),on=1}catch{}var an=function(r){for(var e="",t=0;;){var n=r[t++],s=(n>127)+(n>223)+(n>239);if(t+s>r.length)return[e,de(r,t-1)];s?s==3?(n=((n&15)<<18|(r[t++]&63)<<12|(r[t++]&63)<<6|r[t++]&63)-65536,e+=String.fromCharCode(55296|n>>10,56320|n&1023)):s&1?e+=String.fromCharCode((n&31)<<6|r[t++]&63):e+=String.fromCharCode((n&15)<<12|(r[t++]&63)<<6|r[t++]&63):e+=String.fromCharCode(n)}};function cn(r,e){if(e){for(var t="",n=0;n<r.length;n+=16384)t+=String.fromCharCode.apply(null,r.subarray(n,n+16384));return t}else{if(le)return le.decode(r);var s=an(r),i=s[0],o=s[1];return o.length&&N(8),i}}var ln=function(r,e){return e+30+U(r,e+26)+U(r,e+28)},hn=function(r,e,t){var n=U(r,e+28),s=cn(r.subarray(e+46,e+46+n),!(U(r,e+8)&2048)),i=e+46+n,o=_(r,e+20),a=t&&o==4294967295?un(r,i):[o,_(r,e+24),_(r,e+42)],c=a[0],h=a[1],u=a[2];return[U(r,e+10),c,h,s,i+U(r,e+30)+U(r,e+32),u]},un=function(r,e){for(;U(r,e)!=1;e+=4+U(r,e+2));return[ae(r,e+12),ae(r,e+4),ae(r,e+20)]};function fn(r,e){for(var t={},n=r.length-22;_(r,n)!=101010256;--n)(!n||r.length-n>65558)&&N(13);var s=U(r,n+8);if(!s)return{};var i=_(r,n+16),o=i==4294967295;o&&(n=_(r,n-12),_(r,n)!=101075792&&N(13),s=_(r,n+32),i=_(r,n+48));for(var a=e&&e.filter,c=0;c<s;++c){var h=hn(r,i,o),u=h[0],l=h[1],d=h[2],f=h[3],g=h[4],p=h[5],m=ln(r,p);i=g,(!a||a({name:f,size:l,originalSize:d,compression:u}))&&(u?u==8?t[f]=rn(r.subarray(m,m+l),new C(d)):N(14,"unknown compression type "+u):t[f]=de(r,m,m+l))}return t}const je=`#define GLSLIFY 1
uniform vec2 size;out vec2 vUv;void main(){gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);vUv.xy=position.xy/size+0.5;vUv.y=1.0-vUv.y;}`,Ye=`precision highp float;precision highp int;precision highp sampler2DArray;
#define GLSLIFY 1
uniform sampler2DArray diffuse;in vec2 vUv;uniform int depth;out vec4 outColor;void main(){vec4 color=texture(diffuse,vec3(vUv,depth));outColor=vec4(color.rrr*1.5,1.0);}`;let X=80,J=80;function dn(r,e){new xt().setResponseType("arraybuffer").load(r,function(t){const n=fn(new Uint8Array(t)),s=new Uint8Array(n.head256x256x109.buffer),i=new Le(s,256,256,109);i.format=Ne,i.needsUpdate=!0;const o=new Fe({uniforms:{diffuse:{value:i},depth:{value:1},size:{value:new _e(X,J)}},vertexShader:je,fragmentShader:Ye,glslVersion:Ue,side:he}),a=new ke(X,J),c=new ue(a,o);c.name="texture2d_mesh_zip",e.add(c)})}function Ie(r,e,t,n){X=r.width/2,J=r.height/2;const s={windowWidth:r.windowWidth,windowCenter:r.windowCenter},i=new Le(r.uint8,r.width,r.height,e);i.format=Ne,i.needsUpdate=!0,n&&(n.add(s,"windowWidth").min(1).max(r.windowWidth*2).step(1).onChange(()=>{h()}),n.add(s,"windowCenter").min(1).max(r.windowCenter*2).step(1).onChange(()=>{h()}));const o=new Fe({uniforms:{diffuse:{value:i},depth:{value:1},size:{value:new _e(X,J)}},vertexShader:je,fragmentShader:Ye,glslVersion:Ue,side:he}),a=new ke(X,J),c=new ue(a,o);t.add(c),c.name="texture2d_mesh_array";function h(){let u,l=wt(r.uint16,s.windowWidth,s.windowCenter,r.invert,u);for(let d=0,f=r.uint16.length;d<f;d++)r.uint8[d]=l.lutArray[r.uint16[d]];i.needsUpdate=!0}}class pn extends Ce{constructor(t,n){super(t,n);v(this,"controls");v(this,"clock",new vt);v(this,"mixer",null);v(this,"playRate",1);v(this,"modelReady",!1);v(this,"clipAction");v(this,"pickableObjects",[]);v(this,"depthStep",.4);v(this,"texture2dMesh",null);v(this,"preRenderCallbackFunctions");v(this,"sort",!0);this.controls=new Tt(this.camera,this.renderer.domElement),this.preRenderCallbackFunctions={index:0,cache:{},add(s){if(!s.id){s.id=++this.index,this.cache[s.id]=s;return}}},window.addEventListener("resize",this.onWindowResize,!1)}setDepth(t){this.depthStep=t}setDicomFilesOrder(t){t==="ascending"?this.sort=!0:t==="descending"&&(this.sort=!1)}loadGltf(t,n){yt(this.renderer).load(t,i=>{const o=new Et().setFromObject(i.scene),a=o.getSize(new Q).length(),c=o.getCenter(new Q);this.controls.maxDistance=a*10,i.scene.position.x+=i.scene.position.x-c.x,i.scene.position.y+=i.scene.position.y-c.y,i.scene.position.z+=i.scene.position.z-c.z,this.cameraPositionFlag||(this.camera.position.copy(c),this.camera.position.x+=a/2,this.camera.position.y+=a/5,this.camera.position.z+=a/2,this.camera.lookAt(c),this.viewPoint=this.setViewPoint(this.camera,[c.x,c.y,c.z])),this.mixer=new Te(i.scene),i.animations.forEach((h,u)=>{var l,d;u===0?this.clipAction=(l=this.mixer)==null?void 0:l.clipAction(h).play():(d=this.mixer)==null||d.clipAction(h).play()}),this.content=i.scene,this.exportContent.copy(i.scene),this.exportContent.animations=i.animations,this.scene.add(i.scene),this.modelReady=!0,n&&n(i.scene)},i=>{})}loadNrrd(t,n,s,i){Mt(t,n,s,i)}loadVtk(t){St(t,this.scene,this.content)}loadVtks(t){let n=0;const{vtkLoader:s,vtkmaterial:i}=Ct(),o=new At,a=setInterval(()=>{n===t.length&&(this.scene.add(this.exportContent),this.mixer=new Te(o),this.exportContent.animations.forEach(h=>{var l;const u=(l=this.mixer)==null?void 0:l.clipAction(h);u.timeScale=3,u.play()}),this.modelReady=!0,clearInterval(a))},100);t.forEach(h=>{const u=[];h.urls.forEach(l=>{s.load(l,d=>{d.center(),d.computeVertexNormals(),u.push(d),u.length===h.urls.length&&(c(u,h),n+=1)})})});const c=(h,u)=>{let l=h[0];h.forEach((x,E)=>{E===0?(l=x,l.morphAttributes.position=[]):l.morphAttributes.position.push(x.attributes.position)});const d=new ue(l,i);d.scale.multiplyScalar(.1),o.add(d),this.exportContent.add(o),d.morphTargetInfluences=[],d.name=u.name;let f=0,g=[],p=h.length-1;for(let x=0;x<p;x++){const E=new Rt(`${d.name}.morphTargetInfluences[${x}]`,[f,f+1,f+2],[0,1,0]);g.push(E),f=f+2}const m=new It(`copper3d_heart_morph_${d.name}`,p,g);this.exportContent.animations.push(m)}}pickModel(t,n,s){t.traverse(i=>{if(i.isMesh){const o=i;s&&s.includes(o.name)||this.pickableObjects.push(o)}}),bt(this.camera,this.container,this.pickableObjects,n)}loadDicom(t,n){let s;if(n&&(s=n.gui),Array.isArray(t)){const i=t.length,o=[];let a=[],c=[];t.forEach(u=>{ye(u,l=>{if(o.push(l),o.length===i){o.sort((m,x)=>this.sort?m.order-x.order:x.order-m.order),o.forEach(m=>{a.push(m.uint8),c.push(m.uint16)});const d=new Uint8ClampedArray(l.width*l.height*i),f=new Uint16Array(d.length);let g=0,p=0;a.forEach((m,x)=>{g=x*l.width*l.height;for(let E=0;E<m.length;E++)d[E+g]=m[E]}),c.forEach((m,x)=>{p=x*l.width*l.height;for(let E=0;E<m.length;E++)f[E+p]=m[E]}),l.uint8=d,l.uint16=f,h(l)}})});const h=u=>{s&&s.add(this,"depthStep").min(.01).max(1).step(.01),Ie(u,i,this.scene,s);const l=setInterval(()=>{var d;this.scene.children.forEach(f=>{if(f.isMesh&&f.name==="texture2d_mesh_array"){this.texture2dMesh=f;const g=()=>{if(this.texture2dMesh){let p=this.texture2dMesh.material.uniforms.depth.value;n!=null&&n.setAnimation?p=n.setAnimation(p,i,this.depthStep):(p+=this.depthStep,(p>i||p<0)&&(p>1&&(p=i*2-p),p<0&&(p=-p),this.depthStep=-this.depthStep)),this.texture2dMesh.material.uniforms.depth.value=p}};this.addPreRenderCallbackFunction(g)}}),((d=this.texture2dMesh)==null?void 0:d.name)==="texture2d_mesh_array"&&(n!=null&&n.getMesh&&n.getMesh(this.texture2dMesh),clearInterval(l))},500)}}else ye(t,o=>{Ie(o,1,this.scene)})}texture2d(t){dn(t,this.scene);const n=setInterval(()=>{var s;this.scene.children.forEach(i=>{if(i.isMesh&&i.name==="texture2d_mesh_zip"){this.texture2dMesh=i;const o=()=>{if(this.texture2dMesh){let a=this.texture2dMesh.material.uniforms.depth.value;a+=this.depthStep,(a>109||a<0)&&(a>1&&(a=109*2-a),a<0&&(a=-a),this.depthStep=-this.depthStep),this.texture2dMesh.material.uniforms.depth.value=a}};this.addPreRenderCallbackFunction(o)}}),((s=this.texture2dMesh)==null?void 0:s.name)==="texture2d_mesh_zip"&&clearInterval(n)},500)}getPlayRate(){return this.playRate}setPlayRate(t){this.playRate=t}setModelPosition(t,n){n.x&&(t.position.x=n.x),n.y&&(t.position.y=n.y),n.z&&(t.position.z=n.z)}resetView(){this.controls.reset(),this.updateCamera(this.viewPoint)}updateCamera(t){this.cameraPositionFlag=!0,this.copperControl.updateCameraViewPoint(t)}getCurrentTime(){let t=0;return this.clipAction&&(t=this.clipAction.time/this.clipAction._clip.duration),t}getCurrentMixer(){return this.mixer}addPreRenderCallbackFunction(t){return this.preRenderCallbackFunctions.add(t),this.preRenderCallbackFunctions.index}render(){this.controls.update(),this.modelReady&&this.mixer&&this.mixer.update(this.clock.getDelta()*this.playRate),Object.values(this.preRenderCallbackFunctions.cache).forEach(t=>{t&&t.call(null)}),this.renderer.render(this.scene,this.camera)}}class xn extends Kt{constructor(t,n){super(t,n);v(this,"sceneMap",{});v(this,"animate",()=>{this.render(),this.stats.update(),requestAnimationFrame(this.animate)})}getSceneByName(t){return this.sceneMap[t]}setCurrentScene(t){var n;t&&(this.currentScene=t,(n=this.options)!=null&&n.guiOpen&&this.updateGui(),this.onWindowResize())}createScene(t){if(this.sceneMap[t]==null){const n=new pn(this.container,this.renderer);return n.sceneName=t,this.updateEnvironment(n.vignette),this.sceneMap[t]=n,n}}onWindowResize(){}render(){this.currentScene.render()}}export{xn as c};
